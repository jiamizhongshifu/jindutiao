# ä»»åŠ¡ç¡®è®¤å´©æºƒä¿®å¤æŠ¥å‘Š v1.6.9

**ä¿®å¤æ—¶é—´**: 2025-12-02
**é—®é¢˜ä¸¥é‡çº§åˆ«**: ğŸ”´ ä¸¥é‡ - å¯¼è‡´åº”ç”¨å´©æºƒ

---

## ğŸ“Œ é—®é¢˜æè¿°

ç”¨æˆ·åœ¨"ç»Ÿè®¡æŠ¥å‘Š"çª—å£ç‚¹å‡»"æ‰‹åŠ¨ç”Ÿæˆæ¨ç†"å,æˆåŠŸæ˜¾ç¤ºä»»åŠ¡ç¡®è®¤çª—å£,ä½†ç‚¹å‡»"å…¨éƒ¨ç¡®è®¤"æŒ‰é’®ååº”ç”¨ç«‹å³å´©æºƒé€€å‡ºã€‚

### å´©æºƒæ—¥å¿—
```
QBackingStore::endPaint() called with active painter; did you forget to destroy it or call QPainter::end() on it?
```

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

ç»è¿‡æ·±å…¥åˆ†æ,å‘ç°äº†**ä¸¤ä¸ªå…³é”®Bug**:

### Bug #1: TaskReviewWindow å‚æ•°ä¼ é€’é”™è¯¯

**ä½ç½®**: `statistics_gui.py:993`

**é”™è¯¯ä»£ç **:
```python
review_window = TaskReviewWindow(today, unconfirmed_tasks, self)
```

**é—®é¢˜åˆ†æ**:
- TaskReviewWindow æ„é€ å‡½æ•°ç­¾å:
  ```python
  def __init__(self, date: str, task_completions: List[Dict],
               on_confirm: Optional[Callable] = None,
               parent=None):
  ```
- ä¼ å…¥çš„ `self` (StatisticsWindowå®ä¾‹) è¢«é”™è¯¯åœ°ä¼ ç»™äº† `on_confirm` å‚æ•°
- `parent` å‚æ•°ä¿æŒä¸º `None`
- å¯¼è‡´ `on_confirm_callback` è¢«è®¾ç½®ä¸º StatisticsWindow å¯¹è±¡è€Œä¸æ˜¯å›è°ƒå‡½æ•°

**åæœ**:
- ç‚¹å‡»"å…¨éƒ¨ç¡®è®¤"æ—¶,å°è¯•è°ƒç”¨ `self.on_confirm_callback(results)`
- å®é™…ä¸Šæ˜¯åœ¨å°è¯•å°† StatisticsWindow å¯¹è±¡ä½œä¸ºå‡½æ•°è°ƒç”¨
- å¯¼è‡´ç±»å‹é”™è¯¯å’Œåç»­å´©æºƒ

### Bug #2: on_review_completed å‚æ•°è§£åŒ…é”™è¯¯

**ä½ç½®**: `statistics_gui.py:1013`

**é”™è¯¯ä»£ç **:
```python
for completion_id, new_completion, note in results:
    db.confirm_task_completion(completion_id, new_completion, note)
```

**é—®é¢˜åˆ†æ**:
- TaskReviewWindow.confirm_all() å‘é€çš„æ•°æ®æ ¼å¼:
  ```python
  results = [{
      'completion_id': str,
      'new_completion': int,
      'original_completion': int,
      'is_modified': bool,
      'note': str
  }]
  ```
- ä½† `on_review_completed` å°è¯•å°†å­—å…¸è§£åŒ…ä¸ºå…ƒç»„: `(completion_id, new_completion, note)`
- è¿™ä¼šå¯¼è‡´ `ValueError: too many values to unpack` æˆ–ç±»ä¼¼é”™è¯¯

**åæœ**:
- å³ä½¿ç¬¬ä¸€ä¸ªBugè¢«ä¿®å¤,è¿™ä¸ªBugä¹Ÿä¼šå¯¼è‡´æ•°æ®å¤„ç†å¤±è´¥
- æ— æ³•æ­£ç¡®ä¿å­˜ç”¨æˆ·ç¡®è®¤çš„ä»»åŠ¡å®Œæˆåº¦

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ #1: æ­£ç¡®ä¼ é€’å‚æ•°

**æ–‡ä»¶**: `statistics_gui.py:993-1000`

**ä¿®å¤åä»£ç **:
```python
# æ‰“å¼€ä»»åŠ¡å›é¡¾çª—å£
review_window = TaskReviewWindow(
    date=today,
    task_completions=unconfirmed_tasks,
    on_confirm=None,  # ä½¿ç”¨ä¿¡å·è¿æ¥,ä¸ä½¿ç”¨å›è°ƒ
    parent=self  # æ­£ç¡®ä¼ é€’parentå‚æ•°
)
review_window.review_completed.connect(self.on_review_completed)
review_window.exec()
```

**æ”¹è¿›ç‚¹**:
1. âœ… ä½¿ç”¨å‘½åå‚æ•°,é¿å…ä½ç½®å‚æ•°æ··æ·†
2. âœ… `on_confirm=None` - ä¸ä½¿ç”¨å›è°ƒæœºåˆ¶
3. âœ… `parent=self` - æ­£ç¡®è®¾ç½®çˆ¶çª—å£
4. âœ… é€šè¿‡ä¿¡å·è¿æ¥ `review_completed.connect()` å¤„ç†ç¡®è®¤äº‹ä»¶

### ä¿®å¤ #2: æ­£ç¡®è§£åŒ…å­—å…¸æ•°æ®

**æ–‡ä»¶**: `statistics_gui.py:1010-1022`

**ä¿®å¤åä»£ç **:
```python
def on_review_completed(self, results: list):
    """ä»»åŠ¡å›é¡¾å®Œæˆå›è°ƒ

    Args:
        results: [{'completion_id': str, 'new_completion': int, 'note': str, ...}, ...]
    """
    try:
        # æ›´æ–°æ•°æ®åº“
        for result in results:
            completion_id = result['completion_id']
            new_completion = result['new_completion']
            note = result.get('note', '')
            db.confirm_task_completion(completion_id, new_completion, note)
```

**æ”¹è¿›ç‚¹**:
1. âœ… æ­£ç¡®ä»å­—å…¸ä¸­æå–æ•°æ®
2. âœ… ä½¿ç”¨ `result.get('note', '')` æä¾›é»˜è®¤å€¼
3. âœ… æ›´æ–°äº†æ–‡æ¡£å­—ç¬¦ä¸²,å‡†ç¡®æè¿°å‚æ•°æ ¼å¼

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

è¿è¡Œ `æµ‹è¯•å´©æºƒä¿®å¤.bat` è„šæœ¬:

1. âœ… å¯åŠ¨åº”ç”¨
2. âœ… å³é”®æ‰˜ç›˜å›¾æ ‡ â†’ "ç»Ÿè®¡æŠ¥å‘Š"
3. âœ… ç‚¹å‡» "ğŸ”„ æ‰‹åŠ¨ç”Ÿæˆæ¨ç†"
4. âœ… ç­‰å¾…ä»»åŠ¡ç¡®è®¤çª—å£å¼¹å‡º
5. âœ… ç‚¹å‡» "å…¨éƒ¨ç¡®è®¤"

### é¢„æœŸç»“æœ

- âœ… æˆåŠŸæ˜¾ç¤º "å·²æˆåŠŸç¡®è®¤ X ä¸ªä»»åŠ¡!" æç¤ºæ¡†
- âœ… åº”ç”¨ä¸å´©æºƒ
- âœ… ç»Ÿè®¡æŠ¥å‘Šç•Œé¢åˆ·æ–°,æ˜¾ç¤ºå·²ç¡®è®¤çš„ä»»åŠ¡
- âœ… æ•°æ®åº“æ­£ç¡®ä¿å­˜ç”¨æˆ·ç¡®è®¤çš„å®Œæˆåº¦

---

## ğŸ“Š å½±å“èŒƒå›´

### å·²ä¿®æ”¹æ–‡ä»¶

1. **statistics_gui.py**
   - è¡Œ 993-1000: TaskReviewWindow å®ä¾‹åŒ–
   - è¡Œ 1010-1022: on_review_completed æ–¹æ³•

### æœªä¿®æ”¹æ–‡ä»¶

- **main.py**: å·²ç»æ­£ç¡®ä½¿ç”¨äº†å‘½åå‚æ•°,æ— éœ€ä¿®æ”¹
- **gaiya/ui/task_review_window.py**: åŠŸèƒ½æ­£å¸¸,æ— éœ€ä¿®æ”¹

---

## ğŸ¯ å·²ä¿®å¤çš„å®Œæ•´åŠŸèƒ½é“¾

å®Œæ•´çš„"æ‰‹åŠ¨æ¨ç†â†’ç¡®è®¤â†’ä¿å­˜"æµç¨‹ç°åœ¨å·²ç»**å®Œå…¨ä¿®å¤**:

1. âœ… Scheduler åˆå§‹åŒ– (v1.6.6ä¿®å¤)
2. âœ… StatisticsWindow è®¿é—® scheduler (v1.6.7ä¿®å¤)
3. âœ… ç»Ÿè®¡çª—å£ç‹¬ç«‹æ˜¾ç¤º (v1.6.8ä¿®å¤)
4. âœ… æ—¶é—´æ ¼å¼ 24:00 â†’ 23:59 (v1.6.8ä¿®å¤)
5. âœ… ä»»åŠ¡ç¡®è®¤çª—å£å‚æ•°ä¼ é€’ (v1.6.9ä¿®å¤) â­ï¸ æœ¬æ¬¡
6. âœ… ä»»åŠ¡ç¡®è®¤æ•°æ®ä¿å­˜ (v1.6.9ä¿®å¤) â­ï¸ æœ¬æ¬¡

---

## ğŸš€ ä¸‹ä¸€æ­¥

### ç«‹å³æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
æµ‹è¯•å´©æºƒä¿®å¤.bat
```

### æ‰“åŒ…å‘å¸ƒ

ç¡®è®¤æµ‹è¯•é€šè¿‡å:
```bash
# æ¸…ç†å¹¶é‡æ–°æ‰“åŒ…
build-clean.bat
```

---

## ğŸ“ æŠ€æœ¯æ€»ç»“

### æ•™è®­

1. **ä½ç½®å‚æ•°é™·é˜±**: ä½¿ç”¨å¯é€‰å‚æ•°æ—¶,åº”è¯¥ä½¿ç”¨å‘½åå‚æ•°è€Œä¸æ˜¯ä½ç½®å‚æ•°
2. **æ•°æ®æ ¼å¼ä¸€è‡´æ€§**: ä¿¡å·/å›è°ƒçš„å‘é€ç«¯å’Œæ¥æ”¶ç«¯å¿…é¡»çº¦å®šç›¸åŒçš„æ•°æ®æ ¼å¼
3. **ç±»å‹æç¤ºé‡è¦æ€§**: å¦‚æœæœ‰å®Œæ•´çš„ç±»å‹æç¤º,è¿™ç±»é”™è¯¯å¯ä»¥åœ¨IDEä¸­è¢«æå‰å‘ç°

### æœ€ä½³å®è·µ

1. âœ… **ä½¿ç”¨å‘½åå‚æ•°**: ç‰¹åˆ«æ˜¯å½“æœ‰å¤šä¸ªå¯é€‰å‚æ•°æ—¶
   ```python
   # Good
   TaskReviewWindow(
       date=today,
       task_completions=tasks,
       on_confirm=callback,
       parent=self
   )

   # Bad - å®¹æ˜“å‡ºé”™
   TaskReviewWindow(today, tasks, self)  # selfè¢«é”™è¯¯ä¼ ç»™on_confirm!
   ```

2. âœ… **æ–‡æ¡£å­—ç¬¦ä¸²ç²¾ç¡®**: å‡†ç¡®æè¿°å‚æ•°å’Œè¿”å›å€¼çš„æ•°æ®ç»“æ„
   ```python
   Args:
       results: [{'key1': type1, 'key2': type2}, ...]  # ç²¾ç¡®æè¿°å­—å…¸ç»“æ„
   ```

3. âœ… **é˜²å¾¡æ€§ç¼–ç¨‹**: ä½¿ç”¨ `.get()` æä¾›é»˜è®¤å€¼
   ```python
   note = result.get('note', '')  # å¦‚æœkeyä¸å­˜åœ¨,è¿”å›ç©ºå­—ç¬¦ä¸²
   ```

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-12-02
**ç‰ˆæœ¬**: v1.6.9
**çŠ¶æ€**: âœ… å¾…æµ‹è¯•éªŒè¯
