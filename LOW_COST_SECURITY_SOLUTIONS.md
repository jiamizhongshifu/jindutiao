# 低成本API密钥安全方案

## 需求分析

**约束条件：**
1. ✅ 所有用户统一使用我们提供的API服务（不能使用自己的密钥）
2. ✅ 方便后续付费转化
3. ✅ 不想投入服务器成本（用户规模未形成）
4. ✅ 密钥不能被反编译提取

## 方案对比

### 方案1：短期密钥在线获取（推荐）✅

**核心思路：**
- 首次启动时从我们的服务器获取短期密钥（7-30天有效）
- 密钥存储在本地加密存储
- 过期后自动重新获取

**优点：**
- ✅ 密钥不长期存储在客户端
- ✅ 即使被提取，很快会过期
- ✅ 服务器成本极低（只需要一个API端点）
- ✅ 可以追踪使用情况
- ✅ 可以禁用恶意用户

**服务器要求：**
- 只需要一个简单的API端点（可以部署在免费/低成本平台）
- 如：Vercel、Netlify、Railway（免费额度）
- 或：GitHub Pages + Cloudflare Workers（免费）

**成本：** $0-5/月（甚至可能免费）

**实施复杂度：** ⭐⭐⭐ (中等)

---

### 方案2：代码混淆 + 加密存储（临时方案）⚠️

**核心思路：**
- 密钥使用加密算法加密后存储
- 使用代码混淆工具增加提取难度
- 使用系统密钥存储（Windows DPAPI）

**优点：**
- ✅ 无需服务器
- ✅ 实施简单
- ✅ 增加提取难度

**缺点：**
- ❌ 仍可能被提取（安全级别低）
- ❌ 密钥一旦泄露无法撤销
- ❌ 无法控制使用量

**成本：** $0

**实施复杂度：** ⭐⭐ (简单)

**适用场景：** 仅用于MVP阶段，不适合长期使用

---

### 方案3：免费托管平台部署（最低成本）✅

**核心思路：**
- 使用免费/低成本的云平台部署代理服务器
- 如：Railway、Render、Fly.io（都有免费额度）
- 或：Cloudflare Workers（免费，但有请求限制）

**优点：**
- ✅ 密钥完全安全
- ✅ 可以控制使用量
- ✅ 成本极低或免费
- ✅ 可以追踪使用情况

**缺点：**
- ⚠️ 免费额度有限制（但通常足够初期使用）
- ⚠️ 需要维护服务器代码

**成本：** $0-5/月（免费额度通常足够）

**实施复杂度：** ⭐⭐⭐ (中等)

**推荐平台：**
- **Railway**: 免费$5额度/月，非常容易部署
- **Render**: 免费层可用，但会休眠
- **Fly.io**: 免费额度，性能好
- **Cloudflare Workers**: 免费，但适合简单代理

---

### 方案4：混合方案（推荐用于当前阶段）✅

**核心思路：**
- 使用免费托管平台部署代理服务器
- 客户端默认使用代理服务器
- 未来用户量增长后再迁移到付费服务器

**优点：**
- ✅ 密钥完全安全
- ✅ 成本极低（免费额度）
- ✅ 可以控制使用量
- ✅ 可以追踪使用情况
- ✅ 可以逐步演进

**成本：** $0（使用免费额度）

**实施复杂度：** ⭐⭐⭐ (中等)

---

## 推荐方案：免费托管平台 + 代理服务器

### 为什么选择这个方案？

1. **成本：** $0（使用免费额度，足够初期使用）
2. **安全：** 密钥完全不在客户端
3. **可控：** 可以控制使用量、追踪用户
4. **可扩展：** 未来可以轻松迁移到付费服务器

### 实施步骤

#### 阶段1：使用免费平台（当前）

1. **选择平台：** Railway（推荐）或 Render
2. **部署代理服务器：** 简单Flask应用
3. **客户端修改：** 默认使用代理服务器

#### 阶段2：用户量增长后

1. **迁移到付费服务器：** 当免费额度不够时
2. **添加认证系统：** 用户注册、付费转化
3. **添加监控：** 使用情况追踪

---

## 具体实现方案

### 方案A：Railway部署（推荐）

**优点：**
- 免费$5额度/月（足够初期使用）
- 部署非常简单
- 自动HTTPS
- 可以绑定自定义域名

**成本：** $0（初期）

**实施步骤：**
1. 注册Railway账号（免费）
2. 创建Flask代理服务器
3. 一键部署
4. 获得HTTPS URL

**代码示例：**
```python
# proxy_server.py (Railway部署)
from flask import Flask, request, jsonify
from flask_cors import CORS
import requests
import os

app = Flask(__name__)
CORS(app)

TUZI_API_KEY = os.getenv("TUZI_API_KEY")  # Railway环境变量
TUZI_BASE_URL = "https://api.tu-zi.com/v1"

@app.route('/api/plan-tasks', methods=['POST'])
def proxy_plan_tasks():
    # 转发请求...
    pass

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=os.getenv('PORT', 5000))
```

**部署：**
```bash
# Railway CLI
railway login
railway init
railway up
```

---

### 方案B：Cloudflare Workers（免费，但有限制）

**优点：**
- 完全免费
- 全球CDN加速
- 自动HTTPS

**缺点：**
- 请求限制：100,000次/天（通常足够）
- 执行时间限制：10秒（对于AI请求可能不够）

**适用场景：** 适合简单的代理，不适合长时间AI请求

---

### 方案C：短期密钥方案（如果不想用服务器）

**核心思路：**
- 密钥定期过期（7-30天）
- 过期后从服务器获取新密钥
- 即使被提取，很快会过期

**实施：**
1. 部署一个简单的密钥分发API（可以用免费平台）
2. 首次启动时获取密钥
3. 密钥过期后自动重新获取

**优点：**
- ✅ 服务器成本极低（只需要一个API端点）
- ✅ 密钥不长期存储
- ✅ 可以禁用恶意用户

**缺点：**
- ⚠️ 首次启动需要网络连接
- ⚠️ 密钥仍可能被提取（但很快过期）

---

## 成本对比

| 方案 | 初期成本 | 用户量增长后 | 推荐度 |
|------|---------|------------|--------|
| Railway免费额度 | $0 | $5-10/月 | ⭐⭐⭐⭐⭐ |
| Render免费层 | $0 | $7-15/月 | ⭐⭐⭐⭐ |
| Cloudflare Workers | $0 | $0（限制内） | ⭐⭐⭐ |
| 短期密钥方案 | $0-5/月 | $5-10/月 | ⭐⭐⭐⭐ |
| 代码混淆 | $0 | $0（不安全） | ⭐⭐ |

---

## 最终推荐

### 推荐方案：Railway免费额度 + 代理服务器

**理由：**
1. ✅ **成本：** $0（免费$5额度足够初期使用）
2. ✅ **安全：** 密钥完全不在客户端
3. ✅ **实施：** 部署简单，几分钟完成
4. ✅ **可扩展：** 未来可以轻松升级到付费计划
5. ✅ **可控：** 可以控制使用量、追踪用户

**实施步骤：**
1. 创建Flask代理服务器（约100行代码）
2. 部署到Railway（免费）
3. 修改客户端使用代理服务器
4. 完成！

**当用户量增长后：**
- Railway自动升级到付费计划（$5/月起）
- 或迁移到其他云平台
- 添加用户认证和付费转化

---

## 总结

**最佳方案：Railway免费额度 + 代理服务器**

- ✅ 密钥完全安全
- ✅ 成本 $0（初期）
- ✅ 实施简单
- ✅ 可以控制使用量
- ✅ 方便后续付费转化

这样既解决了安全问题，又不会增加成本负担！

