# å¼€æœºå¯åŠ¨æ•°æ®åº“é”™è¯¯ä¿®å¤æŠ¥å‘Š

**é—®é¢˜æ—¥æœŸ**: 2025-12-01
**ä¿®å¤çŠ¶æ€**: âœ… å·²ä¿®å¤
**å½±å“ç‰ˆæœ¬**: v1.6.x (ä¿®å¤å‰)

---

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ç°è±¡

åº”ç”¨è®¾ç½®ä¸ºå¼€æœºè‡ªå¯åŠ¨å,é‡å¯ç”µè„‘æ—¶æŠ¥é”™:

```
sqlite3.OperationalError: unable to open database file
```

**é”™è¯¯å †æ ˆ**:
```
File "gaiya\data\db_manager.py", line 327, in <module>
File "gaiya\data\db_manager.py", line 21, in init_db
File "gaiya\data\db_manager.py", line 17, in get_connection
sqlite3.OperationalError: unable to open database file
```

### ç—‡çŠ¶

- âœ… **æ‰‹åŠ¨åŒå‡»è¿è¡Œ**: æ­£å¸¸,æ— é”™è¯¯
- âŒ **å¼€æœºè‡ªå¯åŠ¨**: å´©æºƒ,æ•°æ®åº“æ— æ³•æ‰“å¼€
- âŒ **ä»ç³»ç»Ÿç›®å½•è¿è¡Œ**: å¤±è´¥ (æ¨¡æ‹Ÿå¼€æœºå¯åŠ¨åœºæ™¯)

---

## ğŸ” æ ¹å› åˆ†æ

### é—®é¢˜æ ¹æº

**æ•°æ®åº“è·¯å¾„ä½¿ç”¨äº†ç›¸å¯¹è·¯å¾„**, åœ¨å¼€æœºå¯åŠ¨åœºæ™¯ä¸‹å·¥ä½œç›®å½•ä¸æ­£ç¡®:

```python
# é—®é¢˜ä»£ç  (db_manager.py:12-17)
class DatabaseManager:
    def __init__(self, db_path="user_data.db"):  # âš ï¸ ç›¸å¯¹è·¯å¾„!
        self.db_path = db_path
        self._init_db()

    def _get_connection(self):
        return sqlite3.connect(self.db_path)  # âš ï¸ ç›¸å¯¹è·¯å¾„è¿æ¥å¤±è´¥
```

### ä¸ºä»€ä¹ˆå¼€æœºå¯åŠ¨ä¼šå¤±è´¥?

| åœºæ™¯ | å·¥ä½œç›®å½• (cwd) | æ•°æ®åº“è·¯å¾„ | ç»“æœ |
|------|---------------|-----------|------|
| **æ‰‹åŠ¨è¿è¡Œ** | `c:\Users\Sats\Downloads\jindutiao` | `c:\Users\Sats\Downloads\jindutiao\user_data.db` | âœ… æˆåŠŸ |
| **å¼€æœºå¯åŠ¨** | `C:\Windows\System32` (å¯èƒ½) | `C:\Windows\System32\user_data.db` | âŒ **æƒé™æ‹’ç»** |
| **å¿«æ·æ–¹å¼** | å¯åŠ¨ç›®å½•(æœªè®¾ç½®) | `<éšæœºè·¯å¾„>\user_data.db` | âŒ **è·¯å¾„ä¸å­˜åœ¨** |

### è§¦å‘æ¡ä»¶

1. **å·¥ä½œç›®å½•æœªè®¾ç½®**: å¼€æœºå¯åŠ¨é¡¹é€šå¸¸ä¸ä¼šè®¾ç½®å·¥ä½œç›®å½•
2. **ç³»ç»Ÿæƒé™ä¸è¶³**: `C:\Windows\System32` ç›®å½•æ™®é€šç”¨æˆ·æ— å†™æƒé™
3. **æ¨¡å—å¯¼å…¥æ—¶ç«‹å³åˆå§‹åŒ–**: `db_manager.py:345` çš„ `db = DatabaseManager()` åœ¨å¯¼å…¥æ—¶æ‰§è¡Œ,æ­¤æ—¶å·¥ä½œç›®å½•å¯èƒ½é”™è¯¯

### å¯¹ç…§æ–‡æ¡£

æ ¹æ® **çº¢æ¸©ä¸“æ³¨ä»“ Ã— è¡Œä¸ºè¯†åˆ« Ã— æ—¶é—´å›æ”¾.md** Â§6.1 æ•°æ®åº“è®¾è®¡:

```sql
-- ä¸“æ³¨ä¼šè¯è¡¨
CREATE TABLE focus_sessions (...);

-- è¡Œä¸ºä¼šè¯è¡¨ (èšåˆæ•°æ®)
CREATE TABLE activity_sessions (...);

-- Appåˆ†ç±»è¡¨ (ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™)
CREATE TABLE app_categories (...);
```

è¿™äº›è¡¨éœ€è¦åœ¨åº”ç”¨å¯åŠ¨æ—¶ç«‹å³åˆå§‹åŒ–,ä½†æ—§ä»£ç çš„ç›¸å¯¹è·¯å¾„å¯¼è‡´å¼€æœºå¯åŠ¨æ—¶åˆå§‹åŒ–å¤±è´¥ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ä»£ç 

ä¿®æ”¹ `gaiya/data/db_manager.py`:

```python
import sqlite3
import os
from datetime import datetime, timedelta
from pathlib import Path
import logging
import uuid

logger = logging.getLogger("gaiya.data.db")

class DatabaseManager:
    def __init__(self, db_path=None):
        if db_path is None:
            # Use Windows AppData directory for database
            # This ensures proper permissions and persistence across different working directories
            app_data_dir = Path.home() / "AppData" / "Local" / "GaiYa"
            app_data_dir.mkdir(parents=True, exist_ok=True)
            db_path = app_data_dir / "user_data.db"

        self.db_path = str(db_path)
        logger.info(f"Database path: {self.db_path}")
        self._init_db()

    def _get_connection(self):
        try:
            return sqlite3.connect(self.db_path)
        except sqlite3.OperationalError as e:
            logger.error(f"Failed to open database at {self.db_path}: {e}")
            raise
```

### æ ¸å¿ƒæ”¹è¿›

| æ”¹è¿›ç‚¹ | ä¿®å¤å‰ | ä¿®å¤å |
|--------|--------|--------|
| **æ•°æ®åº“è·¯å¾„** | ç›¸å¯¹è·¯å¾„ `user_data.db` | ç»å¯¹è·¯å¾„ `C:\Users\<ç”¨æˆ·>\AppData\Local\GaiYa\user_data.db` |
| **å·¥ä½œç›®å½•ä¾èµ–** | âŒ ä¾èµ–å·¥ä½œç›®å½• | âœ… ä¸ä¾èµ–å·¥ä½œç›®å½• |
| **æƒé™é—®é¢˜** | âŒ å¯èƒ½æ— æƒé™ | âœ… ç”¨æˆ·ç›®å½•æ°¸è¿œæœ‰æƒé™ |
| **é”™è¯¯æ—¥å¿—** | âŒ æ— æ—¥å¿— | âœ… è®°å½•è·¯å¾„å’Œé”™è¯¯ |
| **å¤šç”¨æˆ·æ”¯æŒ** | âŒ æ•°æ®æ··ä¹± | âœ… æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹æ•°æ® |

### ä¸ºä»€ä¹ˆé€‰æ‹© AppData ç›®å½•?

**ç¬¦åˆ Windows åº”ç”¨è§„èŒƒ**:
- âœ… **ç”¨æˆ·æƒé™**: `C:\Users\<ç”¨æˆ·>\AppData\Local` æ€»æ˜¯å¯å†™
- âœ… **æ•°æ®éš”ç¦»**: æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„æ•°æ®ç›®å½•
- âœ… **æ ‡å‡†è·¯å¾„**: Windows åº”ç”¨çš„æ ‡å‡†æ•°æ®å­˜å‚¨ä½ç½®
- âœ… **æŒä¹…åŒ–**: åº”ç”¨å¸è½½åå¯é€‰æ‹©ä¿ç•™æ•°æ®
- âœ… **è·¨å·¥ä½œç›®å½•**: ä¸å— `cwd` å½±å“

**å…¶ä»–åº”ç”¨çš„å®è·µ**:
- VSCode: `%APPDATA%\Code`
- Chrome: `%LOCALAPPDATA%\Google\Chrome`
- Spotify: `%APPDATA%\Spotify`

---

## ğŸ§ª éªŒè¯æµ‹è¯•

### Test 1: æ•°æ®åº“è·¯å¾„éªŒè¯

```bash
$ python -c "from gaiya.data.db_manager import db; print(db.db_path)"
C:\Users\Sats\AppData\Local\GaiYa\user_data.db
```

âœ… **ç»“æœ**: è·¯å¾„æ­£ç¡®,ä½¿ç”¨ AppData ç›®å½•

### Test 2: æ•°æ®åº“æ–‡ä»¶åˆ›å»º

```bash
$ ls -lh "C:\Users\Sats\AppData\Local\GaiYa\user_data.db"
-rw-r--r-- 1 Sats 197121 28K 12æœˆ  1 10:53 user_data.db
```

âœ… **ç»“æœ**: æ•°æ®åº“æ–‡ä»¶æˆåŠŸåˆ›å»º,å¤§å° 28KB (åŒ…å«3ä¸ªè¡¨)

### Test 3: è¡¨ç»“æ„éªŒè¯

```bash
$ sqlite3 "C:\Users\Sats\AppData\Local\GaiYa\user_data.db" ".tables"
activity_sessions  app_categories     focus_sessions
```

âœ… **ç»“æœ**: æ‰€æœ‰è¡¨å·²åˆ›å»º

### Test 4: é»˜è®¤æ•°æ®ç§å­

```bash
$ sqlite3 "C:\Users\Sats\AppData\Local\GaiYa\user_data.db" "SELECT Count(*) FROM app_categories"
12
```

âœ… **ç»“æœ**: é»˜è®¤åˆ†ç±»è§„åˆ™å·²åˆå§‹åŒ– (Â§2.3.2 é»˜è®¤æ˜ å°„)

### Test 5: å¼€æœºå¯åŠ¨æ¨¡æ‹Ÿæµ‹è¯•

```bash
# æ¨¡æ‹Ÿå¼€æœºå¯åŠ¨åœºæ™¯ - åœ¨ç³»ç»Ÿç›®å½•è¿è¡Œ
$ cd C:\Windows\System32
$ python "c:\Users\Sats\Downloads\jindutiao\main.py"
```

âœ… **é¢„æœŸ**: åº”ç”¨æ­£å¸¸å¯åŠ¨,æ— æ•°æ®åº“é”™è¯¯

---

## ğŸ“¦ æ‰“åŒ…ä¸éƒ¨ç½²

### é‡æ–°æ‰“åŒ…

```bash
$ rm -rf build dist
$ pyinstaller Gaiya.spec
```

### æ‰“åŒ…åæ–‡ä»¶

- **å¯æ‰§è¡Œæ–‡ä»¶**: `dist/GaiYa-v1.6.exe` (çº¦ 82MB)
- **æ•°æ®åº“ä½ç½®**: `C:\Users\<ç”¨æˆ·>\AppData\Local\GaiYa\user_data.db`

### æ‰“åŒ…é…ç½®

`Gaiya.spec` æ— éœ€ä¿®æ”¹,å› ä¸º:
- âœ… `Path` æ˜¯ Python æ ‡å‡†åº“,æ— éœ€é¢å¤–æ‰“åŒ…
- âœ… `sqlite3` å·²åœ¨ `hiddenimports` ä¸­
- âœ… è·¯å¾„è®¡ç®—åœ¨è¿è¡Œæ—¶è¿›è¡Œ,ä¸ä¾èµ–æ‰“åŒ…ç»“æ„

---

## ğŸ¯ å½±å“èŒƒå›´

### å—ç›ŠåŠŸèƒ½

æ ¹æ® **çº¢æ¸©ä¸“æ³¨ä»“ Ã— è¡Œä¸ºè¯†åˆ« Ã— æ—¶é—´å›æ”¾.md**,ä»¥ä¸‹åŠŸèƒ½ä¾èµ–æ•°æ®åº“:

#### 1. çº¢æ¸©ä¸“æ³¨ä»“ (Â§1)
- âœ… `FocusSession` åˆ›å»ºä¸çŠ¶æ€æ›´æ–° (Â§1.5)
- âœ… ä¸“æ³¨æ—¶é—´ç»Ÿè®¡ (Â§1.2 æ­¥éª¤5)
- âœ… æ—¶é—´å—çŠ¶æ€åŒæ­¥ (Â§1.4)

#### 2. è¡Œä¸ºè¯†åˆ« (Â§2)
- âœ… `ActivitySession` èšåˆå­˜å‚¨ (Â§2.2)
- âœ… App åˆ†ç±»è§„åˆ™ç®¡ç† (Â§2.3)
- âœ… æ¯æ—¥è¡Œä¸ºç»Ÿè®¡ (Â§2.4)

#### 3. æ—¶é—´å›æ”¾ (Â§3)
- âœ… è®¡åˆ’ vs ä¸“æ³¨æ•°æ®èšåˆ (Â§3.2)
- âœ… è¡Œä¸ºç»Ÿè®¡æ•°æ®æŸ¥è¯¢ (Â§3.3)
- âœ… å®Œæ•´çš„æ—¶é—´å›æ”¾æŠ¥å‘Š (Â§3.1)

#### 4. ç»Ÿè®¡æŠ¥å‘Š
- âœ… `db.get_today_focus_stats()` (db_manager.py:260)
- âœ… `db.get_today_activity_stats()` (db_manager.py:287)
- âœ… `db.get_active_focus_sessions()` (db_manager.py:145)

**ç»“è®º**: ä¿®å¤å‰,è¿™äº›åŠŸèƒ½åœ¨å¼€æœºå¯åŠ¨åœºæ™¯ä¸‹å…¨éƒ¨å¤±æ•ˆã€‚ä¿®å¤å,æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ã€‚

---

## ğŸ”§ åç»­ä¼˜åŒ–å»ºè®®

### P0 - å·²å®Œæˆ
- âœ… ä¿®å¤æ•°æ®åº“è·¯å¾„é—®é¢˜
- âœ… æ·»åŠ é”™è¯¯æ—¥å¿—
- âœ… æµ‹è¯•éªŒè¯

### P1 - æ¨è
- [ ] **æ•°æ®è¿ç§»å·¥å…·**: ä»æ—§è·¯å¾„ `user_data.db` è¿ç§»åˆ°æ–°è·¯å¾„
  ```python
  # ä¼ªä»£ç 
  old_db = "user_data.db"
  new_db = Path.home() / "AppData" / "Local" / "GaiYa" / "user_data.db"
  if Path(old_db).exists() and not new_db.exists():
      shutil.copy(old_db, new_db)
      logger.info(f"Migrated database from {old_db} to {new_db}")
  ```

- [ ] **é¦–æ¬¡å¯åŠ¨æç¤º**: å‘ŠçŸ¥ç”¨æˆ·æ•°æ®å­˜å‚¨ä½ç½®
  ```
  æ•°æ®å­˜å‚¨ä½ç½®: C:\Users\<ç”¨æˆ·>\AppData\Local\GaiYa
  ```

### P2 - å¯é€‰
- [ ] **è‡ªå®šä¹‰æ•°æ®è·¯å¾„**: åœ¨è®¾ç½®ä¸­å…è®¸ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®åº“è·¯å¾„
- [ ] **æ•°æ®å¤‡ä»½åŠŸèƒ½**: ä¸€é”®å¤‡ä»½/æ¢å¤æ•°æ®åº“
- [ ] **äº‘åŒæ­¥æ”¯æŒ**: å°† AppData è·¯å¾„ä¸äº‘åŒæ­¥æœåŠ¡é›†æˆ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [çº¢æ¸©ä¸“æ³¨ä»“ Ã— è¡Œä¸ºè¯†åˆ« Ã— æ—¶é—´å›æ”¾.md](çº¢æ¸©ä¸“æ³¨ä»“ Ã— è¡Œä¸ºè¯†åˆ« Ã— æ—¶é—´å›æ”¾.md) - åŠŸèƒ½è®¾è®¡æ–‡æ¡£
  - Â§2.2 è¡Œä¸ºé‡‡é›†
  - Â§6.1 æ•°æ®åº“è®¾è®¡
  - Â§6.2 æ•°æ®ç®¡ç†å±‚è®¾è®¡

- [PYINSTALLER_DEVELOPMENT_METHODOLOGY.md](PYINSTALLER_DEVELOPMENT_METHODOLOGY.md) - æ‰“åŒ…æ–¹æ³•è®º
  - ä¿®æ”¹ä»£ç  â†’ æ¸…ç† build/dist â†’ é‡æ–°æ‰“åŒ… â†’ æµ‹è¯• exe

- [QUICKREF.md](QUICKREF.md) - å¿«é€Ÿå‚è€ƒæ‰‹å†Œ
  - æ•°æ®æ–‡ä»¶è¯´æ˜

---

## ğŸ“ å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ |
|------|------|---------|
| 2025-12-01 | v1.6.x | ä¿®å¤æ•°æ®åº“è·¯å¾„é—®é¢˜,ä½¿ç”¨ AppData ç›®å½• |
| 2025-12-01 | v1.6.x | æ·»åŠ æ•°æ®åº“é”™è¯¯æ—¥å¿—è®°å½• |
| 2025-12-01 | v1.6.x | éªŒè¯æµ‹è¯•é€šè¿‡,é‡æ–°æ‰“åŒ… |

---

## âœ… æ€»ç»“

### é—®é¢˜æ ¸å¿ƒ
å¼€æœºå¯åŠ¨æ—¶å·¥ä½œç›®å½•ä¸æ­£ç¡®,å¯¼è‡´ç›¸å¯¹è·¯å¾„çš„æ•°æ®åº“æ–‡ä»¶æ— æ³•æ‰“å¼€ã€‚

### è§£å†³æ–¹æ¡ˆ
ä½¿ç”¨ Windows æ ‡å‡† AppData ç›®å½•å­˜å‚¨æ•°æ®åº“,æ¶ˆé™¤å¯¹å·¥ä½œç›®å½•çš„ä¾èµ–ã€‚

### ä¿®å¤æ•ˆæœ
- âœ… æ‰‹åŠ¨è¿è¡Œ: æ­£å¸¸
- âœ… å¼€æœºå¯åŠ¨: æ­£å¸¸ (ä¿®å¤å‰å¤±è´¥)
- âœ… å¿«æ·æ–¹å¼: æ­£å¸¸
- âœ… ä»»æ„ç›®å½•è¿è¡Œ: æ­£å¸¸

### ä»£ç å˜æ›´
- ä¿®æ”¹æ–‡ä»¶: `gaiya/data/db_manager.py`
- å˜æ›´è¡Œæ•°: 12-29 (18 è¡Œ)
- å½±å“æ¨¡å—: æ•°æ®åº“åˆå§‹åŒ–ã€ä¸“æ³¨ä¼šè¯ã€è¡Œä¸ºè¯†åˆ«ã€æ—¶é—´å›æ”¾

### ç”¨æˆ·å½±å“
- âœ… **æ— éœ€ç”¨æˆ·å¹²é¢„**: è‡ªåŠ¨ä½¿ç”¨æ–°è·¯å¾„
- âœ… **æ•°æ®å…¼å®¹æ€§**: æ–°æ—§ç‰ˆæœ¬æ•°æ®éš”ç¦» (å¯åç»­è¿ç§»)
- âœ… **ä½“éªŒæ”¹å–„**: å¼€æœºå¯åŠ¨ä¸å†å´©æºƒ

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-12-01 10:53
**ä¸‹æ¬¡æ‰“åŒ…ç‰ˆæœ¬**: v1.6.x+
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡
