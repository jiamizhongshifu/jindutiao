# PyDayBar v1.4 已知问题说明

**发布日期**: 2025-01-XX
**版本**: v1.4

---

## 🐛 已知问题 (未修复)

### 问题: 应用启动后卡死 ⚠️

**用户反馈**:
> 打开应用后还是遇到了卡死的问题

**问题描述**:
- 应用启动后界面无响应
- 窗口显示但无法交互
- 进程占用CPU但无响应
- 无法打开配置界面

**问题复现**:
- 双击 `PyDayBar-v1.4.exe` 启动
- 启动后立即卡死，无响应
- 必须通过任务管理器强制结束进程

**已尝试的修复方案**:

#### 修复尝试 1: 移除 `QApplication.processEvents()` 调用
- **问题**: 在 `apply_theme()` 方法中调用 `QApplication.processEvents()` 可能导致死锁
- **修复**: 移除所有 `processEvents()` 调用，依赖Qt事件循环自动处理更新
- **结果**: ❌ 未解决

#### 修复尝试 2: 延迟主题应用
- **问题**: 在窗口初始化时立即应用主题可能导致UI阻塞
- **修复**: 使用 `QTimer.singleShot(100, self.apply_theme)` 延迟100ms应用主题
- **结果**: ❌ 未解决

#### 修复尝试 3: 修改 `register_ui_component` 参数
- **问题**: 注册UI组件时立即调用 `apply_theme()` 可能导致问题
- **修复**: 添加 `apply_immediately=False` 参数，延迟主题应用
- **结果**: ❌ 未解决

#### 修复尝试 4: 调整窗口显示时机
- **问题**: 在 `init_ui()` 中调用 `show()` 可能导致初始化顺序问题
- **修复**: 将 `show()` 调用移到 `main()` 函数中，在窗口完全初始化后显示
- **结果**: ❌ 未解决

#### 修复尝试 5: 引入静默主题加载
- **问题**: `ThemeManager` 初始化时触发信号可能导致问题
- **修复**: 创建 `_load_current_theme_silent()` 和 `_load_theme_by_id_silent()` 方法，避免在初始化时触发信号
- **结果**: ❌ 未解决

**当前状态**:
- ⚠️ **问题仍未解决**
- 🔍 **需要进一步调查根本原因**

**可能的原因分析**:

1. **Qt事件循环问题**
   - 可能在初始化过程中某个操作阻塞了事件循环
   - 需要检查是否有同步操作在UI线程中执行

2. **主题管理器初始化问题**
   - `ThemeManager` 单例模式可能在初始化时存在问题
   - 多个UI组件同时注册可能导致竞态条件

3. **资源加载问题**
   - `themes.json` 文件加载可能存在问题
   - 文件读取可能阻塞UI线程

4. **PyInstaller打包问题**
   - 打包后的资源路径可能不正确
   - 某些模块导入可能失败

**建议的排查步骤**:

1. **添加详细日志**
   - 在关键初始化步骤添加日志输出
   - 确认卡死发生在哪个具体步骤

2. **简化初始化流程**
   - 临时移除主题管理器，测试应用是否能正常启动
   - 逐步添加功能，定位问题模块

3. **检查资源文件**
   - 确认 `themes.json` 文件格式正确
   - 确认所有资源文件都正确打包

4. **测试源码运行**
   - 使用 `python main.py` 直接运行，确认是否是打包问题
   - 对比打包版本和源码版本的差异

**临时解决方案**:

目前没有有效的临时解决方案，建议：
- 使用旧版本 (v1.3) 作为临时替代
- 等待问题修复后的新版本

---

## 📝 其他修复

### 已修复的问题

#### 问题1: AI服务未自动启动
- **状态**: ✅ 已修复
- **修复方案**: 延迟AI后端启动，使用 `QTimer.singleShot(1000, lambda: backend_manager.ensure_backend_running())`

#### 问题2: 主题设置UI冗余
- **状态**: ✅ 已修复
- **修复方案**: 将主题卡片替换为下拉选择框，添加预览功能

#### 问题3: 打包后资源文件缺失
- **状态**: ✅ 已修复
- **修复方案**: 更新 `PyDayBar.spec`，包含所有模板文件和 `kun.webp` 资源

#### 问题4: 主题应用不完整
- **状态**: ✅ 已修复
- **修复方案**: 确保 `apply_theme()` 更新所有相关配置属性

#### 问题5: 主题模式冲突
- **状态**: ✅ 已修复
- **修复方案**: 移除主题模式选择，仅保留预设主题

---

## 🔧 技术细节

### 修改的文件

- `main.py` - 主题应用逻辑优化
- `theme_manager.py` - 添加静默加载方法
- `config_gui.py` - UI简化，移除主题模式选择
- `PyDayBar.spec` - 更新打包配置

### 新增功能

- 主题预览功能
- 下拉选择框主题切换
- 自动应用选中主题

---

## 📞 问题反馈

如果发现新的问题或有解决思路，请提供：
1. `pydaybar.log` 日志文件
2. 问题复现步骤
3. 系统环境信息（Windows版本、Python版本等）
4. 错误截图或描述

---

**版本**: v1.4
**更新日期**: 2025-01-XX
**已知问题**: 1个（应用启动卡死）
**状态**: ⚠️ 需要进一步调查

