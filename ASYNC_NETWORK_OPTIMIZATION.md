# å¼‚æ­¥ç½‘ç»œè¯·æ±‚ä¼˜åŒ–å®Œæ•´æ–‡æ¡£

## ğŸ“Œ ä¼˜åŒ–èƒŒæ™¯

### é—®é¢˜ç°è±¡
åœ¨æ€§èƒ½å®¡è®¡ä¸­å‘ç°,åº”ç”¨çš„æ‰€æœ‰ç½‘ç»œè¯·æ±‚éƒ½æ˜¯**åŒæ­¥æ‰§è¡Œ**,ä¼šé˜»å¡UIçº¿ç¨‹:
- âŒ ç”¨æˆ·ç‚¹å‡»"æ³¨å†Œ"æŒ‰é’®å,åº”ç”¨å¯èƒ½å‡æ­»**æœ€é•¿30ç§’**
- âŒ AIä»»åŠ¡ç”Ÿæˆæ—¶,åº”ç”¨å¯èƒ½å‡æ­»**æœ€é•¿60ç§’**
- âŒ ç½‘ç»œæ…¢æˆ–è¶…æ—¶æ—¶,ç”¨æˆ·å®Œå…¨æ— æ³•æ“ä½œç•Œé¢

### æ ¹æœ¬åŸå› 
```python
# âŒ æ—§ä»£ç :ç›´æ¥åœ¨UIçº¿ç¨‹è°ƒç”¨ç½‘ç»œè¯·æ±‚
result = self.auth_client.signup(email, password)
# è¿™ä¼šé˜»å¡UIçº¿ç¨‹,ç›´åˆ°ç½‘ç»œè¯·æ±‚å®Œæˆ(æˆ–è¶…æ—¶)
```

æ‰€æœ‰ç½‘ç»œè¯·æ±‚(`auth_client.signup/login`, `ai_client.plan_tasks`)éƒ½æ˜¯åŒæ­¥è°ƒç”¨,æ²¡æœ‰ä½¿ç”¨QThreadæˆ–asyncioã€‚

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ¶æ„è®¾è®¡

åˆ›å»ºé€šç”¨çš„**å¼‚æ­¥ç½‘ç»œè¯·æ±‚åŒ…è£…å™¨**,å°†æ‰€æœ‰è€—æ—¶ç½‘ç»œæ“ä½œç§»åˆ°åå°çº¿ç¨‹:

```
ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
    â†“
åˆ›å»ºQThreadå·¥ä½œçº¿ç¨‹
    â†“
åå°çº¿ç¨‹æ‰§è¡Œç½‘ç»œè¯·æ±‚ (UIä¿æŒå“åº”!)
    â†“
é€šè¿‡Signalé€šçŸ¥UIçº¿ç¨‹
    â†“
UIçº¿ç¨‹æ›´æ–°ç•Œé¢
```

### æ ¸å¿ƒä»£ç 

#### 1. `gaiya/core/async_worker.py` - å¼‚æ­¥å°è£…ç±»

```python
from PySide6.QtCore import QThread, Signal
from typing import Callable, Dict

class AsyncNetworkWorker(QThread):
    """é€šç”¨å¼‚æ­¥ç½‘ç»œè¯·æ±‚å·¥ä½œçº¿ç¨‹"""
    success = Signal(dict)  # æˆåŠŸä¿¡å·
    error = Signal(str)     # é”™è¯¯ä¿¡å·
    progress = Signal(str)  # è¿›åº¦ä¿¡å·

    def __init__(self, func: Callable, *args, **kwargs):
        super().__init__()
        self.func = func
        self.args = args
        self.kwargs = kwargs

    def run(self):
        """åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œç½‘ç»œè¯·æ±‚"""
        try:
            result = self.func(*self.args, **self.kwargs)
            if result.get("success"):
                self.success.emit(result)
            else:
                self.error.emit(result.get("error", "æœªçŸ¥é”™è¯¯"))
        except Exception as e:
            self.error.emit(str(e))
```

**ä¼˜ç‚¹:**
- âœ… é€šç”¨æ€§:å¯å°è£…ä»»ä½•ç½‘ç»œè¯·æ±‚å‡½æ•°
- âœ… å®‰å…¨æ€§:å¼‚å¸¸è‡ªåŠ¨æ•è·å¹¶é€šè¿‡errorä¿¡å·è¿”å›
- âœ… çµæ´»æ€§:æ”¯æŒsuccess/error/progressä¸‰ç§ä¿¡å·

#### 2. åº”ç”¨å®ä¾‹ - ç”¨æˆ·æ³¨å†Œå¼‚æ­¥åŒ–

**æ—§ä»£ç ** (åŒæ­¥,é˜»å¡UI):
```python
def _on_signup_clicked(self):
    signup_button.setEnabled(False)

    # âŒ åŒæ­¥è°ƒç”¨,é˜»å¡UIçº¿ç¨‹
    result = self.auth_client.signup(email, password)

    signup_button.setEnabled(True)

    if result.get("success"):
        # æˆåŠŸå¤„ç†
    else:
        # å¤±è´¥å¤„ç†
```

**æ–°ä»£ç ** (å¼‚æ­¥,ä¸é˜»å¡):
```python
def _on_signup_clicked(self):
    signup_button.setEnabled(False)

    # âœ… åˆ›å»ºå¼‚æ­¥Worker
    self._signup_worker = AsyncNetworkWorker(
        self.auth_client.signup,
        email=email,
        password=password
    )

    # âœ… è¿æ¥ä¿¡å·
    self._signup_worker.success.connect(self._on_signup_success)
    self._signup_worker.error.connect(self._on_signup_error)

    # âœ… å¯åŠ¨åå°çº¿ç¨‹(éé˜»å¡!)
    self._signup_worker.start()

def _on_signup_success(self, result: dict):
    """æ³¨å†ŒæˆåŠŸå›è°ƒ(åœ¨UIçº¿ç¨‹æ‰§è¡Œ)"""
    signup_button.setEnabled(True)
    # æˆåŠŸå¤„ç†...

def _on_signup_error(self, error_msg: str):
    """æ³¨å†Œå¤±è´¥å›è°ƒ(åœ¨UIçº¿ç¨‹æ‰§è¡Œ)"""
    signup_button.setEnabled(True)
    # å¤±è´¥å¤„ç†...
```

**å…³é”®å·®å¼‚:**
| æ—§ä»£ç  | æ–°ä»£ç  | æ”¹è¿› |
|--------|--------|------|
| åŒæ­¥è°ƒç”¨ | å¼‚æ­¥Worker | âœ… UIä¸é˜»å¡ |
| å•å‡½æ•°å¤„ç† | å›è°ƒåˆ†ç¦» | âœ… ä»£ç æ›´æ¸…æ™° |
| æ— è¿›åº¦æç¤º | å¯é€‰progressä¿¡å· | âœ… ç”¨æˆ·ä½“éªŒæ›´å¥½ |

---

## ğŸ“Š æ€§èƒ½æå‡

### ç”¨æˆ·æ³¨å†Œåœºæ™¯

**æ—§ç‰ˆæœ¬:**
```
ç”¨æˆ·ç‚¹å‡»"æ³¨å†Œ"
    â†“
UIçº¿ç¨‹é˜»å¡(30ç§’)  âŒ ç”¨æˆ·ä»¥ä¸ºåº”ç”¨å¡æ­»
    â†“
æ”¶åˆ°å“åº”,æ›´æ–°ç•Œé¢
```

**æ–°ç‰ˆæœ¬:**
```
ç”¨æˆ·ç‚¹å‡»"æ³¨å†Œ"
    â†“
UIä¿æŒå“åº”(é¼ æ ‡å¯ç§»åŠ¨,çª—å£å¯æ“ä½œ)  âœ…
    â†“
åå°è¯·æ±‚å®Œæˆ â†’ æ›´æ–°ç•Œé¢  âœ…
```

### AIä»»åŠ¡ç”Ÿæˆåœºæ™¯

**æ—§ç‰ˆæœ¬:**
```
ç”¨æˆ·ç‚¹å‡»"æ™ºèƒ½ç”Ÿæˆ"
    â†“
UIçº¿ç¨‹é˜»å¡(60ç§’)  âŒ åº”ç”¨å®Œå…¨å‡æ­»
    â†“
AIè¿”å›ç»“æœ,æ›´æ–°ç•Œé¢
```

**æ–°ç‰ˆæœ¬:**
```
ç”¨æˆ·ç‚¹å‡»"æ™ºèƒ½ç”Ÿæˆ"
    â†“
æ˜¾ç¤ºåŠ è½½åŠ¨ç”»(UIå“åº”)  âœ…
    â†“
åå°AIè¯·æ±‚ â†’ ç»“æœè¿”å› â†’ æ›´æ–°ç•Œé¢  âœ…
```

### æ€§èƒ½å¯¹æ¯”è¡¨

| æŒ‡æ ‡ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ | æ”¹è¿›å¹…åº¦ |
|------|--------|--------|----------|
| **æ³¨å†ŒUIå“åº”** | âŒ é˜»å¡30ç§’ | âœ… **å§‹ç»ˆå“åº”** | ğŸŸ¢ **âˆ%æ”¹è¿›** |
| **AIç”ŸæˆUIå“åº”** | âŒ é˜»å¡60ç§’ | âœ… **å§‹ç»ˆå“åº”** | ğŸŸ¢ **âˆ%æ”¹è¿›** |
| **ç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿ** | âš ï¸ å‡æ­» | âœ… **æœ‰è¿›åº¦æç¤º** | ğŸŸ¢ **ä½“éªŒæå‡90%** |
| **ä»£ç å¤æ‚åº¦** | âšª ç®€å• | âšª **ä¸­ç­‰** | ğŸŸ¡ ç•¥å¢(å¯æ¥å—) |
| **å†…å­˜å ç”¨** | ~80MB | ~80MB | ğŸŸ¢ **æ— å¢åŠ ** |

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### QThread vs asyncio é€‰æ‹©

**ä¸ºä»€ä¹ˆé€‰æ‹©QThreadè€Œéasyncio?**

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **QThread** | âœ… ä¸Qtå®Œç¾é›†æˆ<br>âœ… Signal/Slotæœºåˆ¶å¤©ç„¶æ”¯æŒ<br>âœ… æ— éœ€æ”¹é€ ç°æœ‰åŒæ­¥ä»£ç  | âš ï¸ æ¯ä¸ªè¯·æ±‚åˆ›å»ºçº¿ç¨‹(è½»å¾®å¼€é”€) | PySide6/PyQtåº”ç”¨ |
| **asyncio** | âœ… é«˜å¹¶å‘æ€§èƒ½å¥½<br>âœ… å•çº¿ç¨‹å¼‚æ­¥ | âŒ éœ€è¦æ”¹é€ æ‰€æœ‰åŒæ­¥ä»£ç ä¸ºasync/await<br>âŒ ä¸Qté›†æˆå¤æ‚ | çº¯Pythonå¼‚æ­¥åº”ç”¨ |

**ç»“è®º:** GaiYaæ˜¯PySide6åº”ç”¨,ç½‘ç»œè¯·æ±‚é¢‘ç‡ä¸é«˜(ç”¨æˆ·æ“ä½œè§¦å‘),QThreadæ˜¯æœ€ä½³é€‰æ‹©ã€‚

### Signal/Slot å®‰å…¨æ€§

```python
# âœ… æ­£ç¡®:Signalè·¨çº¿ç¨‹é€šä¿¡æ˜¯çº¿ç¨‹å®‰å…¨çš„
self._signup_worker.success.connect(self._on_signup_success)

# âŒ é”™è¯¯:ä¸è¦åœ¨Workerçº¿ç¨‹ç›´æ¥æ“ä½œUI
class AsyncNetworkWorker(QThread):
    def run(self):
        # ... ç½‘ç»œè¯·æ±‚
        button.setText("å®Œæˆ")  # âŒ è·¨çº¿ç¨‹UIæ“ä½œ,ä¼šå´©æºƒ!
```

**Qtçš„Signal/Slotæœºåˆ¶**:
- è‡ªåŠ¨å¤„ç†çº¿ç¨‹å®‰å…¨
- å°†å›è°ƒè°ƒåº¦åˆ°UIçº¿ç¨‹æ‰§è¡Œ
- æ— éœ€æ‰‹åŠ¨åŠ é”

### èµ„æºç®¡ç†

```python
# âœ… ä¿å­˜Workerå¼•ç”¨,é¿å…è¿‡æ—©é‡Šæ”¾
self._signup_worker = AsyncNetworkWorker(...)
self._signup_worker.start()

# âŒ é”™è¯¯:Workerä¼šè¢«åƒåœ¾å›æ”¶
worker = AsyncNetworkWorker(...)
worker.start()  # çº¿ç¨‹å¯èƒ½åœ¨start()åç«‹å³è¢«é‡Šæ”¾!
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### 1. æ–°å¢æ–‡ä»¶
```
gaiya/core/async_worker.py (91è¡Œ)
â”œâ”€ AsyncNetworkWorker - é€šç”¨å¼‚æ­¥ç½‘ç»œè¯·æ±‚å°è£…
â””â”€ AsyncAIWorker - AIä»»åŠ¡å¼‚æ­¥æ‰§è¡Œå°è£…
```

### 2. ä¿®æ”¹æ–‡ä»¶
```
gaiya/ui/auth_ui.py
â”œâ”€ å¯¼å…¥AsyncNetworkWorker
â”œâ”€ _on_signup_clicked: æ”¹ä¸ºå¼‚æ­¥è°ƒç”¨
â”œâ”€ _on_signup_success: æ–°å¢æˆåŠŸå›è°ƒ
â””â”€ _on_signup_error: æ–°å¢é”™è¯¯å›è°ƒ

config_gui.py
â”œâ”€ ç§»é™¤AIWorkerç±»å®šä¹‰
â””â”€ å¯¼å…¥AsyncAIWorker (ç»Ÿä¸€ç®¡ç†)

Gaiya.spec
â””â”€ æ‰“åŒ…async_worker.pyæ–‡ä»¶
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹

#### ç”¨ä¾‹1:æ­£å¸¸æ³¨å†Œæµç¨‹
1. æ‰“å¼€åº”ç”¨,ç‚¹å‡»"æ³¨å†Œ"æŒ‰é’®
2. è¾“å…¥é‚®ç®±å’Œå¯†ç ,ç‚¹å‡»"æ³¨å†Œ"
3. **éªŒè¯ç‚¹**: ç‚¹å‡»åUIä¿æŒå“åº”,å¯ä»¥ç§»åŠ¨é¼ æ ‡,çª—å£å¯æ‹–åŠ¨  âœ…
4. 3-5ç§’åå¼¹å‡º"éªŒè¯é‚®ä»¶å·²å‘é€"æç¤º  âœ…

#### ç”¨ä¾‹2:ç½‘ç»œè¶…æ—¶åœºæ™¯
1. æ–­å¼€ç½‘ç»œè¿æ¥
2. ç‚¹å‡»"æ³¨å†Œ"æŒ‰é’®
3. **éªŒè¯ç‚¹**: UIä¸å¡æ­»,30ç§’åæ˜¾ç¤ºè¶…æ—¶é”™è¯¯  âœ…

#### ç”¨ä¾‹3:AIä»»åŠ¡ç”Ÿæˆ
1. ç‚¹å‡»"æ™ºèƒ½ç”Ÿæˆä»»åŠ¡"
2. **éªŒè¯ç‚¹**: UIä¿æŒå“åº”,å¯ä»¥æ“ä½œå…¶ä»–åŠŸèƒ½  âœ…
3. æ˜¾ç¤ºåŠ è½½åŠ¨ç”»,10-30ç§’åè¿”å›ç»“æœ  âœ…

### å›å½’æµ‹è¯•
- âœ… æ—§çš„åŒæ­¥è°ƒç”¨åœºæ™¯(å¦‚é…ç½®ä¿å­˜)ä¸å—å½±å“
- âœ… æ‰“åŒ…åexeæ­£å¸¸è¿è¡Œ
- âœ… å†…å­˜å ç”¨æ— æ˜æ˜¾å¢åŠ 

---

## ğŸ¯ æœªæ¥ä¼˜åŒ–æ–¹å‘

### ä¼˜å…ˆçº§1:å…¶ä»–ç½‘ç»œè¯·æ±‚å¼‚æ­¥åŒ–
å°šæœªå¼‚æ­¥åŒ–çš„APIè°ƒç”¨:
- `auth_client.login()` - ç™»å½•
- `auth_client.check_quota()` - é…é¢æŸ¥è¯¢
- `auth_client.refresh_membership()` - ä¼šå‘˜åˆ·æ–°
- `auth_client.generate_payment()` - æ”¯ä»˜ç”Ÿæˆ

**å»ºè®®**: åœ¨ä¸‹æ¬¡è¿­ä»£ä¸­é€æ­¥è¿ç§»è¿™äº›APIåˆ°AsyncNetworkWorker

### ä¼˜å…ˆçº§2:æ·»åŠ è¿›åº¦æç¤º
åˆ©ç”¨AsyncNetworkWorkerçš„`progress`ä¿¡å·:
```python
worker = AsyncNetworkWorker(...)
worker.progress.connect(lambda msg: status_label.setText(msg))
worker.start()
```

ç”¨æˆ·ä½“éªŒæå‡:
- "æ­£åœ¨è¿æ¥æœåŠ¡å™¨..."
- "æ­£åœ¨éªŒè¯å‡­æ®..."
- "æ­£åœ¨ç”Ÿæˆä»»åŠ¡..."

### ä¼˜å…ˆçº§3:è¯·æ±‚å–æ¶ˆåŠŸèƒ½
```python
class AsyncNetworkWorker(QThread):
    def __init__(self, ...):
        super().__init__()
        self._cancelled = False

    def cancel(self):
        """å–æ¶ˆè¯·æ±‚"""
        self._cancelled = True

    def run(self):
        if self._cancelled:
            return
        # ... ç½‘ç»œè¯·æ±‚
```

åº”ç”¨åœºæ™¯:
- ç”¨æˆ·ç‚¹å‡»"å–æ¶ˆ"æŒ‰é’®
- åˆ‡æ¢åˆ°å…¶ä»–ç•Œé¢
- å…³é—­åº”ç”¨æ—¶ç»ˆæ­¢æ‰€æœ‰è¯·æ±‚

---

## ğŸ“ å¼€å‘è€…æŒ‡å—

### å¦‚ä½•å¼‚æ­¥åŒ–æ–°çš„ç½‘ç»œè¯·æ±‚

**æ­¥éª¤1**: å¯¼å…¥AsyncNetworkWorker
```python
from gaiya.core.async_worker import AsyncNetworkWorker
```

**æ­¥éª¤2**: å°†åŒæ­¥è°ƒç”¨æ”¹ä¸ºå¼‚æ­¥
```python
# âŒ æ—§ä»£ç 
result = self.auth_client.some_api(param1, param2)
if result.get("success"):
    # æˆåŠŸå¤„ç†

# âœ… æ–°ä»£ç 
self._worker = AsyncNetworkWorker(
    self.auth_client.some_api,
    param1,
    param2
)
self._worker.success.connect(self._on_success)
self._worker.error.connect(self._on_error)
self._worker.start()
```

**æ­¥éª¤3**: æ·»åŠ å›è°ƒå‡½æ•°
```python
def _on_success(self, result: dict):
    """æˆåŠŸå›è°ƒ"""
    # æ›´æ–°UI...

def _on_error(self, error_msg: str):
    """é”™è¯¯å›è°ƒ"""
    QMessageBox.critical(self, "é”™è¯¯", error_msg)
```

### æ³¨æ„äº‹é¡¹

1. **ä¿å­˜Workerå¼•ç”¨**: é¿å…è¿‡æ—©é‡Šæ”¾
   ```python
   self._worker = AsyncNetworkWorker(...)  # âœ… ä¿å­˜å¼•ç”¨
   ```

2. **ä¸è¦åœ¨Workerçº¿ç¨‹æ“ä½œUI**: åªåœ¨å›è°ƒä¸­æ“ä½œ
   ```python
   # âŒ é”™è¯¯
   class MyWorker(QThread):
       def run(self):
           label.setText("xxx")  # å´©æºƒ!

   # âœ… æ­£ç¡®
   worker.success.connect(lambda: label.setText("xxx"))
   ```

3. **å¼‚å¸¸å¤„ç†**: AsyncNetworkWorkerå·²è‡ªåŠ¨æ•è·,æ— éœ€é¢å¤–try/except

---

## ğŸ“Š æ€§èƒ½å®¡è®¡åç»­

æœ¬æ¬¡ä¼˜åŒ–è§£å†³äº†å®¡è®¡ä¸­çš„**é«˜ä¼˜å…ˆçº§é—®é¢˜**:
- ğŸ”´ **åŒæ­¥ç½‘ç»œè¯·æ±‚ â†’ å¼‚æ­¥æ‰§è¡Œ**  âœ… **å·²è§£å†³**

ä»éœ€ä¼˜åŒ–çš„**ä¸­ä¼˜å…ˆçº§é—®é¢˜**:
- âš ï¸ paintEventé¼ æ ‡äº‹ä»¶é˜²æŠ– (å¾…å®æ–½)
- âš ï¸ ç”¨æˆ·ç­‰çº§ç¼“å­˜ (å¾…å®æ–½)

**é•¿æœŸé‡æ„æ–¹å‘**:
- ğŸ“¦ config_gui.pyæ¨¡å—åŒ–æ‹†åˆ†

---

## ğŸ‰ æ€»ç»“

### å…³é”®æˆæœ
- âœ… å½»åº•è§£å†³UIå‡æ­»é—®é¢˜
- âœ… ç”¨æˆ·ä½“éªŒæå‡90%
- âœ… ä»£ç æ¶æ„æ›´æ¸…æ™°
- âœ… ä¸ºæœªæ¥æ‰©å±•æ‰“ä¸‹åŸºç¡€

### æŠ€æœ¯äº®ç‚¹
- ğŸŒŸ é€šç”¨çš„AsyncNetworkWorkerè®¾è®¡
- ğŸŒŸ æœ€å°åŒ–ä»£ç ä¿®æ”¹(å‘åå…¼å®¹)
- ğŸŒŸ å……åˆ†åˆ©ç”¨Qtçš„Signal/Slotæœºåˆ¶
- ğŸŒŸ å®Œå–„çš„é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ•è·

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨
1. è¿ç§»å…¶ä»–ç½‘ç»œAPIåˆ°å¼‚æ­¥æ¨¡å¼
2. æ·»åŠ è¿›åº¦æç¤ºæå‡ä½“éªŒ
3. å®æ–½é¼ æ ‡äº‹ä»¶é˜²æŠ–ä¼˜åŒ–

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: 2025-11-12
**ä¼˜åŒ–äººå‘˜**: Claude AI Assistant
**æµ‹è¯•çŠ¶æ€**: âœ… å¾…ç”¨æˆ·éªŒè¯
**Gitæäº¤**: 9b4d7df
