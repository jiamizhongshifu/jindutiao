# v1.6.8 è®¢å•æŸ¥è¯¢é‡è¯•æœºåˆ¶ä¿®å¤

## ğŸ“‹ é—®é¢˜æè¿°

**ç—‡çŠ¶**:
- ç”¨æˆ·å®Œæˆæ”¯ä»˜(Â¥0.1æ”¯ä»˜æˆåŠŸ,æ˜¾ç¤ºç»¿è‰²å¯¹å‹¾)
- åº”ç”¨åœç•™åœ¨"ç­‰å¾…æ”¯ä»˜å®Œæˆ"å¯¹è¯æ¡†
- ä¼šå‘˜çŠ¶æ€æ²¡æœ‰æ›´æ–°

**æ ¹æœ¬åŸå› **:
- Z-Payçš„`submit.php` APIåˆ›å»ºè®¢å•å,è®¢å•æ•°æ®æœªç«‹å³åŒæ­¥åˆ°æŸ¥è¯¢æ¥å£
- å­˜åœ¨æ•°æ®åº“å†™å…¥å’Œè¯»å–ä¹‹é—´çš„å¤åˆ¶å»¶è¿Ÿ
- å®¢æˆ·ç«¯ç«‹å³æŸ¥è¯¢è®¢å•æ—¶è¿”å›"è®¢å•ç¼–å·ä¸å­˜åœ¨"

**é”™è¯¯æ—¥å¿—** (Vercel):
```
[PAYMENT-CREATE] Order created: GAIYA1764743128661308748
[ZPAY-QUERY] Order not found or error: åœ¨åˆ¶å•å·æˆ–è®¢!
[ZPAY-QUERY] Order not found or error: åœ¨åˆ¶å•å·æˆ–è®¢!
[ZPAY-QUERY] Order not found or error: åœ¨åˆ¶å•å·æˆ–è®¢!
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ æŸ¥è¯¢é‡è¯•æœºåˆ¶ (api/payment-query.py)

**ä¿®æ”¹å†…å®¹**:
```python
# âœ… ä¿®å¤: æ·»åŠ é‡è¯•é€»è¾‘,æœ€å¤šé‡è¯•3æ¬¡,æ¯æ¬¡é—´éš”2ç§’
import time
max_retries = 3
result = None

for attempt in range(max_retries):
    result = zpay.query_order(out_trade_no=out_trade_no)

    if result["success"]:
        print(f"[PAYMENT-QUERY] Order found on attempt {attempt + 1}", file=sys.stderr)
        break

    # å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•,ç­‰å¾…2ç§’åé‡è¯•
    if attempt < max_retries - 1:
        print(f"[PAYMENT-QUERY] Order not found, retry {attempt + 2}/{max_retries} in 2s...", file=sys.stderr)
        time.sleep(2)
    else:
        print(f"[PAYMENT-QUERY] Order not found after {max_retries} attempts", file=sys.stderr)
```

**å·¥ä½œåŸç†**:
1. ç¬¬1æ¬¡æŸ¥è¯¢: ç«‹å³æ‰§è¡Œ (T+0ç§’)
2. ç¬¬2æ¬¡æŸ¥è¯¢: ç­‰å¾…2ç§’åé‡è¯• (T+2ç§’)
3. ç¬¬3æ¬¡æŸ¥è¯¢: å†ç­‰å¾…2ç§’åé‡è¯• (T+4ç§’)
4. æ€»è¶…æ—¶: æœ€å¤š6ç§’

### 2. å¢å¼ºæŸ¥è¯¢æ—¥å¿— (api/zpay_manager.py)

**ä¿®æ”¹å†…å®¹**:
```python
# âœ… å¢å¼ºæ—¥å¿—: è¾“å‡ºå®Œæ•´è¯·æ±‚URLç”¨äºè°ƒè¯•
query_url = f"{self.api_url}/api.php"
print(f"[ZPAY-QUERY] Request URL: {query_url}", file=sys.stderr)
print(f"[ZPAY-QUERY] Request params: act={params['act']}, pid={params['pid'][:6]}..., out_trade_no={params.get('out_trade_no', 'N/A')}", file=sys.stderr)

response = requests.get(query_url, params=params, timeout=10)

# âœ… å¢å¼ºæ—¥å¿—: è¾“å‡ºå“åº”çŠ¶æ€å’Œå†…å®¹é¢„è§ˆ
print(f"[ZPAY-QUERY] Response status: {response.status_code}", file=sys.stderr)
print(f"[ZPAY-QUERY] Response preview (first 200 chars): {response.text[:200]}", file=sys.stderr)
```

**ä¼˜åŠ¿**:
- å¯åœ¨Vercelæ—¥å¿—ä¸­çœ‹åˆ°å®Œæ•´è¯·æ±‚å‚æ•°
- å¯çœ‹åˆ°Z-Pay APIçš„åŸå§‹å“åº”
- ä¾¿äºè¯Šæ–­APIè°ƒç”¨é—®é¢˜

---

## ğŸš€ éƒ¨ç½²çŠ¶æ€

**Git Commit**: 052d260
```bash
git commit -m "fix: æ·»åŠ è®¢å•æŸ¥è¯¢é‡è¯•æœºåˆ¶è§£å†³Z-Payæ•°æ®åº“å»¶è¿Ÿ"
git push origin main
```

**Verceléƒ¨ç½²**:
- æ¨é€æ—¶é—´: 2025-12-03
- éƒ¨ç½²URL: https://jindutiao.vercel.app
- è‡ªåŠ¨éƒ¨ç½²: âœ… å·²è§¦å‘

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### å‰ææ¡ä»¶
- å·²éƒ¨ç½²æœ€æ–°ä»£ç  (commit 052d260)
- Verceléƒ¨ç½²çŠ¶æ€æ˜¾ç¤ºæˆåŠŸ

### æµ‹è¯•æµç¨‹

1. **æ‰“å¼€åº”ç”¨**
   ```
   åŒå‡»è¿è¡Œ dist\GaiYa-v1.6.exe
   ```

2. **è¿›å…¥ä¼šå‘˜ä¸­å¿ƒ**
   - ç‚¹å‡»å³ä¸‹è§’"ä¸ªäººä¸­å¿ƒ"
   - è¿›å…¥"ä¼šå‘˜è®¢é˜…"é¡µé¢

3. **å‘èµ·æ”¯ä»˜**
   - é€‰æ‹©ä»»æ„å¥—é¤(æ¨è:ä¸“ä¸šç‰ˆæœˆä»˜ Â¥0.1)
   - ç‚¹å‡»"å‰å¾€æ”¯ä»˜"
   - é€‰æ‹©"æ”¯ä»˜å®"

4. **å®Œæˆæ”¯ä»˜**
   - åœ¨æµè§ˆå™¨ä¸­å®ŒæˆÂ¥0.1æ”¯ä»˜
   - æ”¯ä»˜æˆåŠŸåçœ‹åˆ°ç»¿è‰²å¯¹å‹¾
   - å…³é—­æ”¯ä»˜é¡µé¢

5. **è§‚å¯Ÿç»“æœ** (é¢„æœŸè¡Œä¸º):
   - â±ï¸ 3-9ç§’å†…: åº”ç”¨è‡ªåŠ¨æ£€æµ‹åˆ°æ”¯ä»˜æˆåŠŸ
   - âœ… å¼¹å‡º"æ”¯ä»˜æˆåŠŸ"å¯¹è¯æ¡†
   - âœ… ä¼šå‘˜çŠ¶æ€æ›´æ–°ä¸º"ä¸“ä¸šç‰ˆ"
   - âœ… å¯¹è¯æ¡†è‡ªåŠ¨å…³é—­

### é¢„æœŸVercelæ—¥å¿—

**æˆåŠŸåœºæ™¯**:
```
[PAYMENT-QUERY] Querying order: GAIYA1764xxxxx
[ZPAY-QUERY] Request URL: https://zpayz.cn/api.php
[ZPAY-QUERY] Request params: act=order, pid=123456..., out_trade_no=GAIYA1764xxxxx
[ZPAY-QUERY] Response status: 200
[ZPAY-QUERY] Response preview: {"code":1,"status":1,"trade_no":"..."}
[ZPAY-QUERY] Order found: GAIYA1764xxxxx, status: 1
[PAYMENT-QUERY] Order found on attempt 1
[PAYMENT-QUERY] Order status: paid
[MEMBERSHIP] Payment detected as paid: GAIYA1764xxxxx
[MEMBERSHIP] Triggering manual upgrade: user=xxx, plan=pro_monthly
[MANUAL-UPGRADE] âœ“ Success: user=xxx upgraded to pro
```

**é‡è¯•åœºæ™¯** (å¦‚æœç¬¬1æ¬¡æŸ¥è¯¢å¤±è´¥):
```
[PAYMENT-QUERY] Querying order: GAIYA1764xxxxx
[ZPAY-QUERY] Order not found or error: åœ¨åˆ¶å•å·æˆ–è®¢!
[PAYMENT-QUERY] Order not found, retry 2/3 in 2s...
[ZPAY-QUERY] Order found: GAIYA1764xxxxx, status: 1
[PAYMENT-QUERY] Order found on attempt 2
[PAYMENT-QUERY] Order status: paid
```

---

## ğŸ“Š æŠ€æœ¯æŒ‡æ ‡

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| è®¢å•æŸ¥è¯¢é‡è¯•æ¬¡æ•° | 1æ¬¡ (ç«‹å³å¤±è´¥) | 3æ¬¡ (é—´éš”2ç§’) |
| æœ€å¤§ç­‰å¾…æ—¶é—´ | 0ç§’ | 6ç§’ |
| Z-Payå»¶è¿Ÿå®¹å¿åº¦ | 0ç§’ | æœ€é«˜6ç§’ |
| è¯Šæ–­æ—¥å¿—è¯¦ç»†åº¦ | â­â­ | â­â­â­â­â­ |

---

## ğŸ”§ å¦‚æœä»ç„¶å¤±è´¥

### è¯Šæ–­æ­¥éª¤

1. **æ£€æŸ¥Verceléƒ¨ç½²**
   ```
   https://vercel.com/jindutiao
   ç¡®è®¤æœ€æ–°éƒ¨ç½²åŒ…å« commit 052d260
   ```

2. **æŸ¥çœ‹Vercelå®æ—¶æ—¥å¿—**
   - è¿›å…¥é¡¹ç›® â†’ Functions â†’ æŸ¥çœ‹å®æ—¶æ—¥å¿—
   - æœç´¢è®¢å•å·: GAIYA1764xxxxx
   - æŸ¥æ‰¾é‡è¯•æ—¥å¿—: "retry 2/3 in 2s"

3. **æµ‹è¯•æŸ¥è¯¢API**
   ```bash
   curl "https://jindutiao.vercel.app/api/payment-query?out_trade_no=GAIYA1764xxxxx"
   ```

4. **æ£€æŸ¥Z-PayçŠ¶æ€**
   - ç™»å½•Z-Payå•†æˆ·åå°
   - æŸ¥çœ‹è®¢å•æ˜¯å¦å­˜åœ¨
   - ç¡®è®¤è®¢å•çŠ¶æ€

### å¯èƒ½çš„è¿›ä¸€æ­¥ä¿®å¤

å¦‚æœé‡è¯•3æ¬¡ä»ç„¶å¤±è´¥,å¯èƒ½éœ€è¦:

1. **å¢åŠ é‡è¯•æ¬¡æ•°**: ä»3æ¬¡å¢åŠ åˆ°5æ¬¡
2. **å»¶é•¿é‡è¯•é—´éš”**: ä»2ç§’å¢åŠ åˆ°3ç§’
3. **æœ¬åœ°ç¼“å­˜è®¢å•**: åˆ›å»ºè®¢å•æ—¶åœ¨æ•°æ®åº“ä¸­è®°å½•,ä¸å®Œå…¨ä¾èµ–Z-PayæŸ¥è¯¢
4. **è”ç³»Z-PayæŠ€æœ¯æ”¯æŒ**: ç¡®è®¤APIå»¶è¿Ÿå’Œæœ€ä½³å®è·µ

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹æ–‡ä»¶
- [api/payment-query.py](api/payment-query.py) - æŸ¥è¯¢APIé‡è¯•é€»è¾‘
- [api/zpay_manager.py](api/zpay_manager.py) - å¢å¼ºæ—¥å¿—è¾“å‡º

### ç›¸å…³æ–‡æ¡£
- [æ‰“åŒ…è¯´æ˜.md](æ‰“åŒ…è¯´æ˜.md) - åº”ç”¨æ‰“åŒ…æŒ‡å—
- [VERCEL_404_è¯Šæ–­.md](VERCEL_404_è¯Šæ–­.md) - JSONè§£æé”™è¯¯è¯Šæ–­
- [v1.6.8_æœ€ç»ˆæµ‹è¯•æŒ‡å¼•.md](v1.6.8_æœ€ç»ˆæµ‹è¯•æŒ‡å¼•.md) - å®Œæ•´æµ‹è¯•æµç¨‹

---

**åˆ›å»ºæ—¶é—´**: 2025-12-03
**Git Commit**: 052d260
**Verceléƒ¨ç½²**: å·²å®Œæˆ
**çŠ¶æ€**: âœ… ç­‰å¾…ç”¨æˆ·æµ‹è¯•åé¦ˆ
