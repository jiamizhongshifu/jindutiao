# 行为识别功能问题诊断与修复

**日期**: 2025-12-01
**版本**: GaiYa v1.6

---

## 问题描述

用户开启行为识别后,发现浏览器(Chrome)和微信等应用的使用时间没有被正确统计到对应分类中,大部分应用显示为"未分类(UNKNOWN)"。

---

## 问题诊断

### 1. 数据采集正常 ✅

通过测试脚本验证,行为识别功能**正在正常工作**:
- 窗口信息采集正常(可以获取 `chrome.exe`, `Weixin.exe` 等)
- 数据库保存正常(已记录30+条活动数据)
- ActivityTracker线程正常运行(每5秒采样一次)

### 2. 应用分类配置不正确 ❌

**核心问题**:数据库中的应用分类配置与实际进程名不匹配:

| 实际进程名 | 配置的进程名 | 结果 |
|-----------|-------------|------|
| `Weixin.exe` | `WeChat.exe` | ❌ 不匹配 → UNKNOWN |
| `chrome.exe` | `chrome.exe` (UNKNOWN) | ❌ 分类错误 → UNKNOWN |
| `Cursor.exe` | ❌ 未配置 | ❌ 未配置 → UNKNOWN |

**原因分析**:
1. 微信的进程名是 `Weixin.exe` 而非 `WeChat.exe`
2. Chrome被配置为UNKNOWN,而不是NEUTRAL或LEISURE
3. 许多常用应用未包含在默认配置中

---

## 解决方案

### 修改1: 更新默认应用分类配置

**文件**: `gaiya/data/db_manager.py`
**位置**: Lines 86-120

**新增/修正的应用分类**:

#### 开发工具 (PRODUCTIVE)
- `CODE.EXE` - Visual Studio Code
- `Cursor.exe` - Cursor AI编辑器 ✨
- `pycharm64.exe` - PyCharm
- `devenv.exe` - Visual Studio

#### 社交通讯 (LEISURE)
- `Weixin.exe` - 微信(修正) ✨
- `WeChat.exe` - 微信(兼容旧版本)
- `DingTalk.exe` - 钉钉 ✨
- `Feishu.exe` - 飞书 ✨
- `TIM.exe` - TIM

#### 娱乐工具 (LEISURE)
- `qqmusic.exe` - QQ音乐 ✨
- `cloudmusic.exe` - 网易云音乐 ✨
- `WeGame.exe` - WeGame游戏平台 ✨

#### 浏览器 (NEUTRAL)
- `chrome.exe` - Chrome(从UNKNOWN改为NEUTRAL) ✨
- `msedge.exe` - Edge(从UNKNOWN改为NEUTRAL) ✨
- `firefox.exe` - Firefox ✨

#### 系统工具 (NEUTRAL)
- `explorer.exe` - 文件资源管理器
- `Taskmgr.exe` - 任务管理器 ✨

**总计**: 从12个应用扩展到28个应用配置

---

### 修改2: 为现有用户更新分类

已提供独立的更新脚本 `update_app_categories.py`,可以为现有数据库更新分类配置,无需删除历史数据。

**使用方法**:
```bash
python update_app_categories.py
```

**效果**:
- ✅ 更新11个应用分类
- ✅ 保留所有历史活动记录
- ✅ 重新计算统计数据时会使用新分类

---

## 测试验证

### 测试脚本

1. **`test_activity_debug.py`** - 测试窗口采集功能
   - 验证能否获取活动窗口信息
   - 测试数据库连接
   - 监控5次窗口切换

2. **`check_activity_data.py`** - 检查数据库数据
   - 查看今日活动记录数量
   - 检查应用分类配置
   - 显示统计数据

3. **`update_app_categories.py`** - 更新应用分类
   - 批量更新/添加应用分类
   - 显示更新后的配置列表

### 测试结果

```
Database Check Results:
- Total records today: 30
- Configured apps: 21
- Categories:
  * PRODUCTIVE: 9 apps
  * LEISURE: 8 apps
  * NEUTRAL: 4 apps
  * UNKNOWN: 0 apps (after update)
```

---

## 用户操作指南

### 对于新安装用户

直接使用新版本 `GaiYa-v1.6.exe` (2025-12-01 16:09),已包含完整的28个应用默认配置。

### 对于现有用户

**选项1: 删除数据库重新开始**(推荐)
```
1. 关闭GaiYa应用
2. 删除 C:\Users\<用户名>\AppData\Local\GaiYa\user_data.db
3. 启动新版GaiYa,会自动创建包含新配置的数据库
```

**选项2: 保留历史数据并更新配置**
```
1. 关闭GaiYa应用
2. 运行 update_app_categories.py
3. 启动GaiYa应用
```

### 手动添加自定义应用

1. 打开GaiYa应用
2. 点击"今日时间回放"
3. 点击"行为识别设置"
4. 在应用列表中找到未分类的应用
5. 选择合适的分类(生产力/摸鱼/中性)
6. 点击"保存设置"

---

## 技术细节

### 行为识别工作流程

```
1. ActivityTracker线程启动
   ├─ 每5秒调用get_active_window_info()
   ├─ 获取当前前台窗口的进程名和标题
   └─ 检测窗口是否切换

2. 窗口切换时
   ├─ 保存上一个会话到数据库
   │  └─ 调用save_activity_session()
   │     ├─ 查询app_categories表获取分类
   │     └─ 插入activity_sessions表
   └─ 开始记录新会话

3. 统计查询时
   ├─ 调用get_today_activity_stats()
   ├─ 按category分组统计时长
   └─ 返回各分类的使用时间
```

### 数据库结构

**app_categories表** (应用分类配置)
```sql
CREATE TABLE app_categories (
    process_name TEXT PRIMARY KEY,
    category TEXT NOT NULL,
    is_ignored INTEGER DEFAULT 0
)
```

**activity_sessions表** (活动记录)
```sql
CREATE TABLE activity_sessions (
    id TEXT PRIMARY KEY,
    process_name TEXT NOT NULL,
    window_title TEXT,
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,
    duration_seconds INTEGER NOT NULL,
    category TEXT
)
```

---

## 已知限制

1. **窗口标题变化会触发新会话**: 同一个应用如果标题变化(如浏览器切换标签),会被记录为不同会话,但process_name相同,统计时仍计入同一应用。

2. **最小会话时长**: 小于5秒的会话不会被记录(过滤噪音)。

3. **进程名大小写敏感**: `chrome.exe` 和 `CHROME.EXE` 会被视为不同应用,需要分别配置。

4. **浏览器默认为NEUTRAL**: 因为浏览器可能用于工作也可能用于娱乐,统一分类为"中性",用户可以根据实际情况自行调整。

---

## 打包信息

**最新版本**: `dist/GaiYa-v1.6.exe`
**构建时间**: 2025-12-01 17:10
**文件大小**: 82MB

**变更内容**:
1. ✅ 行为识别默认开启
2. ✅ 扩展默认应用分类(12→29个)
3. ✅ 修正微信进程名(Weixin.exe)
4. ✅ 浏览器分类改为NEUTRAL
5. ✅ **GaiYa自身进程过滤(避免自我追踪)**
6. ✅ 红温专注统计简化
7. ✅ **统计报告对所有用户开放**
8. ✅ 暂时注释火焰标记功能

---

## 相关文件

- `gaiya/data/db_manager.py` - 数据库管理(包含默认分类配置)
- `gaiya/services/activity_tracker.py` - 活动追踪服务
- `gaiya/ui/activity_settings_window.py` - 行为识别设置界面
- `gaiya/ui/time_review_window.py` - 时间回放窗口(显示统计)
- `test_activity_debug.py` - 窗口采集测试脚本
- `check_activity_data.py` - 数据库检查脚本
- `update_app_categories.py` - 分类更新脚本

---

**修复完成** ✅
