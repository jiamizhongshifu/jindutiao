# 支付功能完整测试清单

**测试时间**: 2025-12-04
**测试人**: 用户
**当前会员状态**: Pro (已通过月度套餐测试)

---

## 测试套餐列表

### 1. Pro月度订阅 ✅ (已完成)
- **plan_type**: `pro_monthly`
- **价格**: ¥0.1 (测试价格)
- **预期结果**: `user_tier: "pro"`
- **测试结果**: ✅ 成功
- **测试时间**: 2025-12-04 10:53

### 2. Pro年度订阅 ⏳ (待测试)
- **plan_type**: `pro_yearly`
- **价格**: ¥0.1 (测试价格)
- **预期结果**: `user_tier: "pro"`
- **测试步骤**:
  1. 在应用中选择"Pro年度订阅"
  2. 生成二维码并扫码支付0.1元
  3. 点击"已完成支付"按钮
  4. 验证弹窗显示"Pro年度订阅已成功激活!会员状态已更新"
  5. 验证个人中心显示"高级版"
  6. 重启应用,验证会员状态持久化

### 3. 会员合伙人(终身) ⏳ (待测试)
- **plan_type**: `team_partner`
- **价格**: ¥0.1 (测试价格)
- **预期结果**: `user_tier: "lifetime"`
- **测试步骤**:
  1. 在应用中选择"会员合伙人"
  2. 生成二维码并扫码支付0.1元
  3. 点击"已完成支付"按钮
  4. 验证弹窗显示"会员合伙人已成功激活!会员状态已更新"
  5. 验证个人中心显示"终身会员" (需要确认UI文案)
  6. 重启应用,验证会员状态持久化

---

## 功能验证清单

### A. 二维码生成
- [ ] 月度套餐二维码正常生成
- [ ] 年度套餐二维码正常生成
- [ ] 终身套餐二维码正常生成
- [ ] 二维码可以扫描并跳转到支付页面

### B. 支付流程
- [ ] 支付宝扫码支付正常
- [ ] 支付金额正确 (0.1元测试价格)
- [ ] 支付完成后订单状态正确

### C. 手动确认升级
- [ ] 点击"已完成支付"按钮响应正常
- [ ] 后端API返回成功响应
- [ ] 数据库user_tier字段更新成功
- [ ] 弹窗提示信息正确

### D. 状态刷新
- [ ] 支付成功后自动调用subscription-status API
- [ ] 本地缓存的user_tier更新成功
- [ ] 个人中心显示正确的会员等级
- [ ] 无需手动刷新即可看到更新

### E. 持久化验证
- [ ] 重启应用后会员状态保持
- [ ] 登出再登入后会员状态保持
- [ ] 跨设备登录会员状态一致

### F. 错误处理
- [ ] 支付失败时显示友好提示
- [ ] 网络错误时有重试机制
- [ ] API超时时不影响用户体验
- [ ] 重复点击"已完成支付"按钮不会重复扣款

---

## 后端API验证

### 1. payment-create-order API ✅
- **端点**: `POST /api/payment-create-order`
- **状态**: 正常
- **响应**: 返回二维码URL和订单号

### 2. payment-manual-upgrade API ✅
- **端点**: `POST /api/payment-manual-upgrade`
- **状态**: 正常
- **功能**: 更新users.user_tier字段
- **验证**: Vercel日志显示"User upgraded successfully"

### 3. subscription-status API ✅
- **端点**: `GET /api/subscription-status?user_id=xxx`
- **状态**: 已修复
- **功能**: 从users表读取user_tier
- **验证**: 返回正确的user_tier和is_active

---

## 已知问题

### 1. ~~支付成功后显示free~~ ✅ 已修复
- **问题**: subscription-status API读错表
- **修复**: 直接从users表读取user_tier
- **提交**: commit a79f87d

### 2. ~~支付成功需要手动刷新~~ ✅ 已修复
- **问题**: 支付成功后不自动刷新会员状态
- **修复**: 自动调用get_subscription_status()
- **提交**: commit a9a147b

### 3. 个人中心tab闪退 ⚠️ 待观察
- **状态**: 已添加详细错误日志
- **观察**: 测试时是否还有闪退
- **修复**: commit a9a147b (traceback.print_exc)

---

## 测试环境

- **后端**: Vercel Serverless (已部署最新代码)
- **数据库**: Supabase PostgreSQL
- **支付网关**: Z-Pay (https://zpayz.cn)
- **客户端**: Python源码运行 (python main.py)

---

## 测试注意事项

1. **测试价格**: 所有套餐均为0.1元 (生产环境需改回正式价格)
2. **重复测试**: 可以多次购买同一套餐测试稳定性
3. **日志查看**:
   - 客户端日志: 运行python main.py的控制台
   - 后端日志: Vercel Dashboard → jindutiao → Logs
4. **数据库查询**: 可在Supabase SQL Editor查询users表验证

---

## 下一步

1. ⏳ 测试Pro年度订阅
2. ⏳ 测试会员合伙人(终身)
3. ⏳ 验证会员权益 (AI配额、高级功能等)
4. ⏳ 修改为正式价格
5. ⏳ 生产环境验证
