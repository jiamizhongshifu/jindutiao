# 邮箱验证功能测试指南

> 完整测试新的Supabase邮箱验证功能（注册 → 验证 → 自动登录）

---

## 🎯 测试目标

验证以下功能正常工作：
1. ✅ 用户注册时自动发送Supabase验证邮件
2. ✅ EmailVerificationDialog显示等待界面并轮询检测
3. ✅ 用户点击邮件链接后，数据库触发器更新email_verified
4. ✅ 前端检测到验证成功，自动登录并关闭对话框
5. ✅ 支持任意邮箱（不受Resend测试域名限制）

---

## 📋 测试前准备

### 1. 确认Supabase配置

✅ **已完成：**
- [x] 启用邮箱确认（Authentication → Settings → Enable email confirmations）
- [x] 创建数据库触发器（自动同步email_verified字段）

### 2. 确认部署状态

✅ **后端API已部署：**
- `/api/auth-signup` - 注册API（触发Supabase发送验证邮件）
- `/api/auth-check-verification` - 验证状态检查API

✅ **前端已打包：**
- `dist/GaiYa-v1.5.exe` - 包含EmailVerificationDialog的最新版本

---

## 🧪 完整测试流程

### 测试1：基本注册流程

**步骤：**

1. **启动应用**
   ```bash
   cd dist
   ./GaiYa-v1.5.exe
   ```

2. **打开注册页面**
   - 点击应用右上角的"登录"按钮
   - 在登录对话框中点击"注册"

3. **填写注册信息**
   - 邮箱：`your_email@example.com`（使用真实邮箱）
   - 密码：`test123456`（至少6位）
   - 用户名：`测试用户`（可选）
   - 点击"注册"按钮

**预期结果：**
- ✅ 注册按钮变为"注册中..."（1-2秒）
- ✅ 弹出EmailVerificationDialog（邮箱验证对话框）
- ✅ 对话框显示：
  ```
  📧 验证邮件已发送
  我们已向 your_email@example.com 发送了一封验证邮件。
  请打开您的邮箱，点击邮件中的验证链接完成注册。

  ⏳ 等待邮箱验证...
  [进度条动画]

  💡 小贴士：
  • 请检查垃圾邮件文件夹
  • 验证链接有效期为24小时
  • 如果没有收到邮件，可以点击下方"重新发送"

  [重新发送验证邮件] [取消]
  ```

---

### 测试2：接收验证邮件

**步骤：**

1. **打开邮箱**
   - 登录您注册时使用的邮箱
   - 查找来自Supabase的邮件

2. **检查邮件内容**
   - 发件人：`noreply@mail.app.supabase.io`（默认）
   - 主题：`Confirm Your Signup` 或类似
   - 内容：包含"验证邮箱"按钮或验证链接

**预期结果：**
- ✅ 收到验证邮件（通常1分钟内）
- ✅ 邮件格式正确，包含验证链接

**如果没有收到：**
- 检查垃圾邮件文件夹
- 查看Supabase Dashboard → Logs，确认邮件已发送
- 点击对话框中的"重新发送验证邮件"按钮

---

### 测试3：邮箱验证

**步骤：**

1. **点击验证链接**
   - 在邮件中点击"验证邮箱"按钮或链接
   - 浏览器会打开一个Supabase页面

2. **查看浏览器**
   - 应该看到"Email confirmed"或"邮箱已验证"的提示

**预期结果：**
- ✅ 浏览器显示验证成功页面
- ✅ 回到桌面应用，EmailVerificationDialog的状态**自动更新**：
  ```
  ✅ 邮箱验证成功！
  [进度条消失]
  ```
- ✅ 1-2秒后，弹出成功提示：
  ```
  欢迎！
  欢迎！your_email@example.com

  您已成功注册并登录 GaiYa 每日进度条。
  ```
- ✅ 对话框**自动关闭**
- ✅ 应用右上角显示用户邮箱（已登录状态）

**时间要求：**
- 从点击邮件链接到前端检测到验证成功：**≤ 6秒**（最多2次轮询）

---

### 测试4：验证数据库状态

**步骤：**

1. **登录Supabase Dashboard**
   - 进入 `Table Editor`
   - 选择 `public.users` 表

2. **查找刚注册的用户**
   - 按邮箱搜索：`your_email@example.com`

**预期结果：**
- ✅ 用户记录存在
- ✅ `email_verified` = `TRUE`
- ✅ `status` = `active`
- ✅ `updated_at` 时间戳已更新

---

### 测试5：重新发送验证邮件

**步骤：**

1. **注册新账号**（使用不同邮箱）
2. **不点击验证链接**，在EmailVerificationDialog中点击"重新发送验证邮件"
3. **检查邮箱**，应该收到新的验证邮件

**预期结果：**
- ✅ 显示"发送中..."按钮状态
- ✅ 弹出提示："验证邮件已重新发送，请查收您的邮箱"
- ✅ 收到新的验证邮件

---

### 测试6：取消验证

**步骤：**

1. **注册新账号**
2. **在EmailVerificationDialog中点击"取消"**
3. **确认取消**

**预期结果：**
- ✅ 弹出确认对话框：
  ```
  取消验证
  您确定要取消邮箱验证吗？

  取消后，您需要在验证邮箱后才能登录。
  ```
- ✅ 点击"是"后，对话框关闭
- ✅ 显示提示：
  ```
  注册成功
  您的账号已创建，验证邮件已发送。

  请验证邮箱后登录。如果没有收到邮件，请检查垃圾邮件文件夹。
  ```
- ✅ 用户仍可稍后通过点击邮件链接验证，然后手动登录

---

### 测试7：验证后手动登录

**步骤：**

1. **注册账号并验证邮箱**（点击邮件链接）
2. **取消EmailVerificationDialog**（测试取消按钮）
3. **关闭应用**
4. **重新打开应用**
5. **使用注册的邮箱和密码登录**

**预期结果：**
- ✅ 登录成功（因为邮箱已验证）
- ✅ 应用右上角显示用户邮箱

---

## 🔍 故障排查

### 问题1：没有收到验证邮件

**检查清单：**
1. ✅ Supabase Dashboard → Authentication → Settings
   - "Enable email confirmations" 已勾选
2. ✅ Supabase Dashboard → Logs → Edge Logs
   - 搜索 "email"，查看邮件发送日志
3. ✅ 检查垃圾邮件文件夹
4. ✅ 邮箱地址输入正确

**解决方案：**
- 点击"重新发送验证邮件"按钮
- 如果仍未收到，查看Supabase Logs确认发送状态
- 考虑配置自定义SMTP（见 `SUPABASE_EMAIL_VERIFICATION_SETUP.md`）

---

### 问题2：验证后对话框未自动更新

**症状：** 点击邮件链接后，EmailVerificationDialog仍显示"等待验证..."

**检查：**
1. ✅ 数据库触发器是否创建成功：
   ```sql
   SELECT * FROM information_schema.triggers
   WHERE trigger_name = 'on_email_confirmed';
   ```
2. ✅ 触发器是否执行：
   ```sql
   SELECT email, email_verified, status, updated_at
   FROM public.users
   WHERE email = 'your_email@example.com';
   ```
   - `email_verified` 应该是 `TRUE`
   - `status` 应该是 `active`

3. ✅ API是否返回正确状态：
   - 在对话框显示时，打开 `pydaybar.log`
   - 查找 `[EMAIL-VERIFICATION] 第X次检查验证状态...`
   - 查看API响应是否包含 `"verified": true`

**解决方案：**
- 如果触发器未执行，重新创建触发器（见配置指南）
- 如果API响应缓存，在API中添加 `Cache-Control: no-cache` 头
- 减少轮询间隔到2秒（当前3秒）

---

### 问题3：自动登录失败

**症状：** 验证成功，但提示"自动登录失败"

**原因：**
- 登录API返回错误
- Password参数未正确传递

**检查：**
- 查看日志：`[EMAIL-VERIFICATION] 自动登录错误: xxx`
- 确认注册时传递了password参数

**临时解决：**
- 提示用户手动登录（已实现）

---

### 问题4：验证链接过期

**症状：** 点击链接显示 "Token has expired"

**原因：** Supabase验证链接默认24小时过期

**解决方案：**
- 点击"重新发送验证邮件"获取新链接
- 建议用户尽快完成验证

---

## 📊 测试报告模板

完成测试后，请填写以下报告：

```
## 测试环境
- 操作系统：Windows 10/11
- 应用版本：GaiYa-v1.5
- 测试邮箱：your_email@example.com
- 测试时间：2025-11-11

## 测试结果

### 测试1：基本注册流程
- [ ] ✅ 通过 / [ ] ❌ 失败
- 说明：_____________________

### 测试2：接收验证邮件
- [ ] ✅ 通过 / [ ] ❌ 失败
- 邮件送达时间：_____分钟
- 说明：_____________________

### 测试3：邮箱验证
- [ ] ✅ 通过 / [ ] ❌ 失败
- 自动检测时间：_____秒
- 说明：_____________________

### 测试4：验证数据库状态
- [ ] ✅ 通过 / [ ] ❌ 失败
- 说明：_____________________

### 测试5：重新发送验证邮件
- [ ] ✅ 通过 / [ ] ❌ 失败
- 说明：_____________________

### 测试6：取消验证
- [ ] ✅ 通过 / [ ] ❌ 失败
- 说明：_____________________

### 测试7：验证后手动登录
- [ ] ✅ 通过 / [ ] ❌ 失败
- 说明：_____________________

## 发现的问题

1. _____________________
2. _____________________

## 整体评价

- [ ] 功能完全正常，可以发布
- [ ] 有小问题，但不影响使用
- [ ] 有严重问题，需要修复后再发布
```

---

## 🎉 测试完成后

如果所有测试通过：
1. ✅ 验证功能正常工作
2. ✅ 可以向用户发布新版本
3. ✅ 更新发布说明，告知用户新的验证方式

**发布说明示例：**
```
## GaiYa v1.5 - 邮箱验证升级

### 主要改进
- ✅ 使用Supabase官方邮箱验证，支持任意邮箱
- ✅ 验证体验优化：点击邮件链接即可，无需手动输入验证码
- ✅ 验证成功后自动登录，无需额外操作
- ✅ 支持重新发送验证邮件

### 使用方法
1. 注册时输入您的真实邮箱
2. 打开邮箱，点击验证链接
3. 自动登录，开始使用！
```

---

**创建时间：** 2025-11-11
**测试者：** _____________________
**审核者：** _____________________
