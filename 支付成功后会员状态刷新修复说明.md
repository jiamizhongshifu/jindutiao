# 支付成功后会员状态刷新修复说明

## 问题描述

用户反馈：使用微信支付购买月度会员后,支付成功页面显示"支付成功,3秒后将跳转到商户网站...",但返回个人中心页面后,会员状态没有刷新,仍然显示为免费用户。

## 问题原因分析

### 1. 支付回调流程
```
用户支付 → Z-Pay异步通知 → /api/payment-notify → 更新数据库 → 数据库已更新
                                                              ↓
                                                         客户端不知道
```

**核心问题**: 支付回调是异步的,客户端不会自动知道数据库已经更新。

### 2. 客户端状态管理
- `MembershipDialog` 在检测到支付成功后会发出 `purchase_success` 信号
- 但**没有主动调用** API 刷新会员状态
- 个人中心页面是**延迟加载**且**只加载一次**,之后不会自动刷新

### 3. 时序问题
```
T0: 用户完成支付
T1: 浏览器重定向到商户网站 (支付成功页面)
T2: Z-Pay发起异步回调 (可能需要1-3秒)
T3: /api/payment-notify 处理回调,更新数据库
T4: 用户关闭浏览器,返回应用
```

在 T4 时刻,如果 T3 还未完成,客户端查询到的仍是旧状态。

## 解决方案

### 修复1: 支付成功后自动刷新 (membership_ui.py)

**位置**: `gaiya/ui/membership_ui.py` 第1197-1219行

**改动**:
```python
if status == "paid":
    # 支付成功
    self._stop_payment_polling()

    # ⚠️ 关键修复：支付成功后延迟刷新会员状态
    # 原因：Z-Pay的异步回调可能需要1-3秒才能完成数据库更新
    # 解决方案：等待2秒后刷新,给后端足够的处理时间
    QTimer.singleShot(2000, self._refresh_subscription_status)

    # ... 显示成功消息并关闭对话框
```

**新增方法**: `_refresh_subscription_status()` (第1226-1261行)
- 调用 `auth_client.get_subscription_status()` 获取最新状态
- 如果失败或状态未更新,自动重试 (最多3次,每次间隔1秒)
- 打印详细日志方便调试

**优点**:
- 自动化,无需用户操作
- 有重试机制,提高成功率
- 给后端足够的处理时间 (2秒初始延迟 + 最多3次重试)

### 修复2: 手动刷新按钮 (config_gui.py)

**位置**: `config_gui.py` 第3173-3180行

**改动**: 在个人中心页面头部添加刷新按钮
```python
# 添加刷新按钮（用于支付成功后手动刷新会员状态）
refresh_btn = QPushButton("🔄 " + self.i18n.tr("button.refresh"))
refresh_btn.setToolTip(self.i18n.tr("account.refresh_tooltip"))
refresh_btn.clicked.connect(self._on_refresh_account_clicked)
```

**新增方法**: `_on_refresh_account_clicked()` (第3485-3519行)
- 显示"刷新中"加载对话框
- 使用异步Worker调用API (避免UI卡顿)
- 成功后重新加载个人中心页面
- 失败时显示友好的错误提示

**新增回调方法**:
- `_on_refresh_success()` (第3521-3551行): 处理刷新成功
- `_on_refresh_error()` (第3553-3566行): 处理刷新失败

**优点**:
- 用户可控,支付成功后手动点击刷新
- 异步操作,不会卡UI
- 有明确的加载提示和结果反馈

### 修复3: 国际化翻译

**文件**: `i18n/zh_CN.json` 和 `i18n/en_US.json`

**新增翻译键**:
```json
{
  "account": {
    "refresh_tooltip": "刷新会员状态（支付完成后点击此处更新）"
  }
}
```

英文版:
```json
{
  "account": {
    "refresh_tooltip": "Refresh membership status (Click here after payment)"
  }
}
```

## 使用流程

### 场景1: 自动刷新 (推荐)
1. 用户在个人中心点击"立即购买"
2. 浏览器打开支付页面,完成支付
3. 支付成功后,应用**自动等待2秒**
4. **自动调用API刷新**会员状态
5. 如果首次刷新失败,**自动重试最多3次**
6. 用户返回个人中心,看到最新的会员状态

### 场景2: 手动刷新 (兜底方案)
1. 如果自动刷新失败 (网络问题、回调延迟等)
2. 用户在个人中心看到**"🔄 刷新"按钮**
3. 点击按钮,显示"刷新中..."对话框
4. 刷新成功后,页面自动更新,显示最新会员等级
5. 如果失败,提示用户重试或联系客服

## 技术细节

### 1. 延迟刷新策略
```python
QTimer.singleShot(2000, self._refresh_subscription_status)
```
- 2秒延迟给Z-Pay回调足够的处理时间
- 避免过早查询导致获取旧状态

### 2. 重试机制
```python
retry_count = getattr(self, '_refresh_retry_count', 0)
if retry_count < 3:
    self._refresh_retry_count = retry_count + 1
    QTimer.singleShot(1000, self._refresh_subscription_status)
```
- 最多重试3次,每次间隔1秒
- 总共最多等待 2 + 1 + 1 + 1 = 5秒

### 3. 异步Worker
```python
self._refresh_worker = AsyncNetworkWorker(auth_client.get_subscription_status)
self._refresh_worker.success.connect(lambda result: self._on_refresh_success(result, loading_dialog))
self._refresh_worker.start()
```
- 避免阻塞UI线程
- 使用信号槽机制处理结果

### 4. 页面刷新
```python
# 重新加载个人中心tab以显示最新状态
self.account_tab_widget = None
self._load_account_tab()
```
- 清空旧的widget
- 重新创建页面,显示最新数据

## 日志输出

刷新过程会输出详细日志,方便调试:

```log
[MEMBERSHIP] 开始刷新会员状态...
[MEMBERSHIP] 会员状态刷新成功: tier=pro, active=True
[MEMBERSHIP] ✓ 会员升级确认成功!
```

如果失败:
```log
[MEMBERSHIP] 刷新失败: API未部署
[MEMBERSHIP] 1秒后进行第 1 次重试...
[MEMBERSHIP] ⚠️ 状态异常: tier=free, active=False
[MEMBERSHIP] 1秒后进行第 2 次重试...
```

## 测试方法

### 1. 测试自动刷新
1. 运行开发版: `python main.py`
2. 打开个人中心,点击"立即购买"
3. 完成支付 (可以使用测试环境)
4. 观察控制台输出,确认刷新日志
5. 检查个人中心页面是否显示新的会员等级

### 2. 测试手动刷新
1. 登录应用
2. 在个人中心点击"🔄 刷新"按钮
3. 观察"刷新中..."对话框
4. 确认刷新成功后页面自动更新

### 3. 测试边界情况
- 网络断开时点击刷新 → 应显示网络错误
- API返回失败时 → 应显示具体错误信息
- 多次快速点击刷新 → 不应出现并发问题

## 已知限制

1. **支付回调延迟**: 如果Z-Pay回调延迟超过5秒,自动刷新可能失败,需要手动刷新
2. **网络问题**: 如果用户网络不稳定,刷新可能失败,需要重试
3. **API部署**: 需要确保 `/api/subscription-status` 已部署到生产环境

## 后续优化建议

1. **WebSocket推送**: 后端支付成功后主动推送消息给客户端,无需轮询
2. **本地缓存**: 缓存会员状态,减少API调用
3. **支付状态页**: 在应用内嵌入支付状态页,监听支付结果,避免跳转浏览器

## 版本信息

- **修复版本**: v1.6.8+
- **修复日期**: 2025-12-02
- **影响文件**:
  - `gaiya/ui/membership_ui.py` (新增自动刷新逻辑)
  - `config_gui.py` (新增手动刷新按钮)
  - `i18n/zh_CN.json` (新增翻译)
  - `i18n/en_US.json` (新增翻译)

---

**总结**: 通过"自动刷新 + 手动刷新"的双重保障,确保用户支付成功后能够及时看到会员状态更新。
