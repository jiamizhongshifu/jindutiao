# 紧急修复方案 - 二维码支付

## 🚨 问题现状

测试结果显示:**Z-Pay不发送回调通知**

- ✅ submit.php返回正常支付URL
- ❌ 支付完成后Z-Pay从未发送回调到`/api/payment-notify`
- ❌ 应用一直卡在"等待支付"状态
- ⏱️ 等待时间超过60秒,仍无回调

## 💡 正确的解决方案

**使用mapi.php + 在应用内显示二维码**

### 为什么这是正确方案?

1. **mapi.php创建真实订单** - 订单立即可查询
2. **返回二维码URL** - 这不是bug,这是特性!
3. **应用内显示二维码** - 用户扫码后轮询查询订单状态
4. **不依赖回调** - Z-Pay回调不可靠,不能依赖

### 其他支付工具的常见做法

- 微信支付SDK: 显示二维码,用户扫码
- 支付宝当面付: 显示二维码,用户扫码
- PayPal: 显示二维码供移动设备扫码

**桌面应用调起支付宝网页的方案本身就不常见!**

---

## 🔧 技术实现

### 1. 后端保持使用mapi.php

**文件**: `api/payment-create-order.py`

```python
# 使用mapi.php创建订单
result = zpay.create_api_order(
    out_trade_no=out_trade_no,
    name=plan_info["name"],
    money=plan_info["price"],
    pay_type=pay_type,
    notify_url=notify_url,
    clientip=client_ip,
    param=f"{user_id}|{plan_type}"
)

# 返回二维码URL
return {
    "success": True,
    "qrcode_url": result.get("payurl"),  # 二维码URL
    "out_trade_no": out_trade_no,
    "trade_no": result.get("trade_no"),
    "amount": plan_info["price"]
}
```

### 2. 客户端显示二维码

**文件**: `gaiya/ui/membership_ui.py`

```python
def _handle_payment_success(self, result):
    """处理支付订单创建成功"""
    if result.get("success"):
        qrcode_url = result.get("qrcode_url")
        out_trade_no = result.get("out_trade_no")

        # 显示二维码对话框
        self._show_qrcode_dialog(qrcode_url, out_trade_no)

        # 开始轮询查询订单状态(延迟5秒)
        QTimer.singleShot(5000, lambda: self._start_payment_polling(out_trade_no))

def _show_qrcode_dialog(self, qrcode_url: str, out_trade_no: str):
    \"\"\"显示二维码支付对话框\"\"\"
    from PySide6.QtGui import QPixmap
    from PySide6.QtNetwork import QNetworkAccessManager, QNetworkRequest

    # 创建对话框
    dialog = QDialog(self)
    dialog.setWindowTitle("扫码支付")
    dialog.setFixedSize(400, 500)

    layout = QVBoxLayout(dialog)

    # 提示文本
    label = QLabel("请使用支付宝扫描二维码完成支付")
    label.setAlignment(Qt.AlignCenter)
    layout.addWidget(label)

    # 二维码图片
    qr_label = QLabel()
    qr_label.setAlignment(Qt.AlignCenter)
    layout.addWidget(qr_label)

    # 下载二维码图片
    manager = QNetworkAccessManager()
    request = QNetworkRequest(QUrl(qrcode_url))

    def on_finished(reply):
        data = reply.readAll()
        pixmap = QPixmap()
        pixmap.loadFromData(data)
        qr_label.setPixmap(pixmap.scaled(300, 300, Qt.KeepAspectRatio))

    reply = manager.get(request)
    reply.finished.connect(lambda: on_finished(reply))

    # 订单信息
    info_label = QLabel(f"订单号: {out_trade_no}\n金额: ¥{self.selected_plan_price}")
    info_label.setAlignment(Qt.AlignCenter)
    layout.addWidget(info_label)

    # 提示
    tip_label = QLabel("支付完成后会自动关闭此窗口")
    tip_label.setAlignment(Qt.AlignCenter)
    layout.addWidget(tip_label)

    # 保存对话框引用
    self.qrcode_dialog = dialog
    dialog.show()
```

### 3. 轮询查询订单状态

```python
def _start_payment_polling(self, out_trade_no: str):
    \"\"\"开始轮询订单状态\"\"\"
    self.payment_timer = QTimer()
    self.payment_timer.setInterval(3000)  # 每3秒查询
    self.payment_timer.timeout.connect(lambda: self._check_payment_status(out_trade_no))
    self.payment_timer.start()

    print(f"[MEMBERSHIP] Started polling for order: {out_trade_no}")

def _check_payment_status(self, out_trade_no: str):
    \"\"\"检查支付状态\"\"\"
    result = self.auth_client.query_payment_order(out_trade_no)

    if result.get("success"):
        order = result.get("order", {})
        status = order.get("status")

        if status == "paid":
            print(f"[MEMBERSHIP] Payment successful: {out_trade_no}")

            # 停止轮询
            self.payment_timer.stop()

            # 关闭二维码对话框
            if hasattr(self, 'qrcode_dialog'):
                self.qrcode_dialog.close()

            # 触发手动升级
            self._trigger_manual_upgrade(out_trade_no)

            # 显示成功消息
            QMessageBox.information(self, "支付成功", "会员已成功激活!")

            # 刷新会员信息
            self._load_membership_info()
```

---

## 🎯 优势

### 相比回调方案

| 特性 | 回调方案 | 二维码方案 |
|------|---------|----------|
| **可靠性** | ❌ Z-Pay不发送回调 | ✅ 主动查询,完全可控 |
| **用户体验** | ❌ 永远等待 | ✅ 实时反馈 |
| **订单可查询** | ❌ submit.php不创建订单 | ✅ mapi.php立即创建 |
| **支付方式** | 需要跳转浏览器 | 扫码即可(手机已登录支付宝) |

### 相比submit.php网页方案

| 特性 | 网页跳转 | 二维码扫码 |
|------|---------|----------|
| **便捷性** | 需要切换到浏览器 | 手机扫码更快 |
| **安全性** | 浏览器环境复杂 | 支付宝APP内完成 |
| **成功率** | 依赖浏览器环境 | 依赖手机支付宝(通常已登录) |

---

## 📦 实施步骤

### 1. 修改后端 (已有代码,只需恢复)

回退到commit c052ba3的`payment-create-order.py`:

```bash
git show c052ba3:api/payment-create-order.py > api/payment-create-order.py
```

### 2. 修改客户端

添加二维码显示功能到`gaiya/ui/membership_ui.py`

### 3. 测试流程

1. 点击"前往支付"
2. 应用内弹出二维码对话框
3. 用手机支付宝扫码支付
4. 支付完成后对话框自动关闭
5. 显示"支付成功"提示
6. 会员状态更新

---

## 🤔 为什么之前没想到这个方案?

**误解**: 认为二维码URL是"错误"的返回值

**事实**:
- mapi.php就是设计用于生成二维码支付的
- 桌面应用显示二维码是**标准做法**
- 浏览器跳转方案才是非主流方案

**参考案例**:
- 微信PC客户端充值: 显示二维码
- QQ PC客户端充值: 显示二维码
- Steam PC客户端: 支付宝支付显示二维码

---

## ⏰ 预计工作量

- **后端修改**: 5分钟(回退代码)
- **客户端添加二维码显示**: 30分钟
- **测试**: 10分钟
- **总计**: 约45分钟

---

## 🎯 立即行动?

这是目前**唯一可靠的方案**,因为:

1. ✅ mapi.php创建真实可查询订单
2. ✅ 不依赖Z-Pay回调(已证明不可靠)
3. ✅ 用户体验良好(扫码比跳转浏览器更方便)
4. ✅ 符合主流桌面应用支付方式

**建议**: 立即实施此方案

---

**创建时间**: 2025-12-03 20:52
**优先级**: 🔴 紧急
**状态**: 📋 方案已完成,等待实施确认
