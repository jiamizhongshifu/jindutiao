# 🔴 支付回调未触发的根本原因

## 问题确认

经过深入排查,**找到了根本原因**:

### Z-Pay商户凭证配置错误

**错误信息**:
```
商户pid不存在或key错误,请检查
```

**影响**:
- ❌ Z-Pay查询API返回错误
- ❌ 支付回调无法正常工作
- ❌ 即使用户完成支付,后端也无法验证和处理

## 🔍 技术分析

### 1. 代码层面 (正常)

`api/zpay_manager.py` 正确地从环境变量读取凭证:

```python
ZPAY_PID = os.getenv("ZPAY_PID")    # 商户ID
ZPAY_PKEY = os.getenv("ZPAY_PKEY")  # 商户密钥
```

### 2. Vercel环境变量 (异常)

**问题所在**: Vercel项目的环境变量可能配置了**占位符或错误的值**。

从文档 `docs/pay.md` 可以看到:
```
⚠️ **安全警告**: 以下凭证为示例值，请替换为你的真实凭证
商户ID（PID）：your_merchant_id_here
商户密钥（PKEY）：your_merchant_key_here
```

**很可能**: Vercel环境变量仍然配置为这些占位符值,而不是真实的Z-Pay商户凭证。

## ✅ 解决方案

### 第一步: 获取真实的Z-Pay商户凭证

1. **登录Z-Pay商户后台**
   - 地址: https://zpayz.cn/
   - 使用您的商户账号登录

2. **获取商户ID和密钥**
   - 进入 **系统设置** 或 **API配置**
   - 找到:
     - **商户ID (PID)**: 一串数字或字母数字组合
     - **商户密钥 (PKEY/KEY)**: 一串32位随机字符

   **示例格式**:
   ```
   PID: 20220715225121
   PKEY: 89unJUB8HZ54Hj7x4nUj56HN4nUzUJ8i
   ```

3. **同时检查异步通知地址**
   - 在同一页面找到 **异步通知地址** 设置
   - 设置为: `https://jindutiao.vercel.app/api/payment-notify`
   - 这是回调URL的全局配置

### 第二步: 在Vercel配置环境变量

1. **访问Vercel项目设置**
   - 进入: https://vercel.com/jindutiao
   - 点击 **Settings** → **Environment Variables**

2. **添加/更新环境变量**

   添加以下两个变量(如果已存在则更新):

   **变量1**:
   ```
   Name: ZPAY_PID
   Value: [从Z-Pay后台复制的真实商户ID]
   Environment: Production, Preview, Development (全选)
   ```

   **变量2**:
   ```
   Name: ZPAY_PKEY
   Value: [从Z-Pay后台复制的真实商户密钥]
   Environment: Production, Preview, Development (全选)
   ```

3. **保存后重新部署**
   - 环境变量更新后,Vercel需要重新部署才能生效
   - 方法1: 在Vercel Deployments页面点击 "Redeploy"
   - 方法2: 推送一个新的commit触发自动部署

### 第三步: 验证配置

配置完成并重新部署后,运行测试脚本验证:

```bash
# 查询订单测试 (应该返回订单信息而不是"pid错误")
python test_query_zpay_order.py GAIYA1764727660522308748

# 创建新订单测试
python test_api_payment.py
```

如果配置正确,应该看到:
- ✅ 查询订单返回订单详情而非"pid错误"
- ✅ 创建订单成功
- ✅ 完成支付后,Vercel日志出现 `[PAYMENT-NOTIFY]`
- ✅ 会员状态正常更新

## 📋 检查清单

配置Z-Pay时需要确认的事项:

- [ ] 获取真实的Z-Pay商户ID (PID)
- [ ] 获取真实的Z-Pay商户密钥 (PKEY)
- [ ] 在Vercel配置 `ZPAY_PID` 环境变量
- [ ] 在Vercel配置 `ZPAY_PKEY` 环境变量
- [ ] 在Z-Pay后台设置异步通知地址: `https://jindutiao.vercel.app/api/payment-notify`
- [ ] Vercel重新部署生效
- [ ] 运行测试脚本验证配置

## 🎯 预期效果

配置正确后的支付流程:

1. **用户发起支付**
   - 客户端调用 `/api/payment-create-order`
   - 创建订单成功,返回支付链接

2. **用户完成支付**
   - 打开支付链接,完成微信/支付宝支付
   - Z-Pay接收到支付成功通知

3. **Z-Pay发送回调**
   - Z-Pay向 `https://jindutiao.vercel.app/api/payment-notify` 发送GET请求
   - Vercel日志出现 `[PAYMENT-NOTIFY] ========== NEW NOTIFICATION ==========`

4. **后端处理回调**
   - 验证签名 → 检查支付状态 → 解析用户信息
   - 更新Supabase数据库中的用户会员等级
   - 返回 "success" 给Z-Pay

5. **客户端检测更新**
   - 轮询检测到支付成功
   - 自动刷新会员状态显示
   - 用户看到会员等级已升级 ✅

## 🆘 如果仍然无法解决

如果配置凭证后问题仍然存在:

1. **检查Z-Pay商户账户状态**
   - 账户是否已实名认证
   - 账户是否正常启用
   - 是否有API调用限制

2. **联系Z-Pay技术支持**
   - 提供商户ID
   - 说明"回调通知未发送"问题
   - 请求检查商户配置

3. **临时解决方案**
   - 使用 `manual_upgrade.py` 手动升级账户
   - 或实现主动查询方案(客户端定期查询订单状态)

## 📞 需要的信息

为了帮助您完成配置,请提供:

1. **Z-Pay商户ID (PID)** - 可以公开,用于标识商户
2. **Z-Pay商户密钥 (PKEY)** - ⚠️ 敏感信息,**不要**在聊天中发送
3. **Vercel环境变量截图** - 确认 `ZPAY_PID` 和 `ZPAY_PKEY` 已配置

配置完成后,我们可以立即测试验证。
