# GaiYa 内存基准测试指南

**生成时间**: 2025-11-10
**测试版本**: GaiYa-v1.5.exe (包含P0/P1/P2内存优化)
**测试目的**: 验证内存优化的实际效果

---

## 测试环境

**系统要求**:
- Windows 10/11
- 任务管理器（性能监控工具）
- 测试时长：30-60分钟

**关闭干扰**:
- 关闭其他大型应用
- 禁用自动更新
- 确保充足磁盘空间

---

## 测试步骤

### 阶段1: 初始基准测试 (前10分钟)

**1. 启动应用**
```bash
cd dist
./GaiYa-v1.5.exe
```

**2. 打开任务管理器监控内存**
- 按 `Ctrl+Shift+Esc` 打开任务管理器
- 切换到"详细信息"选项卡
- 找到 `GaiYa-v1.5.exe` 进程
- 右键 → 添加列 → 选择"工作集(内存)"、"峰值工作集(内存)"

**3. 记录初始内存 (应用启动后立即记录)**
- 初始内存: _______ MB
- 时间: _______

**预期值**: 80-100MB

---

### 阶段2: 标准操作序列 (重复3次)

**操作序列A: 配置窗口压力测试**
1. 点击系统托盘图标 → "配置"
2. 等待配置窗口完全打开
3. 切换到"主题与外观"页签
4. 切换到"AI任务规划"页签
5. 切换到"统计数据"页签
6. 关闭配置窗口
7. **记录内存**: _______ MB (时间: _______)

**操作序列B: AI生成任务测试**
1. 打开配置窗口
2. 进入"AI任务规划"页签
3. 点击"智能生成任务"
4. 等待任务生成完成
5. 点击"保存所有"
6. 关闭配置窗口
7. **记录内存**: _______ MB (时间: _______)

**操作序列C: 主题切换测试**
1. 打开配置窗口
2. 进入"主题与外观"页签
3. 依次选择3个不同的预设主题，每次保存
4. 关闭配置窗口
5. **记录内存**: _______ MB (时间: _______)

---

### 阶段3: 长时间稳定性测试 (30分钟)

**持续监控**:
- 每10分钟记录一次内存使用
- 不进行任何操作，让应用自然运行
- 观察内存是否持续增长

**记录表**:
| 时间 | 内存使用 (MB) | 增长率 | 备注 |
|------|---------------|--------|------|
| 0分钟 | _______ | - | 基准 |
| 10分钟 | _______ | ___% | |
| 20分钟 | _______ | ___% | |
| 30分钟 | _______ | ___% | |

**预期结果**:
- 30分钟内存增长 < 20%
- 无明显持续上升趋势
- 峰值内存 < 200MB

---

## 结果评估

### ✅ 成功标准

**P0级标准 (必须满足)**:
- ✅ 初始内存 ≤ 100MB
- ✅ 30分钟后内存 ≤ 150MB
- ✅ 峰值内存 ≤ 200MB
- ✅ 无内存持续增长趋势（增长率<5%/10分钟）

**P1级标准 (期望满足)**:
- ✅ 配置窗口重复开关10次，内存增长 < 10MB
- ✅ AI生成任务3次，内存增长 < 20MB
- ✅ 主题切换10次，内存增长 < 5MB

**P2级标准 (优秀表现)**:
- ✅ 运行1小时后内存 ≤ 150MB
- ✅ 无任何内存泄漏警告
- ✅ 应用关闭后进程立即终止

### ❌ 失败标准

如果出现以下任一情况，说明优化未达预期:
- ❌ 初始内存 > 120MB
- ❌ 30分钟后内存 > 200MB
- ❌ 峰值内存 > 300MB
- ❌ 内存持续增长（每10分钟增长>10%）
- ❌ 应用关闭后进程未终止（资源未释放）

---

## 对比基准

**修复前 (v1.4.x) 预估数据**:
- 初始内存: ~100MB
- 30分钟后: ~200-250MB (持续增长)
- 峰值内存: ~300MB+
- 配置窗口10次开关: +30-50MB (泄漏)
- AI生成3次: +40-60MB (泄漏)

**修复后 (v1.5) 目标数据**:
- 初始内存: 80-100MB
- 30分钟后: 100-130MB (稳定)
- 峰值内存: <200MB
- 配置窗口10次开关: +5-10MB (正常缓存)
- AI生成3次: +10-15MB (正常缓存)

**预期改善**:
- 内存使用降低: **40-50%**
- 内存泄漏消除: **90%+**
- 长时间稳定性: **显著提升**

---

## 修复内容回顾

本次测试验证以下修复的效果:

**P0级 (关键内存泄漏)**:
1. ✅ QTimer closeEvent cleanup (配置窗口)
2. ✅ HealthCheckWorker 清理
3. ✅ QuotaCheckWorker 清理
4. ✅ AIWorker 清理
5. ✅ QMovie cached frames cleanup (标记动画)
6. ✅ Lambda circular references (28处)

**P1级 (重要改进)**:
1. ✅ statistics.json 自动清理 (防止无限增长)

**P2级 (代码质量)**:
1. ✅ 8处空except块修复 (提升调试能力)

---

## 常见问题

**Q: 内存使用比预期高怎么办？**
A: 首先确认是否有其他进程占用。如果确认是GaiYa，查看日志文件 `gaiya.log` 寻找异常。

**Q: 如何判断内存泄漏？**
A: 关键指标是"持续增长"。正常的内存波动是正常的，但如果30分钟内持续上升且无法回落，则可能存在泄漏。

**Q: 应用关闭后进程仍在运行？**
A: 这是严重问题！检查任务管理器，手动结束进程，并记录此问题。

**Q: 测试中应用崩溃？**
A: 记录崩溃时的操作和日志文件，这是需要立即修复的问题。

---

## 测试报告模板

测试完成后，请填写以下报告:

```
# GaiYa v1.5 内存基准测试报告

**测试日期**: _______
**测试人员**: _______
**系统环境**: Windows __ (版本: ______)

## 测试结果

### 初始内存
- 启动后内存: _______ MB
- 符合预期: [ ] 是 [ ] 否

### 标准操作序列
- 配置窗口3次: _______ → _______ MB (增长: +___MB)
- AI生成3次: _______ → _______ MB (增长: +___MB)
- 主题切换: _______ → _______ MB (增长: +___MB)

### 长时间稳定性
- 30分钟后内存: _______ MB
- 峰值内存: _______ MB
- 增长趋势: [ ] 稳定 [ ] 持续增长 [ ] 波动

### 整体评价
- [ ] ✅ 通过 (满足所有P0标准)
- [ ] ⚠️ 部分通过 (满足P0，部分P1未达标)
- [ ] ❌ 失败 (未满足P0标准)

### 问题记录
(如有问题请详细描述)
_______________________________________
_______________________________________

### 建议
_______________________________________
_______________________________________
```

---

## 下一步

**如果测试通过**:
- ✅ 进入阶段4-3: 性能监控仪表板开发
- ✅ 或进入阶段5: 文档化与交付

**如果测试失败**:
- ❌ 分析失败原因
- ❌ 定位问题代码
- ❌ 修复并重新测试

**联系方式**:
如有问题，请查看 `gaiya.log` 日志文件，或在GitHub Issues反馈。
