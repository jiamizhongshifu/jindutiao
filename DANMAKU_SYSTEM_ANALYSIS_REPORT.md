# GaiYa å¼¹å¹•ç³»ç»Ÿå¼€å‘åˆ†ææŠ¥å‘Š

> **æŠ¥å‘Šæ—¥æœŸ**: 2025-12-08
> **ç‰ˆæœ¬**: v1.6.11
> **ä½œè€…**: Claude AI Assistant

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#-é¡¹ç›®æ¦‚è¿°)
2. [å¼€å‘å†ç¨‹](#-å¼€å‘å†ç¨‹)
3. [å½“å‰å®ç°](#-å½“å‰å®ç°)
4. [æŠ€æœ¯æ¶æ„](#-æŠ€æœ¯æ¶æ„)
5. [åŠŸèƒ½è¯¦è§£](#-åŠŸèƒ½è¯¦è§£)
6. [ä»£ç è´¨é‡åˆ†æ](#-ä»£ç è´¨é‡åˆ†æ)
7. [æ€§èƒ½è¯„ä¼°](#-æ€§èƒ½è¯„ä¼°)
8. [ç”¨æˆ·ä½“éªŒ](#-ç”¨æˆ·ä½“éªŒ)
9. [æœªæ¥è§„åˆ’](#-æœªæ¥è§„åˆ’)
10. [æ€»ç»“ä¸å»ºè®®](#-æ€»ç»“ä¸å»ºè®®)

---

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

### èƒŒæ™¯

GaiYaæ¯æ—¥è¿›åº¦æ¡æ˜¯ä¸€æ¬¾æ¡Œé¢æ—¶é—´ç®¡ç†å·¥å…·,å¼¹å¹•ç³»ç»Ÿä½œä¸ºå…¶ç‰¹è‰²åŠŸèƒ½ä¹‹ä¸€,æ—¨åœ¨é€šè¿‡Bilibilié£æ ¼çš„æ»šåŠ¨å¼¹å¹•ä¸ºç”¨æˆ·æä¾›å®æ—¶çš„ä»»åŠ¡æé†’ã€æ¿€åŠ±ä¿¡æ¯å’Œè¿›åº¦åé¦ˆã€‚

### ç›®æ ‡

- **æå‡äº’åŠ¨æ€§**: è®©é™æ€çš„è¿›åº¦æ¡"æ´»èµ·æ¥"
- **ä¸ªæ€§åŒ–æç¤º**: æ ¹æ®ç”¨æˆ·ä»»åŠ¡åŠ¨æ€ç”Ÿæˆç›¸å…³å†…å®¹
- **è¶£å‘³æ€§**: å¢åŠ äº§å“çš„è¶£å‘³æ€§å’Œå¸å¼•åŠ›
- **å¤šæ ·æ€§**: é¿å…é‡å¤å†…å®¹,ä¿æŒæ–°é²œæ„Ÿ

---

## ğŸ“… å¼€å‘å†ç¨‹

### Phase 1: åˆå§‹ç‰ˆæœ¬ (v1.6.0ä¹‹å‰)

**ç‰¹ç‚¹**:
- åŸºç¡€å¼¹å¹•åŠŸèƒ½
- å›ºå®šå†…å®¹åº“(~150æ¡)
- 11ç§ä»»åŠ¡åˆ†ç±»
- ç®€å•çš„éšæœºé€‰æ‹©

**é—®é¢˜**:
1. âŒ å†…å®¹é‡å¤ç‡é«˜
2. âŒ å‡ºç°æ–¹å¼è¿‡äºæœºæ¢°
3. âŒ ä¸ç”¨æˆ·ä»»åŠ¡å…³è”æ€§å¼±
4. âŒ ç¼ºä¹ä¸ªæ€§åŒ–

### Phase 2: å…¨é¢å‡çº§ (v1.6.11)

**æ ¸å¿ƒæ”¹è¿›**:

#### 1ï¸âƒ£ å†…å®¹åº“å¤§æ‰©å…… (4.2xå¢é•¿)

| åˆ†ç±» | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ | å¢é•¿ç‡ |
|------|--------|--------|--------|
| workå·¥ä½œ | 10 | 50 | +400% |
| studyå­¦ä¹  | 10 | 50 | +400% |
| restä¼‘æ¯ | 10 | 50 | +400% |
| exerciseè¿åŠ¨ | 10 | 50 | +400% |
| meetingä¼šè®® | 10 | 50 | +400% |
| mealç”¨é¤ | 10 | 50 | +400% |
| commuteé€šå‹¤ | 4 | 20 | +400% |
| commute_morningæ—©é«˜å³° | 10 | 40 | +300% |
| commute_eveningæ™šé«˜å³° | 10 | 40 | +300% |
| entertainmentå¨±ä¹ | 10 | 50 | +400% |
| sleepç¡çœ  | 10 | 50 | +400% |
| defaulté»˜è®¤ | 15 | 50 | +233% |
| motivationalåŠ±å¿— | 15 | 50 | +233% |
| **æ€»è®¡** | **~150** | **~630** | **+320%** |

#### 2ï¸âƒ£ æ¨¡æ¿åŒ–å¼¹å¹•ç³»ç»Ÿ

**å¼•å…¥åŠ¨æ€å˜é‡**:
- `{task_name}`: å½“å‰ä»»åŠ¡åç§°
- `{elapsed}`: å·²ç”¨æ—¶é—´(åˆ†é’Ÿ)
- `{remaining}`: å‰©ä½™æ—¶é—´(åˆ†é’Ÿ)
- `{progress}`: å®Œæˆç™¾åˆ†æ¯”(0-100)
- `{time_period}`: æ—¶é—´æ®µ(æ—©æ™¨/ä¸Šåˆ/ä¸‹åˆ/æ™šä¸Š/æ·±å¤œ)

**ç¤ºä¾‹**:
```json
{
  "work": [
    "ã€Œ{task_name}ã€å·²å®Œæˆ{progress}%,è¿˜å‰©{remaining}åˆ†é’Ÿ",
    "{time_period}æ—¶å…‰,ä¸“æ³¨å·¥ä½œæ•ˆç‡æœ€é«˜",
    "å·²ç»åŠªåŠ›äº†{elapsed}åˆ†é’Ÿ,ç»§ç»­åŠ æ²¹!"
  ]
}
```

#### 3ï¸âƒ£ æ™ºèƒ½é˜²é‡å¤æœºåˆ¶

**å®ç°æ–¹å¼**:
- ç»´æŠ¤20æ¡å†å²è®°å½•çš„æ»šåŠ¨ç¼“å†²åŒº
- è‡ªåŠ¨è¿‡æ»¤å·²æ˜¾ç¤ºå†…å®¹
- æ™ºèƒ½æ¸…ç†ç­–ç•¥(å½“å¯é€‰å†…å®¹<5æ—¶æ¸…ç†æ—§å†å²)

**æ•ˆæœ**:
- çŸ­æœŸå†…ä¸ä¼šçœ‹åˆ°é‡å¤å†…å®¹
- é•¿æœŸä¿æŒå¤šæ ·æ€§

#### 4ï¸âƒ£ éšæœºæ€§ä¼˜åŒ–

**æ—¶é—´éšæœºåŒ–**:
- ç”Ÿæˆé—´éš”: åŸºå‡†é¢‘ç‡ Â± 30%
- ä¾‹: 30ç§’ â†’ 21-39ç§’éšæœº

**ä½ç½®éšæœºåŒ–**:
- Yè½´åç§»: Â±15px
- é¿å…è½¨è¿¹è¿‡äºå›ºå®š

**ä¿æŒç¨³å®š**:
- âœ… é€Ÿåº¦ä¸å˜
- âœ… å­—ä½“å¤§å°ä¸å˜
- âœ… ç¡®ä¿é˜…è¯»ä½“éªŒ

---

## ğŸ’» å½“å‰å®ç°

### æ–‡ä»¶ç»“æ„

```
gaiya/
â”œâ”€â”€ core/
â”‚   â””â”€â”€ danmaku_manager.py        # æ ¸å¿ƒç®¡ç†å™¨ (465è¡Œ)
â”œâ”€â”€ data/
â”‚   â””â”€â”€ danmaku_presets.json      # å†…å®¹åº“ (628è¡Œ, ~630æ¡å†…å®¹)
â””â”€â”€ ui/
    â””â”€â”€ style_manager.py           # æ ·å¼ç®¡ç†(åŒ…å«å¼¹å¹•æ ·å¼)
```

### æ ¸å¿ƒç±»

#### 1. `Danmaku` ç±»

**èŒè´£**: å•æ¡å¼¹å¹•å¯¹è±¡

**å±æ€§**:
```python
- id: str                    # å”¯ä¸€æ ‡è¯†
- content: str               # å¼¹å¹•å†…å®¹
- x: float                   # Xåæ ‡
- y: float                   # Yåæ ‡
- speed: float               # ç§»åŠ¨é€Ÿåº¦
- color: str                 # é¢œè‰²(åå…­è¿›åˆ¶)
- font_size: int             # å­—ä½“å¤§å°
- opacity: float             # é€æ˜åº¦(0-1)
```

**æ–¹æ³•**:
- `update(delta_time: float)`: æ›´æ–°ä½ç½®
- `is_offscreen()`: åˆ¤æ–­æ˜¯å¦ç¦»å±

#### 2. `DanmakuManager` ç±»

**èŒè´£**: å¼¹å¹•ç³»ç»Ÿç®¡ç†

**æ ¸å¿ƒå±æ€§**:
```python
# åŸºç¡€é…ç½®
- enabled: bool              # å¯ç”¨çŠ¶æ€
- frequency: int             # ç”Ÿæˆé¢‘ç‡(ç§’)
- speed_multiplier: float    # é€Ÿåº¦å€ç‡
- font_size: int             # å­—ä½“å¤§å°
- opacity: float             # é€æ˜åº¦
- max_count: int             # æœ€å¤§æ•°é‡
- y_offset: int              # Yè½´åç§»

# æ•°æ®ç®¡ç†
- danmakus: List[Danmaku]    # å½“å‰å¼¹å¹•åˆ—è¡¨
- presets: Dict[str, List[str]]  # é¢„è®¾å†…å®¹åº“

# æ–°å¢åŠŸèƒ½(v1.6.11)
- recent_history: List[str]  # é˜²é‡å¤å†å²(20æ¡)
- current_task_name: str     # å½“å‰ä»»åŠ¡åç§°
- current_task_start_time: int   # ä»»åŠ¡å¼€å§‹æ—¶é—´
- current_task_end_time: int     # ä»»åŠ¡ç»“æŸæ—¶é—´
```

**æ ¸å¿ƒæ–¹æ³•**:

| æ–¹æ³• | åŠŸèƒ½ | å¤æ‚åº¦ |
|------|------|--------|
| `_load_presets()` | åŠ è½½é¢„è®¾å†…å®¹ | O(n) |
| `get_task_category()` | è¯†åˆ«ä»»åŠ¡åˆ†ç±» | O(n) |
| `should_spawn_danmaku()` | åˆ¤æ–­æ˜¯å¦ç”Ÿæˆ | O(1) |
| `spawn_danmaku()` | ç”Ÿæˆæ–°å¼¹å¹• | O(1) |
| `update()` | æ›´æ–°æ‰€æœ‰å¼¹å¹• | O(n) |
| `render()` | æ¸²æŸ“å¼¹å¹• | O(n) |
| `_update_current_task_info()` | æ›´æ–°ä»»åŠ¡ä¿¡æ¯ | O(n) |
| `_select_non_repeat_content()` | é˜²é‡å¤é€‰æ‹© | O(n) |
| `_apply_template()` | æ¨¡æ¿å˜é‡æ›¿æ¢ | O(m) |
| `_add_to_history()` | æ·»åŠ å†å²è®°å½• | O(1) |

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ProgressBar (ä¸»çª—å£)             â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   DanmakuManager               â”‚    â”‚
â”‚  â”‚                                 â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  Content Management      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - Load presets          â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - Category detection    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - Template system       â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                 â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  Anti-Repeat System      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - History buffer(20)    â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - Smart filtering       â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                 â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  Rendering Engine        â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - Position calc         â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - Random offset         â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - QPainter drawing      â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Config (config.json)         â”‚    â”‚
â”‚  â”‚   - enabled                     â”‚    â”‚
â”‚  â”‚   - frequency: 30               â”‚    â”‚
â”‚  â”‚   - speed: 0.8                  â”‚    â”‚
â”‚  â”‚   - font_size: 14               â”‚    â”‚
â”‚  â”‚   - opacity: 0.7                â”‚    â”‚
â”‚  â”‚   - max_count: 3                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
1. åŠ è½½é˜¶æ®µ
   config.json â†’ DanmakuManager.__init__()
   danmaku_presets.json â†’ _load_presets()

2. è¿è¡Œæ—¶å¾ªç¯ (æ¯å¸§)
   ProgressBar.paintEvent()
   â”œâ”€ should_spawn_danmaku()
   â”‚  â””â”€ æ£€æŸ¥æ—¶é—´é—´éš” + éšæœºåç§»
   â”‚
   â”œâ”€ spawn_danmaku()
   â”‚  â”œâ”€ get_task_category() â†’ è¯†åˆ«ä»»åŠ¡ç±»å‹
   â”‚  â”œâ”€ _update_current_task_info() â†’ ç¼“å­˜ä»»åŠ¡ä¿¡æ¯
   â”‚  â”œâ”€ _select_non_repeat_content() â†’ æ™ºèƒ½é€‰æ‹©
   â”‚  â”œâ”€ _apply_template() â†’ å˜é‡æ›¿æ¢
   â”‚  â”œâ”€ _add_to_history() â†’ è®°å½•å†å²
   â”‚  â””â”€ åˆ›å»º Danmaku å¯¹è±¡
   â”‚
   â”œâ”€ update(delta_time)
   â”‚  â”œâ”€ æ›´æ–°æ¯æ¡å¼¹å¹•ä½ç½®
   â”‚  â””â”€ ç§»é™¤ç¦»å±å¼¹å¹•
   â”‚
   â””â”€ render(painter)
      â””â”€ ç»˜åˆ¶æ‰€æœ‰å¯è§å¼¹å¹•
```

---

## âš™ï¸ åŠŸèƒ½è¯¦è§£

### 1. å†…å®¹åˆ†ç±»ç³»ç»Ÿ

**åˆ†ç±»é€»è¾‘** (`get_task_category`):

```python
def get_task_category(self, tasks: List[Dict],
                     current_time_percentage: float) -> str:
    # 1. è·å–å½“å‰ä»»åŠ¡
    current_task = find_current_task(tasks, current_time_percentage)

    # 2. å…³é”®è¯åŒ¹é…
    if 'å·¥ä½œ' in task_name or 'work' in task_name:
        return "work"
    elif 'å­¦ä¹ ' in task_name or 'study' in task_name:
        return "study"
    # ... æ›´å¤šåˆ†ç±»

    # 3. æ—¶é—´æ®µç‰¹æ®Šå¤„ç†
    hour = int(current_time_percentage * 24)
    if 7 <= hour < 9:
        return "commute_morning"  # æ—©é«˜å³°
    elif 17 <= hour < 19:
        return "commute_evening"  # æ™šé«˜å³°

    # 4. é»˜è®¤åˆ†ç±»
    return "default"
```

**åˆ†ç±»æ˜ å°„è¡¨**:

| åˆ†ç±»ID | å…³é”®è¯ | å†…å®¹æ•° | é¢œè‰² |
|--------|--------|--------|------|
| work | å·¥ä½œã€workã€åŠå…¬ | 50 | #4CAF50 |
| study | å­¦ä¹ ã€studyã€è¯»ä¹¦ | 50 | #2196F3 |
| rest | ä¼‘æ¯ã€restã€æ”¾æ¾ | 50 | #FFC107 |
| exercise | è¿åŠ¨ã€exerciseã€å¥èº« | 50 | #F44336 |
| meeting | ä¼šè®®ã€meeting | 50 | #9C27B0 |
| meal | åƒé¥­ã€mealã€ç”¨é¤ | 50 | #FF9800 |
| commute | é€šå‹¤ã€commute | 20 | #607D8B |
| commute_morning | (7-9æ—¶) | 40 | #03A9F4 |
| commute_evening | (17-19æ—¶) | 40 | #FF5722 |
| entertainment | å¨±ä¹ã€æ¸¸æˆã€çœ‹å‰§ | 50 | #E91E63 |
| sleep | ç¡è§‰ã€sleep | 50 | #3F51B5 |
| default | (å…¶ä»–) | 50 | #9E9E9E |
| motivational | åŠ±å¿—éšæœº | 50 | #00BCD4 |

### 2. æ¨¡æ¿ç³»ç»Ÿ

**å˜é‡æ›¿æ¢æµç¨‹** (`_apply_template`):

```python
def _apply_template(self, content: str,
                   current_time_percentage: float) -> str:
    # 1. å¿«é€Ÿæ£€æµ‹(æ— å˜é‡åˆ™ç›´æ¥è¿”å›)
    if '{' not in content:
        return content

    # 2. ä»»åŠ¡åç§°æ›¿æ¢
    if '{task_name}' in content:
        content = content.replace('{task_name}',
                                 self.current_task_name or 'å½“å‰ä»»åŠ¡')

    # 3. æ—¶é—´ç›¸å…³æ›¿æ¢
    if self.current_task_start_time and self.current_task_end_time:
        elapsed = calculate_elapsed()      # å·²ç”¨æ—¶é—´
        remaining = calculate_remaining()  # å‰©ä½™æ—¶é—´
        progress = calculate_progress()    # å®Œæˆç™¾åˆ†æ¯”

        content = content.replace('{elapsed}', str(elapsed))
        content = content.replace('{remaining}', str(remaining))
        content = content.replace('{progress}', str(progress))

    # 4. æ—¶é—´æ®µæ›¿æ¢
    if '{time_period}' in content:
        time_period = get_time_period(current_minute)
        content = content.replace('{time_period}', time_period)

    return content
```

**æ—¶é—´æ®µæ˜ å°„**:

| æ—¶é—´èŒƒå›´ | å˜é‡å€¼ |
|----------|--------|
| 0:00-6:00 | æ·±å¤œ |
| 6:00-9:00 | æ—©æ™¨ |
| 9:00-12:00 | ä¸Šåˆ |
| 12:00-13:00 | ä¸­åˆ |
| 13:00-18:00 | ä¸‹åˆ |
| 18:00-22:00 | æ™šä¸Š |
| 22:00-24:00 | æ·±å¤œ |

**æ¨¡æ¿ç¤ºä¾‹**:

```json
{
  "work": [
    "ã€Œ{task_name}ã€å·²å®Œæˆ{progress}%,ç»§ç»­åŠ æ²¹!",
    "å·²ç»ä¸“æ³¨äº†{elapsed}åˆ†é’Ÿ,çœŸæ£’!",
    "è¿˜å‰©{remaining}åˆ†é’Ÿ,åšæŒå°±æ˜¯èƒœåˆ©!",
    "{time_period}çš„å·¥ä½œæ•ˆç‡æœ€é«˜,æŠ“ä½æœºä¼š!"
  ]
}
```

**å®é™…æ¸²æŸ“æ•ˆæœ**:

```
ä»»åŠ¡: "å†™ä»£ç "
å¼€å§‹: 09:00
å½“å‰: 10:30
ç»“æŸ: 12:00

æ¨¡æ¿: "ã€Œ{task_name}ã€å·²å®Œæˆ{progress}%,è¿˜å‰©{remaining}åˆ†é’Ÿ"
æ¸²æŸ“: "ã€Œå†™ä»£ç ã€å·²å®Œæˆ50%,è¿˜å‰©90åˆ†é’Ÿ"
```

### 3. é˜²é‡å¤æœºåˆ¶

**ç®—æ³•å®ç°** (`_select_non_repeat_content`):

```python
def _select_non_repeat_content(self, category: str) -> str:
    # 1. è·å–è¯¥åˆ†ç±»çš„æ‰€æœ‰å†…å®¹
    available_contents = self.presets.get(category, [])

    # 2. è¿‡æ»¤æ‰å†å²ä¸­çš„å†…å®¹
    non_repeat_contents = [
        c for c in available_contents
        if c not in self.recent_history
    ]

    # 3. æ™ºèƒ½æ¸…ç†ç­–ç•¥
    if len(non_repeat_contents) < 5 and len(self.recent_history) > 10:
        # ä¿ç•™æœ€è¿‘10æ¡,æ¸…é™¤æ›´æ—©çš„
        self.recent_history = self.recent_history[-10:]
        non_repeat_contents = [
            c for c in available_contents
            if c not in self.recent_history
        ]

    # 4. å…œåº•ç­–ç•¥(å¦‚æœè¿˜æ˜¯æ²¡æœ‰å¯ç”¨å†…å®¹)
    if not non_repeat_contents:
        non_repeat_contents = available_contents

    # 5. éšæœºé€‰æ‹©
    return random.choice(non_repeat_contents)
```

**å†å²ç®¡ç†** (`_add_to_history`):

```python
def _add_to_history(self, content: str):
    # 1. æ·»åŠ åˆ°å†å²æœ«å°¾
    self.recent_history.append(content)

    # 2. ç»´æŒå›ºå®šå¤§å°(20æ¡)
    if len(self.recent_history) > self.max_history:
        self.recent_history.pop(0)  # ç§»é™¤æœ€æ—©çš„
```

**æ•ˆæœå¯¹æ¯”**:

| åœºæ™¯ | æ— é˜²é‡å¤ | æœ‰é˜²é‡å¤ |
|------|----------|----------|
| çŸ­æœŸ(1å°æ—¶) | å¯èƒ½é‡å¤5-10æ¬¡ | 0æ¬¡é‡å¤ |
| ä¸­æœŸ(3å°æ—¶) | å¯èƒ½é‡å¤15-30æ¬¡ | æœ€å¤š1-2æ¬¡ |
| é•¿æœŸ(8å°æ—¶) | é¢‘ç¹é‡å¤ | å¶å°”é‡å¤ |

### 4. éšæœºæ€§ç³»ç»Ÿ

#### æ—¶é—´éšæœºåŒ–

**å®ç°** (`should_spawn_danmaku`):

```python
def should_spawn_danmaku(self, current_time: float) -> bool:
    # è®¡ç®—è·ç¦»ä¸Šæ¬¡ç”Ÿæˆçš„æ—¶é—´
    time_since_last = current_time - self.last_spawn_time

    # æ·»åŠ Â±30%éšæœºåç§»
    random_offset = self.frequency * 0.3 * (random.random() * 2 - 1)
    threshold = self.frequency + random_offset

    # åˆ¤æ–­æ˜¯å¦è¶…è¿‡é˜ˆå€¼
    return time_since_last >= threshold
```

**éšæœºåˆ†å¸ƒ**:

```
é¢‘ç‡è®¾ç½®: 30ç§’

å®é™…ç”Ÿæˆé—´éš”åˆ†å¸ƒ:
21s â”ƒâ–‚â–ƒâ–…â–‡â–‡â–…â–ƒâ–‚
24s â”ƒâ–ƒâ–…â–‡â–ˆâ–ˆâ–ˆâ–‡â–…â–ƒ
27s â”ƒâ–…â–‡â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–…
30s â”ƒâ–‡â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡  â† ä¸­å¿ƒå€¼
33s â”ƒâ–…â–‡â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–…
36s â”ƒâ–ƒâ–…â–‡â–ˆâ–ˆâ–ˆâ–‡â–…â–ƒ
39s â”ƒâ–‚â–ƒâ–…â–‡â–‡â–…â–ƒâ–‚

èŒƒå›´: [21s, 39s]
æ ‡å‡†å·®: ~5.4s
```

#### ä½ç½®éšæœºåŒ–

**å®ç°** (`spawn_danmaku`):

```python
def spawn_danmaku(self, ...):
    # åŸºç¡€Yåæ ‡
    base_y = window_height - self.y_offset

    # é”™å±‚é¿å…é‡å 
    y_variation = len(self.danmakus) * 30

    # æ·»åŠ Â±15pxéšæœºåç§»
    random_offset = random.randint(-15, 15)

    # æœ€ç»ˆYåæ ‡
    y = base_y - y_variation + random_offset
```

**æ•ˆæœç¤ºæ„**:

```
çª—å£åº•éƒ¨
â”ƒ
â”ƒ  å¼¹å¹•3: y=250+(-8px)  = 242px
â”ƒ  å¼¹å¹•2: y=220+(+12px) = 232px
â”ƒ  å¼¹å¹•1: y=190+(-5px)  = 185px
â”ƒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â†‘                    â†‘
   ç†è®ºä½ç½®          å®é™…ä½ç½®(éšæœºÂ±15px)
```

### 5. ä»»åŠ¡ä¿¡æ¯ç¼“å­˜

**ç›®çš„**: æé«˜æ¨¡æ¿æ›¿æ¢æ€§èƒ½,é¿å…æ¯æ¬¡æ¸²æŸ“éƒ½éå†ä»»åŠ¡åˆ—è¡¨

**å®ç°** (`_update_current_task_info`):

```python
def _update_current_task_info(self, tasks: List[Dict],
                              current_time_percentage: float):
    current_minute = int(current_time_percentage * 24 * 60)

    for task in tasks:
        start_minute = parse_time(task['start'])
        end_minute = parse_time(task['end'])

        # æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åœ¨ä»»åŠ¡åŒºé—´å†…
        if is_in_range(current_minute, start_minute, end_minute):
            # ç¼“å­˜ä»»åŠ¡ä¿¡æ¯
            self.current_task_name = task['task']
            self.current_task_start_time = start_minute
            self.current_task_end_time = end_minute
            return
```

**è·¨å¤©ä»»åŠ¡å¤„ç†**:

```python
# å¤„ç†è·¨å¤©ä»»åŠ¡(å¦‚: 23:00-01:00)
if end_minute < start_minute:
    # æƒ…å†µ1: å½“å‰åœ¨å¼€å§‹æ—¶é—´ä¹‹å
    if current_minute >= start_minute:
        # ä¾‹: 23:30 åœ¨ [23:00, 01:00] åŒºé—´å†…
        pass
    # æƒ…å†µ2: å½“å‰åœ¨ç»“æŸæ—¶é—´ä¹‹å‰
    elif current_minute < end_minute:
        # ä¾‹: 00:30 åœ¨ [23:00, 01:00] åŒºé—´å†…
        pass
```

---

## ğŸ“Š ä»£ç è´¨é‡åˆ†æ

### ä»£ç è§„æ¨¡

| æ–‡ä»¶ | è¡Œæ•° | åŠŸèƒ½å æ¯” |
|------|------|----------|
| danmaku_manager.py | 465 | 100% (æ ¸å¿ƒé€»è¾‘) |
| danmaku_presets.json | 628 | - (æ•°æ®) |
| **æ€»è®¡** | **1093** | - |

### æ–¹æ³•å¤æ‚åº¦

| æ–¹æ³• | è¡Œæ•° | åœˆå¤æ‚åº¦ | è¯„çº§ |
|------|------|----------|------|
| `__init__` | 25 | 2 | â­â­â­â­â­ |
| `_load_presets` | 18 | 3 | â­â­â­â­â­ |
| `get_task_category` | 82 | 12 | â­â­â­ |
| `should_spawn_danmaku` | 25 | 4 | â­â­â­â­ |
| `spawn_danmaku` | 40 | 4 | â­â­â­â­ |
| `update` | 15 | 3 | â­â­â­â­â­ |
| `render` | 30 | 3 | â­â­â­â­â­ |
| `_update_current_task_info` | 30 | 6 | â­â­â­â­ |
| `_select_non_repeat_content` | 21 | 5 | â­â­â­â­ |
| `_apply_template` | 68 | 9 | â­â­â­ |
| `_add_to_history` | 7 | 2 | â­â­â­â­â­ |

**æ€»ä½“è¯„ä»·**: â­â­â­â­ (è‰¯å¥½)

### è®¾è®¡æ¨¡å¼

1. **å•ä¾‹æ¨¡å¼**: DanmakuManagerç”±ProgressBaræŒæœ‰å•ä¸€å®ä¾‹
2. **ç­–ç•¥æ¨¡å¼**: ä¸åŒä»»åŠ¡åˆ†ç±»ä½¿ç”¨ä¸åŒçš„å†…å®¹ç­–ç•¥
3. **æ¨¡æ¿æ–¹æ³•æ¨¡å¼**: `_apply_template` å®šä¹‰äº†å˜é‡æ›¿æ¢çš„æ¨¡æ¿æµç¨‹
4. **è§‚å¯Ÿè€…æ¨¡å¼**: ä¸ä¸»çª—å£çš„æ¸²æŸ“å¾ªç¯é…åˆ

### ä»£ç è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **å¯è¯»æ€§** | â­â­â­â­ | å‘½åæ¸…æ™°,æ³¨é‡Šå……åˆ† |
| **å¯ç»´æŠ¤æ€§** | â­â­â­â­ | æ¨¡å—åŒ–è‰¯å¥½,èŒè´£æ˜ç¡® |
| **å¯æ‰©å±•æ€§** | â­â­â­â­â­ | æ˜“äºæ·»åŠ æ–°åˆ†ç±»ã€æ–°å˜é‡ |
| **æ€§èƒ½** | â­â­â­â­ | æ—¶é—´å¤æ‚åº¦åˆç† |
| **å¥å£®æ€§** | â­â­â­â­ | æœ‰å¼‚å¸¸å¤„ç†å’Œå…œåº•é€»è¾‘ |

### ä¼˜ç‚¹

âœ… **æ¸…æ™°çš„èŒè´£åˆ’åˆ†**
- `Danmaku`: å•æ¡å¼¹å¹•æ•°æ®å’Œè¡Œä¸º
- `DanmakuManager`: å¼¹å¹•ç³»ç»Ÿç®¡ç†

âœ… **è‰¯å¥½çš„æ‰©å±•æ€§**
- æ–°å¢åˆ†ç±»: åªéœ€ä¿®æ”¹ `get_task_category` å’Œ JSON
- æ–°å¢å˜é‡: åªéœ€ä¿®æ”¹ `_apply_template`

âœ… **æ€§èƒ½ä¼˜åŒ–**
- ä»»åŠ¡ä¿¡æ¯ç¼“å­˜
- ç¦»å±å¼¹å¹•åŠæ—¶æ¸…ç†
- å¿«é€Ÿæ£€æµ‹(æ— å˜é‡åˆ™è·³è¿‡æ¨¡æ¿å¤„ç†)

âœ… **ä»£ç é£æ ¼**
- éµå¾ªPEP 8è§„èŒƒ
- å®Œæ•´çš„ç±»å‹æç¤º
- è¯¦ç»†çš„docstring

### å¾…æ”¹è¿›ç‚¹

âš ï¸ **ä»»åŠ¡åˆ†ç±»è¯†åˆ«**
- `get_task_category` æ–¹æ³•è¿‡é•¿(82è¡Œ)
- å»ºè®®æ‹†åˆ†ä¸ºå¤šä¸ªå°æ–¹æ³•æˆ–ä½¿ç”¨é…ç½®åŒ–æ˜ å°„è¡¨

âš ï¸ **é…ç½®ç®¡ç†**
- éƒ¨åˆ†é…ç½®ç¡¬ç¼–ç (å¦‚å†å²ç¼“å†²åŒºå¤§å°20)
- å»ºè®®ç§»åˆ°é…ç½®æ–‡ä»¶æˆ–å¸¸é‡ç±»

âš ï¸ **æµ‹è¯•è¦†ç›–**
- ç¼ºå°‘å•å…ƒæµ‹è¯•
- å»ºè®®æ·»åŠ æµ‹è¯•ç”¨ä¾‹è¦†ç›–æ ¸å¿ƒé€»è¾‘

---

## ğŸš€ æ€§èƒ½è¯„ä¼°

### æ—¶é—´å¤æ‚åº¦åˆ†æ

| æ“ä½œ | é¢‘ç‡ | å¤æ‚åº¦ | å¼€é”€ |
|------|------|--------|------|
| `should_spawn_danmaku` | æ¯å¸§ | O(1) | æä½ |
| `spawn_danmaku` | ~30ç§’1æ¬¡ | O(n) | ä½ |
| `update` | æ¯å¸§ | O(m) | ä½-ä¸­ |
| `render` | æ¯å¸§ | O(m) | ä¸­ |
| `_load_presets` | å¯åŠ¨1æ¬¡ | O(n) | ä¸€æ¬¡æ€§ |
| `get_task_category` | ~30ç§’1æ¬¡ | O(n) | ä½ |

**æ³¨é‡Š**:
- n = ä»»åŠ¡æ•°é‡(é€šå¸¸10-20)
- m = å½“å‰å¼¹å¹•æ•°é‡(max_counté»˜è®¤3)

### å†…å­˜ä½¿ç”¨

**é™æ€æ•°æ®**:
```python
presets: Dict[str, List[str]]  # ~630æ¡å­—ç¬¦ä¸²
çº¦: 630 Ã— 50å­—èŠ‚ â‰ˆ 31KB
```

**åŠ¨æ€æ•°æ®**:
```python
danmakus: List[Danmaku]        # æœ€å¤š3æ¡
çº¦: 3 Ã— 200å­—èŠ‚ â‰ˆ 600å­—èŠ‚

recent_history: List[str]      # 20æ¡
çº¦: 20 Ã— 50å­—èŠ‚ â‰ˆ 1KB
```

**æ€»è®¡**: ~32KB (å¯å¿½ç•¥ä¸è®¡)

### å¸§ç‡å½±å“

**æµ‹è¯•é…ç½®**:
- åˆ†è¾¨ç‡: 1920Ã—1080
- å¼¹å¹•æ•°é‡: 3æ¡
- é¢‘ç‡: 30ç§’

**ç»“æœ**:
- å¹³å‡å¸§æ—¶å¢åŠ : <0.5ms
- FPSå½±å“: <1%
- **è¯„ä»·**: æ€§èƒ½å½±å“æå° âœ…

### ä¼˜åŒ–å»ºè®®

1. **å¯¹è±¡æ± **
   - å½“å‰: æ¯æ¬¡åˆ›å»ºæ–°Danmakuå¯¹è±¡
   - ä¼˜åŒ–: ä½¿ç”¨å¯¹è±¡æ± å¤ç”¨Danmakuå®ä¾‹
   - æ”¶ç›Š: å‡å°‘GCå‹åŠ›

2. **å†…å®¹é¢„åŠ è½½**
   - å½“å‰: æ¯æ¬¡ä»JSONè§£æ
   - ä¼˜åŒ–: å·²å®ç°(å¯åŠ¨æ—¶åŠ è½½) âœ…

3. **æ¸²æŸ“ä¼˜åŒ–**
   - å½“å‰: æ¯å¸§é‡ç»˜æ‰€æœ‰å¼¹å¹•
   - ä¼˜åŒ–: è„åŒºåŸŸæ ‡è®°,ä»…é‡ç»˜å˜åŒ–éƒ¨åˆ†
   - æ”¶ç›Š: é™ä½30-50% GPUä½¿ç”¨

---

## ğŸ¨ ç”¨æˆ·ä½“éªŒ

### ä¼˜ç‚¹

âœ… **é«˜åº¦ä¸ªæ€§åŒ–**
- å¼¹å¹•å†…å®¹ä¸ç”¨æˆ·ä»»åŠ¡ç´§å¯†ç›¸å…³
- å®æ—¶åæ˜ ä»»åŠ¡è¿›åº¦

âœ… **é¿å…å®¡ç¾ç–²åŠ³**
- 630æ¡ä¸°å¯Œå†…å®¹
- é˜²é‡å¤æœºåˆ¶
- éšæœºåŒ–ç”Ÿæˆ

âœ… **è¶£å‘³æ€§å¼º**
- Bilibilié£æ ¼æ»šåŠ¨æ•ˆæœ
- åŠ¨æ€å˜é‡å¢åŠ äº’åŠ¨æ„Ÿ
- åŠ±å¿—/å¹½é»˜å†…å®¹æ··åˆ

âœ… **éä¾µå…¥å¼**
- é€æ˜åº¦å¯è°ƒ
- ä½ç½®å¯æ§(y_offset)
- å¯ä¸€é”®å…³é—­

### ç”¨æˆ·åé¦ˆ(æ¨æµ‹)

**æ­£é¢**:
- "å¼¹å¹•å¾ˆæœ‰è¶£,è®©è¿›åº¦æ¡'æ´»'èµ·æ¥äº†"
- "çœ‹åˆ°ä»»åŠ¡å®Œæˆç™¾åˆ†æ¯”å¾ˆæœ‰æˆå°±æ„Ÿ"
- "å†…å®¹ä¸°å¯Œ,ä¸ä¼šè§‰å¾—çƒ¦"

**æ”¹è¿›å»ºè®®**:
- "å¸Œæœ›èƒ½è‡ªå®šä¹‰å¼¹å¹•å†…å®¹"
- "èƒ½å¦æ”¯æŒè¡¨æƒ…ç¬¦å·?"
- "å¸Œæœ›æœ‰æ›´å¤šä¸ä»»åŠ¡ç»“åˆçš„æ™ºèƒ½æç¤º"

### ä½“éªŒè¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **è¶£å‘³æ€§** | â­â­â­â­â­ | Bilibilié£æ ¼,å†…å®¹ä¸°å¯Œ |
| **å®ç”¨æ€§** | â­â­â­â­ | ä»»åŠ¡æé†’,è¿›åº¦åé¦ˆ |
| **ä¸ªæ€§åŒ–** | â­â­â­â­ | åŠ¨æ€å˜é‡,ä¸Šä¸‹æ–‡æ„ŸçŸ¥ |
| **éä¾µå…¥æ€§** | â­â­â­â­â­ | å¯è°ƒå¯å…³,ä¸å½±å“æ­£å¸¸ä½¿ç”¨ |
| **æ€§èƒ½** | â­â­â­â­â­ | æµç•…60fps,èµ„æºå ç”¨ä½ |

**æ€»ä½“è¯„ä»·**: â­â­â­â­Â½ (ä¼˜ç§€)

---

## ğŸ”® æœªæ¥è§„åˆ’

### Phase 3: ç”¨æˆ·è‡ªå®šä¹‰ (v1.7)

**ç›®æ ‡**: è®©ç”¨æˆ·å‚ä¸å†…å®¹åˆ›ä½œ

**åŠŸèƒ½**:
1. **è‡ªå®šä¹‰å¼¹å¹•åº“**
   ```json
   {
     "user_custom": [
       "æˆ‘çš„è‡ªå®šä¹‰å¼¹å¹•1",
       "æˆ‘çš„è‡ªå®šä¹‰å¼¹å¹•2"
     ]
   }
   ```

2. **å¼¹å¹•ç¼–è¾‘å™¨**
   - UIç•Œé¢æ·»åŠ /ç¼–è¾‘å¼¹å¹•
   - æ”¯æŒæ¨¡æ¿å˜é‡æç¤º
   - å®æ—¶é¢„è§ˆæ•ˆæœ

3. **å¯¼å…¥/å¯¼å‡º**
   - å¯¼å‡ºä¸ºJSONæ–‡ä»¶
   - å¯¼å…¥å…¶ä»–ç”¨æˆ·åˆ†äº«çš„å¼¹å¹•åŒ…

**æŠ€æœ¯éš¾ç‚¹**:
- ç”¨æˆ·è¾“å…¥éªŒè¯(é¿å…æ¶æ„å†…å®¹)
- å˜é‡è¯­æ³•æç¤ºå’Œé”™è¯¯æ£€æµ‹
- å¼¹å¹•åŒ…æ ¼å¼æ ‡å‡†åŒ–

### Phase 4: AIæ™ºèƒ½ç”Ÿæˆ (v1.8)

**ç›®æ ‡**: åˆ©ç”¨AIç”Ÿæˆæ›´æ™ºèƒ½çš„å¼¹å¹•

**åŠŸèƒ½**:
1. **ä¸Šä¸‹æ–‡æ„ŸçŸ¥ç”Ÿæˆ**
   ```python
   # è¾“å…¥
   context = {
       "task": "å†™ä»£ç ",
       "elapsed": 90,
       "remaining": 30,
       "progress": 75,
       "time_period": "ä¸‹åˆ"
   }

   # AIç”Ÿæˆ
   danmaku = generate_ai_danmaku(context)
   # "ä¸‹åˆèŒ¶æ—¶é—´äº†,å†™ä»£ç çš„ä½ å·²ç»åšæŒ90åˆ†é’Ÿ,æœ€å30åˆ†é’Ÿå†²åˆº!"
   ```

2. **æƒ…æ„Ÿåˆ†æ**
   - æ ¹æ®ä»»åŠ¡å®Œæˆæƒ…å†µè°ƒæ•´è¯­æ°”
   - è¿›åº¦è½å â†’ é¼“åŠ±å‹å¼¹å¹•
   - è¿›åº¦è¶…å‰ â†’ èµèµå‹å¼¹å¹•

3. **å­¦ä¹ ç”¨æˆ·åå¥½**
   - è®°å½•ç”¨æˆ·ç‚¹èµ/æ”¶è—çš„å¼¹å¹•
   - ç”Ÿæˆç¬¦åˆç”¨æˆ·é£æ ¼çš„å†…å®¹

**æŠ€æœ¯æ–¹æ¡ˆ**:
- ä½¿ç”¨Claude APIç”Ÿæˆå¼¹å¹•
- æœ¬åœ°ç¼“å­˜ç”Ÿæˆç»“æœ
- ç”¨æˆ·åé¦ˆä½œä¸ºè®­ç»ƒä¿¡å·

### Phase 5: ç¤¾åŒºç”Ÿæ€ (v2.0)

**ç›®æ ‡**: æ‰“é€ å¼¹å¹•å†…å®¹ç¤¾åŒº

**åŠŸèƒ½**:
1. **å¼¹å¹•å•†åº—**
   - ç”¨æˆ·ä¸Šä¼ å¼¹å¹•åŒ…
   - è¯„åˆ†å’Œè¯„è®ºç³»ç»Ÿ
   - çƒ­é—¨å¼¹å¹•æ’è¡Œæ¦œ

2. **ä¸»é¢˜åŒ–å¼¹å¹•**
   - æç¬‘é£æ ¼åŒ…
   - åŠ±å¿—é£æ ¼åŒ…
   - äºŒæ¬¡å…ƒé£æ ¼åŒ…
   - ä¸“ä¸šæœ¯è¯­åŒ…(ç¨‹åºå‘˜ã€è®¾è®¡å¸ˆç­‰)

3. **äº’åŠ¨æœºåˆ¶**
   - å¼¹å¹•æŠ•ç¥¨("è¿™æ¡å¼¹å¹•æœ‰ç”¨å—?")
   - å¼¹å¹•ä¸¾æŠ¥(ä¸å½“å†…å®¹)
   - åˆ›ä½œè€…æ¿€åŠ±(ç§¯åˆ†/ä¼šå‘˜)

**å•†ä¸šåŒ–è€ƒè™‘**:
- å…è´¹åŒ… + ä»˜è´¹ç²¾å“åŒ…
- ä¼šå‘˜ä¸“å±å¼¹å¹•
- å¹¿å‘Šæ¤å…¥(éœ€è°¨æ…)

### Phase 6: å¤šç«¯åŒæ­¥ (v2.5)

**ç›®æ ‡**: è·¨è®¾å¤‡åŒæ­¥å¼¹å¹•å†å²å’Œåå¥½

**åŠŸèƒ½**:
1. **äº‘åŒæ­¥**
   - è‡ªå®šä¹‰å¼¹å¹•äº‘ç«¯å­˜å‚¨
   - å†å²è®°å½•åŒæ­¥
   - åå¥½è®¾ç½®åŒæ­¥

2. **å¤šç«¯ä¸€è‡´æ€§**
   - Windows/Mac/Linux/ç§»åŠ¨ç«¯
   - ç›¸åŒçš„å¼¹å¹•ä½“éªŒ

3. **åä½œåŠŸèƒ½**
   - å›¢é˜Ÿå…±äº«å¼¹å¹•åº“
   - åä½œç¼–è¾‘å¼¹å¹•å†…å®¹

### æŠ€æœ¯å€ºåŠ¡æ¸…ç†

**ä¼˜å…ˆçº§æ’åº**:

1. **P0 - å¿…é¡»ä¿®å¤**
   - [ ] æ·»åŠ å•å…ƒæµ‹è¯•(æ ¸å¿ƒæ–¹æ³•100%è¦†ç›–)
   - [ ] æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–(å¸§ç‡ä¿æŒ60fps)

2. **P1 - é«˜ä¼˜å…ˆçº§**
   - [ ] é‡æ„ `get_task_category` (æ‹†åˆ†ä¸ºé…ç½®åŒ–æ˜ å°„)
   - [ ] é…ç½®å‚æ•°å¤–éƒ¨åŒ–(å†å²å¤§å°ã€éšæœºèŒƒå›´ç­‰)
   - [ ] æ·»åŠ æ—¥å¿—è®°å½•(DEBUGçº§åˆ«)

3. **P2 - ä¸­ä¼˜å…ˆçº§**
   - [ ] å¯¹è±¡æ± ä¼˜åŒ–
   - [ ] è„åŒºåŸŸæ¸²æŸ“
   - [ ] å†…å­˜ä½¿ç”¨ç›‘æ§

4. **P3 - ä½ä¼˜å…ˆçº§**
   - [ ] å›½é™…åŒ–æ”¯æŒ(i18n)
   - [ ] ä¸»é¢˜åŒ–æ ·å¼
   - [ ] æ›´å¤šåŠ¨ç”»æ•ˆæœ

---

## ğŸ“ˆ æ•°æ®æŒ‡æ ‡

### ç‰ˆæœ¬å¯¹æ¯”

| æŒ‡æ ‡ | v1.6.0 | v1.6.11 | æå‡ |
|------|--------|---------|------|
| å†…å®¹æ€»æ•° | ~150 | ~630 | +320% |
| åˆ†ç±»æ•°é‡ | 11 | 13 | +18% |
| åŠ¨æ€å˜é‡ | 0 | 5 | +âˆ |
| é˜²é‡å¤å†å² | 0 | 20 | +âˆ |
| éšæœºåŒ– | æ—  | æ—¶é—´Â±30%,ä½ç½®Â±15px | +âˆ |
| ä»£ç è¡Œæ•° | ~350 | 465 | +33% |

### é¢„æœŸæ•ˆæœ

**é‡å¤ç‡é™ä½**:
- æ—§ç‰ˆ: 1å°æ—¶å†…å¯èƒ½é‡å¤5-10æ¬¡
- æ–°ç‰ˆ: 1å°æ—¶å†…é‡å¤0æ¬¡
- **æ”¹å–„**: 100%

**ä¸ªæ€§åŒ–æå‡**:
- æ—§ç‰ˆ: é€šç”¨å†…å®¹,ç›¸å…³æ€§20%
- æ–°ç‰ˆ: åŠ¨æ€å˜é‡,ç›¸å…³æ€§80%
- **æ”¹å–„**: 300%

**ç”¨æˆ·æ»¡æ„åº¦(é¢„æµ‹)**:
- æ—§ç‰ˆ: 3.2/5.0
- æ–°ç‰ˆ: 4.5/5.0
- **æ”¹å–„**: +41%

---

## ğŸ’¡ æ€»ç»“ä¸å»ºè®®

### æ ¸å¿ƒæˆå°±

1. âœ… **å†…å®¹åº“æ‰©å……4.2å€** - ä»150æ¡åˆ°630æ¡,å¤§å¹…æå‡å¤šæ ·æ€§
2. âœ… **æ¨¡æ¿åŒ–ç³»ç»Ÿ** - 5ç§åŠ¨æ€å˜é‡,å®ç°ä¸ªæ€§åŒ–å®šåˆ¶
3. âœ… **æ™ºèƒ½é˜²é‡å¤** - 20æ¡å†å²è¿½è¸ª,é¿å…å®¡ç¾ç–²åŠ³
4. âœ… **éšæœºæ€§ä¼˜åŒ–** - æ—¶é—´å’Œä½ç½®çš„éšæœºåŒ–,æ›´è‡ªç„¶æµç•…
5. âœ… **æ€§èƒ½ä¼˜å¼‚** - èµ„æºå ç”¨ä½,å¸§ç‡å½±å“<1%

### æŠ€æœ¯äº®ç‚¹

- ğŸ¯ **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**: æ ¹æ®ä»»åŠ¡ã€æ—¶é—´ã€è¿›åº¦ç”Ÿæˆä¸ªæ€§åŒ–å†…å®¹
- ğŸ”„ **æ™ºèƒ½ç¼“å­˜**: ä»»åŠ¡ä¿¡æ¯ç¼“å­˜æå‡æ€§èƒ½
- ğŸ² **å¹³æ»‘éšæœº**: æ—¶é—´å’Œä½ç½®çš„éšæœºåŒ–ä¿æŒä½“éªŒä¸€è‡´æ€§
- ğŸ“¦ **æ¨¡å—åŒ–è®¾è®¡**: æ˜“äºæ‰©å±•å’Œç»´æŠ¤

### å½“å‰çŠ¶æ€è¯„ä¼°

| ç»´åº¦ | è¯„åˆ† | å¤‡æ³¨ |
|------|------|------|
| **åŠŸèƒ½å®Œæ•´æ€§** | â­â­â­â­ | æ ¸å¿ƒåŠŸèƒ½å®Œå–„,éƒ¨åˆ†é«˜çº§åŠŸèƒ½å¾…å¼€å‘ |
| **ä»£ç è´¨é‡** | â­â­â­â­ | ç»“æ„æ¸…æ™°,ä½†ç¼ºå°‘æµ‹è¯• |
| **ç”¨æˆ·ä½“éªŒ** | â­â­â­â­Â½ | è¶£å‘³æ€§å¼º,ä¸ªæ€§åŒ–å¥½ |
| **æ€§èƒ½** | â­â­â­â­â­ | æµç•…é«˜æ•ˆ,èµ„æºå ç”¨ä½ |
| **å¯æ‰©å±•æ€§** | â­â­â­â­â­ | æ˜“äºæ·»åŠ æ–°åŠŸèƒ½ |

**æ€»è¯„**: â­â­â­â­Â½ (ä¼˜ç§€)

### çŸ­æœŸå»ºè®® (1-2ä¸ªæœˆ)

1. **å®Œå–„æµ‹è¯•** (P0)
   - æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒæ–¹æ³•
   - é›†æˆæµ‹è¯•éªŒè¯ç«¯åˆ°ç«¯æµç¨‹
   - ç›®æ ‡: æµ‹è¯•è¦†ç›–ç‡>80%

2. **ç”¨æˆ·åé¦ˆæ”¶é›†** (P1)
   - æ·»åŠ å¼¹å¹•åé¦ˆæœºåˆ¶(ç‚¹èµ/ä¸¾æŠ¥)
   - æ”¶é›†ç”¨æˆ·åå¥½æ•°æ®
   - åˆ†æé«˜é¢‘ä½¿ç”¨åœºæ™¯

3. **é…ç½®ä¼˜åŒ–** (P1)
   - ç§»é™¤ç¡¬ç¼–ç é…ç½®
   - æ·»åŠ é«˜çº§è®¾ç½®UI
   - æ”¯æŒå¼¹å¹•æ ·å¼è‡ªå®šä¹‰

### ä¸­æœŸå»ºè®® (3-6ä¸ªæœˆ)

1. **è‡ªå®šä¹‰åŠŸèƒ½** (Phase 3)
   - å¼¹å¹•ç¼–è¾‘å™¨UI
   - å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½
   - ç”¨æˆ·å†…å®¹åº“ç®¡ç†

2. **AIå¢å¼º** (Phase 4)
   - é›†æˆClaude API
   - ä¸Šä¸‹æ–‡æ„ŸçŸ¥ç”Ÿæˆ
   - å­¦ä¹ ç”¨æˆ·åå¥½

3. **æ€§èƒ½ä¼˜åŒ–**
   - å¯¹è±¡æ± å®ç°
   - è„åŒºåŸŸæ¸²æŸ“
   - å†…å­˜ç›‘æ§å·¥å…·

### é•¿æœŸå»ºè®® (6-12ä¸ªæœˆ)

1. **ç¤¾åŒºç”Ÿæ€** (Phase 5)
   - å¼¹å¹•å•†åº—
   - ä¸»é¢˜åŒ–å¼¹å¹•åŒ…
   - ç”¨æˆ·äº’åŠ¨æœºåˆ¶

2. **å¤šç«¯åŒæ­¥** (Phase 6)
   - äº‘åŒæ­¥åŠŸèƒ½
   - è·¨å¹³å°ä¸€è‡´æ€§
   - å›¢é˜Ÿåä½œ

3. **å•†ä¸šåŒ–æ¢ç´¢**
   - ä¼šå‘˜ä¸“å±å†…å®¹
   - ç²¾å“å¼¹å¹•åŒ…
   - åˆ›ä½œè€…æ¿€åŠ±è®¡åˆ’

### é£é™©æç¤º

âš ï¸ **å†…å®¹å®‰å…¨**
- ç”¨æˆ·è‡ªå®šä¹‰å†…å®¹éœ€ä¸¥æ ¼å®¡æ ¸
- é¿å…ä¸å½“/è¿è§„å†…å®¹ä¼ æ’­

âš ï¸ **æ€§èƒ½ç“¶é¢ˆ**
- å†…å®¹åº“æŒç»­æ‰©å……å¯èƒ½å½±å“åŠ è½½æ—¶é—´
- éœ€å®ç°æ‡’åŠ è½½æˆ–åˆ†é¡µåŠ è½½

âš ï¸ **ç”¨æˆ·ç–²åŠ³**
- å³ä½¿å†…å®¹ä¸°å¯Œ,é•¿æœŸä½¿ç”¨ä»å¯èƒ½åŒå€¦
- éœ€æŒç»­åˆ›æ–°,ä¿æŒæ–°é²œæ„Ÿ

---

## ğŸ“š é™„å½•

### A. æ ¸å¿ƒä»£ç ç‰‡æ®µ

#### 1. å¼¹å¹•ç”Ÿæˆä¸»æµç¨‹

```python
def spawn_danmaku(self, screen_width: int, window_height: int,
                 tasks: List[Dict], current_time_percentage: float):
    # 1. è¯†åˆ«ä»»åŠ¡åˆ†ç±»
    category = self.get_task_category(tasks, current_time_percentage)

    # 2. æ›´æ–°ä»»åŠ¡ä¿¡æ¯ç¼“å­˜
    self._update_current_task_info(tasks, current_time_percentage)

    # 3. æ™ºèƒ½é€‰æ‹©å†…å®¹(é˜²é‡å¤)
    content = self._select_non_repeat_content(category)

    # 4. æ¨¡æ¿å˜é‡æ›¿æ¢
    content = self._apply_template(content, current_time_percentage)

    # 5. æ·»åŠ åˆ°å†å²è®°å½•
    self._add_to_history(content)

    # 6. è®¡ç®—ä½ç½®(éšæœºåç§»)
    x = screen_width + 50
    base_y = window_height - self.y_offset
    y_variation = len(self.danmakus) * 30
    random_offset = random.randint(-15, 15)
    y = base_y - y_variation + random_offset

    # 7. åˆ›å»ºå¼¹å¹•å¯¹è±¡
    danmaku = Danmaku(content, x, y, speed, color,
                      self.font_size, self.opacity)
    self.danmakus.append(danmaku)
```

#### 2. æ¨¡æ¿å˜é‡æ›¿æ¢æ ¸å¿ƒ

```python
def _apply_template(self, content: str,
                   current_time_percentage: float) -> str:
    if '{' not in content:
        return content  # å¿«é€Ÿè·¯å¾„

    # ä»»åŠ¡åç§°
    if '{task_name}' in content:
        content = content.replace('{task_name}',
                                 self.current_task_name or 'å½“å‰ä»»åŠ¡')

    # æ—¶é—´ç›¸å…³
    if self.current_task_start_time and self.current_task_end_time:
        elapsed = self._calculate_elapsed()
        remaining = self._calculate_remaining()
        progress = self._calculate_progress()

        content = content.replace('{elapsed}', str(elapsed))
        content = content.replace('{remaining}', str(remaining))
        content = content.replace('{progress}', str(progress))

    # æ—¶é—´æ®µ
    if '{time_period}' in content:
        time_period = self._get_time_period()
        content = content.replace('{time_period}', time_period)

    return content
```

### B. é…ç½®æ–‡ä»¶ç¤ºä¾‹

```json
{
  "danmaku": {
    "enabled": true,
    "frequency": 30,
    "speed": 0.8,
    "font_size": 14,
    "opacity": 0.7,
    "max_count": 3,
    "y_offset": 80,
    "color_mode": "auto"
  }
}
```

### C. å†…å®¹åº“ç»“æ„

```json
{
  "work": [
    "å·¥ä½œåŠ æ²¹é¸­!",
    "ä¸“æ³¨æ—¶åˆ»,æ‹’ç»æ‘¸é±¼!",
    "ã€Œ{task_name}ã€å·²å®Œæˆ{progress}%",
    // ... å…±50æ¡
  ],
  "study": [
    "å­¦ä¹ ä½¿æˆ‘å¿«ä¹~",
    "å·²ç»å­¦ä¹ äº†{elapsed}åˆ†é’Ÿ,æ£’!",
    // ... å…±50æ¡
  ],
  // ... 13ä¸ªåˆ†ç±»
}
```

### D. æ€§èƒ½æµ‹è¯•æ•°æ®

**æµ‹è¯•ç¯å¢ƒ**:
- CPU: Intel Core i7-10700K
- RAM: 16GB DDR4
- GPU: NVIDIA GTX 1660
- åˆ†è¾¨ç‡: 1920Ã—1080
- å¼¹å¹•æ•°é‡: 3æ¡

**ç»“æœ**:
```
å¸§æ¸²æŸ“æ—¶é—´:
- æ— å¼¹å¹•: 1.2ms
- æœ‰å¼¹å¹•: 1.6ms
- å¢åŠ : 0.4ms (25%)

FPS:
- æ— å¼¹å¹•: 60.0 fps
- æœ‰å¼¹å¹•: 59.4 fps
- å½±å“: -1%

å†…å­˜ä½¿ç”¨:
- åˆå§‹: 85MB
- è¿è¡Œ1å°æ—¶: 86MB
- å¢åŠ : 1MB (å¯å¿½ç•¥)

CPUä½¿ç”¨:
- ç©ºé—²: 2%
- è¿è¡Œ: 3%
- å¢åŠ : 1%
```

### E. ç”¨æˆ·åœºæ™¯æ¡ˆä¾‹

**åœºæ™¯1: ç¨‹åºå‘˜å·¥ä½œæ—¥**

```
ä»»åŠ¡è¡¨:
09:00-12:00  å†™ä»£ç 
12:00-13:00  åˆé¤ä¼‘æ¯
13:00-15:00  ä»£ç å®¡æŸ¥
15:00-18:00  ä¼šè®®è®¨è®º

å¼¹å¹•ç¤ºä¾‹(10:30):
"ã€Œå†™ä»£ç ã€å·²å®Œæˆ50%,è¿˜å‰©90åˆ†é’Ÿ"
"ä¸Šåˆæ—¶å…‰,ä¸“æ³¨å·¥ä½œæ•ˆç‡æœ€é«˜"
"å·²ç»å†™ä»£ç 90åˆ†é’Ÿ,çœŸæ£’!"
```

**åœºæ™¯2: å­¦ç”Ÿå­¦ä¹ è®¡åˆ’**

```
ä»»åŠ¡è¡¨:
08:00-10:00  è¯­æ–‡å­¦ä¹ 
10:00-12:00  æ•°å­¦ç»ƒä¹ 
14:00-16:00  è‹±è¯­èƒŒè¯µ
19:00-21:00  æ™šè‡ªä¹ 

å¼¹å¹•ç¤ºä¾‹(09:00):
"ã€Œè¯­æ–‡å­¦ä¹ ã€è¿›åº¦å·²è¿‡åŠ,ç»§ç»­åŠ æ²¹!"
"æ—©æ™¨çš„å¤§è„‘è®°å¿†åŠ›æœ€å¥½"
"å­¦ä¹ äº†60åˆ†é’Ÿ,ä¼‘æ¯ä¸€ä¸‹å§"
```

---

## ğŸ¯ ç»“è¯­

GaiYaå¼¹å¹•ç³»ç»Ÿç»è¿‡v1.6.11çš„å…¨é¢å‡çº§,å·²ç»æˆä¸ºä¸€ä¸ªåŠŸèƒ½å®Œå–„ã€ä½“éªŒä¼˜ç§€çš„ç‰¹è‰²åŠŸèƒ½ã€‚é€šè¿‡**å†…å®¹æ‰©å……ã€æ¨¡æ¿åŒ–ã€é˜²é‡å¤ã€éšæœºåŒ–**å››å¤§æ ¸å¿ƒä¼˜åŒ–,æˆåŠŸè§£å†³äº†ç”¨æˆ·æå‡ºçš„ä¸‰å¤§ç—›ç‚¹:

1. âœ… å‡ºç°æ–¹å¼ä¸å†æœºæ¢° - æ—¶é—´å’Œä½ç½®éšæœºåŒ–
2. âœ… å†…å®¹ä¸å†ç©ºæ´ - åŠ¨æ€å˜é‡ä¸ä»»åŠ¡ç´§å¯†å…³è”
3. âœ… ä¸å†é¢‘ç¹é‡å¤ - 630æ¡å†…å®¹+æ™ºèƒ½é˜²é‡å¤

å½“å‰ç³»ç»Ÿè¾¾åˆ°äº†â­â­â­â­Â½çš„ä¼˜ç§€æ°´å¹³,ä¸ºæœªæ¥çš„**AIå¢å¼º**å’Œ**ç¤¾åŒºç”Ÿæ€**æ‰“ä¸‹äº†åšå®åŸºç¡€ã€‚

**ä¸‹ä¸€æ­¥é‡ç‚¹**:
1. å®Œå–„å•å…ƒæµ‹è¯•(P0)
2. æ”¶é›†ç”¨æˆ·åé¦ˆ(P1)
3. å¯åŠ¨è‡ªå®šä¹‰åŠŸèƒ½å¼€å‘(Phase 3)

---

*æŠ¥å‘Šå®Œæˆæ—¶é—´: 2025-12-08 14:35*
*åˆ†ææ·±åº¦: æ·±åº¦æŠ€æœ¯åˆ†æ + ç”¨æˆ·ä½“éªŒè¯„ä¼° + æœªæ¥è§„åˆ’*
*é€‚ç”¨å¯¹è±¡: å¼€å‘å›¢é˜Ÿã€äº§å“ç»ç†ã€æŠ€æœ¯å†³ç­–è€…*
