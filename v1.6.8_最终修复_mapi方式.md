# v1.6.8 æœ€ç»ˆä¿®å¤ - æ”¹ç”¨mapi.phpåˆ›å»ºè®¢å•

## ğŸ” é—®é¢˜æ ¹æºå‘ç°

ç»è¿‡å¤šæ¬¡æµ‹è¯•å’Œæ—¥å¿—åˆ†æ,ç»ˆäºå‘ç°**çœŸæ­£çš„æ ¹æœ¬åŸå› **:

### submit.php vs mapi.php çš„æœ¬è´¨åŒºåˆ«

| ç‰¹æ€§ | submit.php (æ—§æ–¹å¼) | mapi.php (æ–°æ–¹å¼) |
|------|---------------------|-------------------|
| **è®¢å•åˆ›å»ºæ—¶æœº** | ç”¨æˆ·è®¿é—®æ”¯ä»˜é¡µé¢æ—¶ | è°ƒç”¨APIæ—¶ç«‹å³åˆ›å»º |
| **æ˜¯å¦åœ¨Z-Payç³»ç»Ÿä¸­** | âŒ å¦ | âœ… æ˜¯ |
| **å¯å¦é€šè¿‡api.phpæŸ¥è¯¢** | âŒ å¦ | âœ… æ˜¯ |
| **è¿”å›trade_no** | âŒ å¦ | âœ… æ˜¯ |
| **è¿”å›payment_url** | âœ… åŸºç¡€URL | âœ… å®Œæ•´payurl |
| **éœ€è¦æ‹¼æ¥å‚æ•°** | âœ… æ˜¯ | âŒ å¦ |

### ä¸ºä»€ä¹ˆä¹‹å‰æ‰€æœ‰ä¿®å¤éƒ½å¤±è´¥äº†?

1. **æŸ¥è¯¢é‡è¯•æ— æ•ˆ** - å› ä¸ºè®¢å•æ ¹æœ¬ä¸å­˜åœ¨,é‡è¯•1000æ¬¡ä¹ŸæŸ¥ä¸åˆ°
2. **å®¢æˆ·ç«¯å»¶è¿Ÿæ— æ•ˆ** - å› ä¸ºsubmit.phpä»æœªåˆ›å»ºè®¢å•,ç­‰å¤šä¹…éƒ½æ²¡ç”¨
3. **æ—¥å¿—å¢å¼ºæ— ç”¨** - åªèƒ½çœ‹åˆ°"è®¢å•ä¸å­˜åœ¨"é”™è¯¯,ä½†æ— æ³•è§£å†³

**ç»“è®º**: submit.phpåªæ˜¯ç”Ÿæˆä¸€ä¸ªæ”¯ä»˜URL,çœŸæ­£çš„è®¢å•æ˜¯åœ¨ç”¨æˆ·æ‰“å¼€æµè§ˆå™¨è®¿é—®Z-Payæ”¯ä»˜é¡µé¢æ—¶,ç”±Z-Payå‰ç«¯JavaScriptåˆ›å»ºçš„ã€‚æˆ‘ä»¬çš„åç«¯ä»æœªçœŸæ­£åˆ›å»ºè¿‡è®¢å•!

---

## âœ… æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

### æ”¹ç”¨APIæ–¹å¼åˆ›å»ºè®¢å•

**åç«¯ä¿®æ”¹** ([api/payment-create-order.py](api/payment-create-order.py)):

```python
# âŒ æ—§ä»£ç  (submit.phpæ–¹å¼)
result = zpay.create_order(
    out_trade_no=out_trade_no,
    name=plan_info["name"],
    money=plan_info["price"],
    pay_type=pay_type,
    notify_url=notify_url,
    return_url=return_url,
    param=f"{user_id}|{plan_type}"
)

# âœ… æ–°ä»£ç  (mapi.phpæ–¹å¼)
client_ip = self.headers.get('x-forwarded-for', '').split(',')[0].strip() or \
           self.headers.get('x-real-ip', '127.0.0.1')

result = zpay.create_api_order(
    out_trade_no=out_trade_no,
    name=plan_info["name"],
    money=plan_info["price"],
    pay_type=pay_type,
    notify_url=notify_url,
    clientip=client_ip,  # âœ… æ–°å¢: å®¢æˆ·ç«¯IP
    param=f"{user_id}|{plan_type}"
)

# âœ… è¿”å›æ ¼å¼è°ƒæ•´
payment_url = result.get("payurl", "")  # APIæ–¹å¼è¿”å›payurl
trade_no = result.get("trade_no", "")   # è·å–å¹³å°è®¢å•å·
```

**å®¢æˆ·ç«¯ä¿®æ”¹** ([gaiya/ui/membership_ui.py](gaiya/ui/membership_ui.py:1146-1151)):

```python
# âŒ æ—§ä»£ç  (éœ€è¦æ‹¼æ¥å‚æ•°)
payment_url = result.get("payment_url")
params = result.get("params", {})
from urllib.parse import urlencode
query_string = urlencode(params)
full_payment_url = f"{payment_url}?{query_string}"
QDesktopServices.openUrl(QUrl(full_payment_url))

# âœ… æ–°ä»£ç  (ç›´æ¥ä½¿ç”¨payurl)
payment_url = result.get("payment_url")  # mapi.phpè¿”å›å®Œæ•´payurl
print(f"[MEMBERSHIP] Opening payment URL: {payment_url[:100]}...")
QDesktopServices.openUrl(QUrl(payment_url))
```

---

## ğŸš€ éƒ¨ç½²çŠ¶æ€

### åç«¯ (Vercel)

**Commit**: c052ba3
```
fix: æ”¹ç”¨mapi.phpåˆ›å»ºçœŸå®è®¢å•è§£å†³æŸ¥è¯¢å¤±è´¥é—®é¢˜
```

- æ¨é€æ—¶é—´: 2025-12-03 16:05
- éƒ¨ç½²URL: https://jindutiao.vercel.app
- çŠ¶æ€: âœ… å·²éƒ¨ç½²

**ä¿®æ”¹æ–‡ä»¶**:
- [api/payment-create-order.py](api/payment-create-order.py) - æ”¹ç”¨create_api_order
- [gaiya/ui/membership_ui.py](gaiya/ui/membership_ui.py) - ç§»é™¤paramsæ‹¼æ¥

### å®¢æˆ·ç«¯ (æœ¬åœ°)

**æ‰“åŒ…æ—¶é—´**: 2025-12-03 16:07
**æ–‡ä»¶è·¯å¾„**: [dist\GaiYa-v1.6.exe](dist/GaiYa-v1.6.exe)
**æ–‡ä»¶å¤§å°**: çº¦85MB
**çŠ¶æ€**: âœ… å·²æ‰“åŒ…

**åŒ…å«ä¿®å¤**:
- Commit c052ba3: mapi.phpè®¢å•åˆ›å»º
- Commit 232cd95: è½®è¯¢å»¶è¿Ÿ5ç§’
- Commit 052d260: æŸ¥è¯¢é‡è¯•3æ¬¡

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### å‰ææ¡ä»¶

**âš ï¸ é‡è¦**: æ­¤ä¿®å¤ä¾èµ–Z-Payå•†æˆ·è´¦æˆ·**å·²å¯ç”¨APIåˆ›å»ºè®¢å•åŠŸèƒ½**

å¦‚æœæµ‹è¯•æ—¶è®¢å•åˆ›å»ºå¤±è´¥,Vercelæ—¥å¿—ä¼šæ˜¾ç¤º:
```
[PAYMENT-CREATE] âœ— API order creation failed: å•†æˆ·æœªå¼€é€šAPIæ”¯ä»˜
```

æ­¤æ—¶éœ€è¦è”ç³»Z-PayæŠ€æœ¯æ”¯æŒå¼€é€šmapi.phpæƒé™ã€‚

### æµ‹è¯•æµç¨‹

#### 1. å¯åŠ¨åº”ç”¨
```
åŒå‡» dist\GaiYa-v1.6.exe
```

#### 2. å‘èµ·æ”¯ä»˜
- è¿›å…¥"ä¸ªäººä¸­å¿ƒ" â†’ "ä¼šå‘˜è®¢é˜…"
- é€‰æ‹©"ä¸“ä¸šç‰ˆæœˆä»˜" (Â¥0.1)
- ç‚¹å‡»"å‰å¾€æ”¯ä»˜"
- é€‰æ‹©"æ”¯ä»˜å®"

#### 3. è§‚å¯ŸVercelæ—¥å¿— (å…³é”®!)

**æˆåŠŸåœºæ™¯** - åº”è¯¥çœ‹åˆ°:
```
[PAYMENT-CREATE] Creating order via mapi.php for user xxx
[ZPAY-API] Response status: 200
[ZPAY-API] Order created: GAIYA1764xxxxx
[PAYMENT-CREATE] âœ“ Order created via API: GAIYA1764xxxxx, trade_no: 20251203xxxxx
```

**å¤±è´¥åœºæ™¯** - å¦‚æœçœ‹åˆ°:
```
[ZPAY-API] Response status: 500
[ZPAY-API] Order creation failed: å•†æˆ·æœªå¼€é€šAPIæ”¯ä»˜
[PAYMENT-CREATE] âœ— API order creation failed
```

è¯´æ˜éœ€è¦è”ç³»Z-Payå¼€é€šæƒé™ã€‚

#### 4. å®Œæˆæ”¯ä»˜
- åœ¨æµè§ˆå™¨ä¸­å®ŒæˆÂ¥0.1æ”¯ä»˜
- çœ‹åˆ°ç»¿è‰²å¯¹å‹¾

#### 5. è§‚å¯Ÿè‡ªåŠ¨å‡çº§
- â±ï¸ 5-10ç§’å†…è‡ªåŠ¨å¼¹çª—"æ”¯ä»˜æˆåŠŸ"
- âœ… ä¼šå‘˜çŠ¶æ€æ›´æ–°ä¸º"ä¸“ä¸šç‰ˆ"

---

## ğŸ“Š é¢„æœŸæ—¥å¿—å¯¹æ¯”

### æ—§æ–¹å¼ (submit.php) - å¤±è´¥

```
[PAYMENT-CREATE] Creating order via submit.php for user xxx
[PAYMENT-CREATE] Order created: GAIYA1764xxxxx  â† âŒ è¯¯å¯¼!å®é™…æœªåˆ›å»º

[PAYMENT-QUERY] Querying order: GAIYA1764xxxxx
[ZPAY-QUERY] Response: {"code":-1,"msg":"åœ¨åˆ¶å•å·æˆ–è®¢!"}
[PAYMENT-QUERY] Order not found, retry 2/3 in 2s...
[ZPAY-QUERY] Response: {"code":-1,"msg":"åœ¨åˆ¶å•å·æˆ–è®¢!"}
[PAYMENT-QUERY] Order not found, retry 3/3 in 2s...
[ZPAY-QUERY] Response: {"code":-1,"msg":"åœ¨åˆ¶å•å·æˆ–è®¢!"}
[PAYMENT-QUERY] Order not found after 3 attempts  â† âŒ æ°¸è¿œå¤±è´¥
```

### æ–°æ–¹å¼ (mapi.php) - æˆåŠŸ

```
[PAYMENT-CREATE] Creating order via mapi.php for user xxx
[ZPAY-API] Response status: 200
[ZPAY-API] Response text: {"code":1,"trade_no":"20251203xxxxx","payurl":"..."}
[ZPAY-API] Order created: GAIYA1764xxxxx
[PAYMENT-CREATE] âœ“ Order created via API: GAIYA1764xxxxx, trade_no: 20251203xxxxx

[ç­‰å¾…5ç§’...]

[PAYMENT-QUERY] Querying order: GAIYA1764xxxxx
[ZPAY-QUERY] Request URL: https://zpayz.cn/api.php
[ZPAY-QUERY] Response: {"code":1,"status":1,"trade_no":"20251203xxxxx",...}
[ZPAY-QUERY] Order found: GAIYA1764xxxxx, status: 1  â† âœ… æˆåŠŸ!
[PAYMENT-QUERY] Order found on attempt 1
[PAYMENT-QUERY] Order status: paid

[MANUAL-UPGRADE] Processing: user=xxx, plan=pro_monthly
[MANUAL-UPGRADE] âœ“ Success: user=xxx upgraded to pro
```

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜1: mapi.phpè¿”å›500é”™è¯¯

**ç—‡çŠ¶**:
```
[ZPAY-API] Response status: 500
[PAYMENT-CREATE] âœ— API order creation failed: å•†æˆ·æœªå¼€é€šAPIæ”¯ä»˜
```

**è§£å†³æ–¹æ¡ˆ**:
1. ç™»å½•Z-Payå•†æˆ·åå°
2. è”ç³»å®¢æœå¼€é€š"APIæ”¯ä»˜"åŠŸèƒ½
3. æˆ–åœ¨åå°è®¾ç½®ä¸­å¯ç”¨"mapi.phpæ¥å£"

### é—®é¢˜2: è®¢å•åˆ›å»ºæˆåŠŸä½†æŸ¥è¯¢å¤±è´¥

**ç—‡çŠ¶**:
```
[PAYMENT-CREATE] âœ“ Order created via API: trade_no: 20251203xxxxx
[PAYMENT-QUERY] Order not found after 3 attempts
```

**å¯èƒ½åŸå› **:
- Z-Payç³»ç»Ÿå»¶è¿Ÿè¶…è¿‡6ç§’(é‡è¯•3æ¬¡*2ç§’)
- PID/PKEYé…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
- å¢åŠ é‡è¯•æ¬¡æ•°åˆ°5æ¬¡
- éªŒè¯ç¯å¢ƒå˜é‡é…ç½®

### é—®é¢˜3: æ”¯ä»˜æˆåŠŸä½†æ²¡æœ‰å›è°ƒ

**ç—‡çŠ¶**:
- ç”¨æˆ·å®Œæˆæ”¯ä»˜
- Vercelæ—¥å¿—ä¸­æ— `[PAYMENT-NOTIFY]`è®°å½•

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥Z-Payåå°çš„notify_urlé…ç½®
2. ç¡®è®¤`https://jindutiao.vercel.app/api/payment-notify`å¯è®¿é—®
3. æŸ¥çœ‹Z-Payçš„å›è°ƒæ—¥å¿—

---

## ğŸ“ æŠ€æœ¯æ€»ç»“

### ä¸ºä»€ä¹ˆsubmit.phpæŸ¥ä¸åˆ°è®¢å•?

submit.phpæ˜¯**é¡µé¢è·³è½¬æ”¯ä»˜**æ–¹å¼:
1. åç«¯æ„å»ºæ”¯ä»˜URLå’Œå‚æ•°
2. å®¢æˆ·ç«¯æ‰“å¼€æµè§ˆå™¨è®¿é—®URL
3. **Z-Payå‰ç«¯JavaScriptè¯»å–URLå‚æ•°å¹¶åˆ›å»ºè®¢å•**
4. ç”¨æˆ·åœ¨Z-Payé¡µé¢å®Œæˆæ”¯ä»˜

é—®é¢˜:**æˆ‘ä»¬çš„åç«¯ä»æœªè°ƒç”¨Z-Pay APIåˆ›å»ºè®¢å•**,è®¢å•æ˜¯ç”±Z-Payå‰ç«¯åˆ›å»ºçš„,æˆ‘ä»¬åªæœ‰`out_trade_no`,ä½†Z-Payç³»ç»Ÿä¸­å¯èƒ½æ ¹æœ¬æ²¡æœ‰å¯¹åº”è®¢å•(å¦‚æœç”¨æˆ·æ²¡æ‰“å¼€é¡µé¢æˆ–é¡µé¢åŠ è½½å¤±è´¥)ã€‚

### ä¸ºä»€ä¹ˆmapi.phpå¯ä»¥æŸ¥åˆ°?

mapi.phpæ˜¯**APIæ”¯ä»˜**æ–¹å¼:
1. åç«¯ç›´æ¥è°ƒç”¨Z-Pay APIåˆ›å»ºè®¢å•
2. **è®¢å•ç«‹å³åœ¨Z-Payæ•°æ®åº“ä¸­åˆ›å»º**
3. è¿”å›`trade_no`(å¹³å°è®¢å•å·)
4. è¿”å›`payurl`(å®Œæ•´æ”¯ä»˜URL)
5. å®¢æˆ·ç«¯æ‰“å¼€payurlå®Œæˆæ”¯ä»˜

ä¼˜åŠ¿:**è®¢å•åœ¨è°ƒç”¨APIæ—¶å°±å·²å­˜åœ¨**,å¯ä»¥ç«‹å³é€šè¿‡`out_trade_no`æˆ–`trade_no`æŸ¥è¯¢ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Z-Payå¼€å‘æ–‡æ¡£](https://z-pay.cn/doc.html)
- [v1.6.8_æ”¯ä»˜æµç¨‹å®Œæ•´ä¿®å¤.md](v1.6.8_æ”¯ä»˜æµç¨‹å®Œæ•´ä¿®å¤.md) - ä¹‹å‰çš„ä¿®å¤å°è¯•
- [v1.6.8_è®¢å•æŸ¥è¯¢é‡è¯•ä¿®å¤.md](v1.6.8_è®¢å•æŸ¥è¯¢é‡è¯•ä¿®å¤.md) - é‡è¯•æœºåˆ¶è¯´æ˜

---

**åˆ›å»ºæ—¶é—´**: 2025-12-03 16:10
**Git Commit**: c052ba3
**Verceléƒ¨ç½²**: âœ… å·²å®Œæˆ
**åº”ç”¨æ‰“åŒ…**: âœ… å·²å®Œæˆ
**çŠ¶æ€**: â³ ç­‰å¾…æµ‹è¯• (éœ€ç¡®è®¤mapi.phpæƒé™)
