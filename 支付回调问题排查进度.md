# 支付回调问题排查进度

## 问题描述

用户完成支付后(¥0.1测试价格),会员状态没有自动更新,需要手动刷新且仍显示为free等级。

## 已完成的工作

### 1. 问题分析 ✅
- **根本原因**: Z-Pay支付回调未到达Vercel服务器
- **证据**: Vercel日志中没有任何 `[PAYMENT-NOTIFY]` 日志记录
- **影响**: 虽然用户完成支付,但后端数据库未更新用户会员状态

### 2. 尝试切换到API方式 (mapi.php) ❌
**目标**: API方式理论上回调更可靠

**实施**:
- 修改 `payment-create-order.py` 使用 `zpay.create_api_order()`
- 添加客户端IP获取逻辑
- 修改返回格式适配API方式

**结果**: 失败
- Z-Pay的 `mapi.php` 返回 HTTP 500 错误
- 返回HTML错误页面而非JSON
- 可能原因:
  - 商户账户未启用API方式
  - 商户配置问题
  - Z-Pay服务端故障

### 3. 回退到页面跳转方式 (submit.php) ✅
**原因**: submit.php方式仍然正常工作

**修改**:
- `payment-create-order.py`: 回退到使用 `zpay.create_order()`
- 保留页面跳转方式,回调机制相同

### 4. 增强支付回调日志 ✅
**目的**: 便于调试为什么回调未到达

**修改** (`payment-notify.py`):
```python
print(f"[PAYMENT-NOTIFY] ========== NEW NOTIFICATION ==========", file=sys.stderr)
print(f"[PAYMENT-NOTIFY] Order ID: {params.get('out_trade_no', 'N/A')}", file=sys.stderr)
print(f"[PAYMENT-NOTIFY] Trade NO: {params.get('trade_no', 'N/A')}", file=sys.stderr)
print(f"[PAYMENT-NOTIFY] Status: {params.get('trade_status', 'N/A')}", file=sys.stderr)
print(f"[PAYMENT-NOTIFY] Amount: ¥{params.get('money', 'N/A')}", file=sys.stderr)
print(f"[PAYMENT-NOTIFY] Pay Type: {params.get('type', 'N/A')}", file=sys.stderr)
print(f"[PAYMENT-NOTIFY] Param: {params.get('param', 'N/A')}", file=sys.stderr)
print(f"[PAYMENT-NOTIFY] Full URL: {self.path}", file=sys.stderr)
```

### 5. 添加zpay_manager调试日志 ✅
**修改** (`zpay_manager.py`):
- API方式添加响应状态和内容日志
- 添加JSON解析错误处理
- 记录完整错误信息

## 当前部署状态

- **代码版本**: commit `e384f1b`
- **部署平台**: Vercel (自动部署中)
- **回调URL**: `https://jindutiao.vercel.app/api/payment-notify`
- **测试价格**: ¥0.1 (所有套餐)

## Z-Pay回调重试策略

根据文档,Z-Pay的回调重试时间间隔为:
```
0, 15, 15, 30, 180, 1800, 1800, 1800, 1800, 3600 秒
(即: 立即, 15秒, 15秒, 30秒, 3分钟, 30分钟, 30分钟, 30分钟, 30分钟, 1小时)
```

**重要**: Z-Pay只有在收到纯字符串"success"响应时才会停止重试。

## 接下来需要做的测试

### 测试步骤:

1. **等待Vercel部署完成** (约1-2分钟)
   - 访问: https://vercel.com/jindutiao
   - 查看部署状态

2. **发起测试支付**
   ```bash
   # 运行测试脚本创建订单
   python test_api_payment.py
   ```
   - 会创建一个¥0.1的微信支付订单
   - 记录订单号

3. **完成支付**
   - 打开返回的支付链接
   - 使用微信完成¥0.1支付

4. **立即查看Vercel日志**
   - 访问: https://vercel.com/jindutiao → Functions → Logs
   - **关键**: 查找 `[PAYMENT-NOTIFY]` 日志
   - 如果看到日志,说明回调到达了
   - 如果15秒内没有日志,等待重试(15秒, 30秒, 3分钟...)

5. **检查会员状态**
   - 在应用中点击"🔄 刷新"按钮
   - 查看会员等级是否更新

## 可能的问题原因

如果回调仍然未到达,可能原因:

### A. Z-Pay商户后台配置问题
- [ ] 检查商户后台是否配置了回调URL
- [ ] 检查回调URL白名单
- [ ] 检查商户账户状态

### B. 网络/防火墙问题
- [ ] Vercel是否屏蔽了Z-Pay的IP
- [ ] Z-Pay是否能访问Vercel域名

### C. 签名验证失败
- [ ] 商户密钥是否正确
- [ ] 签名算法是否正确
- 当前会记录 `[PAYMENT-NOTIFY] Invalid signature!`

### D. 代码逻辑问题
- [ ] notify_url是否正确传递给Z-Pay
- [ ] payment-notify API是否正常工作
- 可以测试: `curl https://jindutiao.vercel.app/api/payment-notify`

## 临时解决方案

如果回调持续无法到达,可以考虑:

1. **手动查询订单状态**
   - 使用 `payment-query` API定期查询
   - 如果检测到支付成功,主动更新数据库

2. **手动升级账户**
   ```bash
   # 使用提供的手动升级脚本
   python manual_upgrade.py
   ```

3. **联系Z-Pay技术支持**
   - 提供订单号
   - 询问回调为什么未发送

## 相关文件

- `api/payment-create-order.py` - 创建订单
- `api/payment-notify.py` - 处理回调
- `api/zpay_manager.py` - Z-Pay接口管理
- `docs/pay.md` - Z-Pay API文档
- `test_api_payment.py` - 测试脚本

## Git提交记录

- `e384f1b` - 回退到submit.php并增强日志 (当前)
- `ca8a497` - 切换到mapi.php API方式 (已回退)
- `bd77b0b` - 添加JSON解析错误处理
- `c6faf91` - 统一价格管理
- `17b6317` - 修复价格配置
