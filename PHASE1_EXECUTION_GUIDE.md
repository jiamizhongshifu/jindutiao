# é˜¶æ®µ1æ‰§è¡ŒæŒ‡å—ï¼šæé«˜æ ¸å¿ƒæ¨¡å—è¦†ç›–ç‡

> **ç›®æ ‡**: åœ¨2-3å¤©å†…å°†æ ¸å¿ƒæ¨¡å—è¦†ç›–ç‡æå‡è‡³60-70%
> **å½“å‰çŠ¶æ€**: auth(44%), subscription(41%), quota(54%), zpay(0%)

---

## ğŸ“‹ æ‰§è¡Œæ£€æŸ¥æ¸…å•

### Day 1: auth_manager.py (44% â†’ 70%)

**ä¸Šåˆä»»åŠ¡** (4å°æ—¶):
- [ ] 1. è¿è¡Œè¦†ç›–ç‡æŠ¥å‘Šï¼Œå¯¼å‡ºæœªè¦†ç›–å‡½æ•°åˆ—è¡¨
- [ ] 2. ç¼–å†™ä¼šè¯ç®¡ç†æµ‹è¯•ï¼ˆ5ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [ ] 3. ç¼–å†™ç®¡ç†å‘˜åŠŸèƒ½æµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [ ] 4. è¿è¡Œæµ‹è¯•éªŒè¯ï¼ˆé¢„æœŸ11/11é€šè¿‡ï¼‰

**ä¸‹åˆä»»åŠ¡** (4å°æ—¶):
- [ ] 5. ç¼–å†™è¾¹ç•Œæ¡ä»¶æµ‹è¯•ï¼ˆ4ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [ ] 6. ç¼–å†™é”™è¯¯æ¢å¤æµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [ ] 7. ç¼–å†™å®‰å…¨åŠ å›ºæµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [ ] 8. æœ€ç»ˆéªŒè¯ï¼šè¦†ç›–ç‡â‰¥70%

**é¢„æœŸäº§å‡º**: +18ä¸ªæµ‹è¯•ï¼Œè¦†ç›–ç‡ä»44%æå‡åˆ°70%

---

### Day 2ä¸Šåˆ: subscription_manager.py (41% â†’ 65%)

**ä»»åŠ¡** (4å°æ—¶):
- [ ] 1. ç¼–å†™è®¢é˜…å‡çº§/é™çº§æµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ï¼‰
- [ ] 2. ç¼–å†™è®¢é˜…ç»­è´¹æµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ï¼‰
- [ ] 3. ç¼–å†™é€€æ¬¾å’Œå–æ¶ˆæµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ï¼‰
- [ ] 4. ç¼–å†™è®¢é˜…çŠ¶æ€è½¬æ¢æµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ï¼‰
- [ ] 5. ç¼–å†™æ‰¹é‡æ“ä½œæµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ï¼‰
- [ ] 6. éªŒè¯è¦†ç›–ç‡â‰¥65%

**é¢„æœŸäº§å‡º**: +15ä¸ªæµ‹è¯•

---

### Day 2ä¸‹åˆ: quota_manager.py (54% â†’ 70%)

**ä»»åŠ¡** (3å°æ—¶):
- [ ] 1. ç¼–å†™é…é¢æ¶ˆè€—æµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ï¼‰
- [ ] 2. ç¼–å†™é…é¢é‡ç½®é€»è¾‘æµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ï¼‰
- [ ] 3. ç¼–å†™é…é¢å†å²è®°å½•æµ‹è¯•ï¼ˆ2ä¸ªæµ‹è¯•ï¼‰
- [ ] 4. ç¼–å†™å¹¶å‘å®‰å…¨æµ‹è¯•ï¼ˆ2ä¸ªæµ‹è¯•ï¼‰
- [ ] 5. éªŒè¯è¦†ç›–ç‡â‰¥70%

**é¢„æœŸäº§å‡º**: +10ä¸ªæµ‹è¯•

---

### Day 3: zpay_manager.py (0% â†’ 60%)

**å…¨å¤©ä»»åŠ¡** (8å°æ—¶):
- [ ] 1. é˜…è¯»zpay_manager.pyæºä»£ç ï¼ˆ1å°æ—¶ï¼‰
- [ ] 2. åˆ›å»ºæµ‹è¯•æ–‡ä»¶å’ŒMockæ¡†æ¶ï¼ˆ1å°æ—¶ï¼‰
- [ ] 3. ç¼–å†™æ”¯ä»˜è®¢å•åˆ›å»ºæµ‹è¯•ï¼ˆ4ä¸ªæµ‹è¯•ï¼Œ1å°æ—¶ï¼‰
- [ ] 4. ç¼–å†™æ”¯ä»˜å›è°ƒå¤„ç†æµ‹è¯•ï¼ˆ4ä¸ªæµ‹è¯•ï¼Œ1.5å°æ—¶ï¼‰
- [ ] 5. ç¼–å†™æ”¯ä»˜æŸ¥è¯¢æµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ï¼Œ0.5å°æ—¶ï¼‰
- [ ] 6. ç¼–å†™é€€æ¬¾å¤„ç†æµ‹è¯•ï¼ˆ4ä¸ªæµ‹è¯•ï¼Œ1å°æ—¶ï¼‰
- [ ] 7. ç¼–å†™å®‰å…¨æµ‹è¯•ï¼ˆ5ä¸ªæµ‹è¯•ï¼Œ1.5å°æ—¶ï¼‰
- [ ] 8. ç¼–å†™æ”¯ä»˜å¯¹è´¦æµ‹è¯•ï¼ˆ5ä¸ªæµ‹è¯•ï¼Œ1å°æ—¶ï¼‰
- [ ] 9. æœ€ç»ˆéªŒè¯ï¼šè¦†ç›–ç‡â‰¥60%

**é¢„æœŸäº§å‡º**: æ–°å»ºtest_zpay_manager.pyï¼Œ25ä¸ªæµ‹è¯•

---

## ğŸ” æ­¥éª¤1: è¯†åˆ«æœªè¦†ç›–ä»£ç 

**è¿è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆè¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Š**:

```bash
# ç”ŸæˆHTMLè¦†ç›–ç‡æŠ¥å‘Š
python -m pytest tests/unit/test_auth_manager.py --cov=api/auth_manager.py --cov-report=html --cov-report=term-missing

# æŸ¥çœ‹æœªè¦†ç›–çš„è¡Œå·
# è¾“å‡ºç¤ºä¾‹ï¼š
# api/auth_manager.py:125-145    Missing
# api/auth_manager.py:200-210    Missing
```

**æ‰“å¼€HTMLæŠ¥å‘Š**:
```bash
start htmlcov/index.html  # Windows
# æŸ¥çœ‹çº¢è‰²æ ‡è®°çš„æœªè¦†ç›–ä»£ç 
```

---

## ğŸ“ æµ‹è¯•ç”¨ä¾‹ç¼–å†™æ¨¡æ¿

### æ¨¡æ¿1: ä¼šè¯ç®¡ç†æµ‹è¯•

```python
class TestSessionManagement:
    """æµ‹è¯•ä¼šè¯ç®¡ç†åŠŸèƒ½"""

    def test_refresh_session_success(self, auth_manager, mock_supabase_client):
        """æµ‹è¯•æˆåŠŸåˆ·æ–°ä¼šè¯"""
        # Arrange: å‡†å¤‡Mockæ•°æ®
        mock_response = Mock()
        mock_response.session = Mock()
        mock_response.session.access_token = "new_access_token"
        mock_response.session.refresh_token = "new_refresh_token"
        mock_supabase_client.auth.refresh_session.return_value = mock_response

        # Act: æ‰§è¡Œåˆ·æ–°
        result = auth_manager.refresh_session("old_refresh_token")

        # Assert: éªŒè¯ç»“æœ
        assert result["success"] is True
        assert result["access_token"] == "new_access_token"
        mock_supabase_client.auth.refresh_session.assert_called_once()

    def test_refresh_session_expired_token(self, auth_manager, mock_supabase_client):
        """æµ‹è¯•åˆ·æ–°è¿‡æœŸtoken"""
        # Arrange
        mock_supabase_client.auth.refresh_session.side_effect = Exception("Token expired")

        # Act
        result = auth_manager.refresh_session("expired_token")

        # Assert
        assert result["success"] is False
        assert "expired" in result["error"].lower()
```

---

### æ¨¡æ¿2: è®¢é˜…å‡çº§æµ‹è¯•

```python
class TestSubscriptionUpgrade:
    """æµ‹è¯•è®¢é˜…å‡çº§åŠŸèƒ½"""

    def test_upgrade_from_monthly_to_yearly(self, subscription_manager, mock_supabase_client):
        """æµ‹è¯•ä»æœˆåº¦å‡çº§åˆ°å¹´åº¦è®¢é˜…"""
        # Arrange: ç”¨æˆ·å½“å‰æœ‰æœˆåº¦è®¢é˜…ï¼ˆè¿˜å‰©15å¤©ï¼‰
        current_subscription = {
            "id": "sub-123",
            "plan_type": "pro_monthly",
            "expires_at": (datetime.now() + timedelta(days=15)).isoformat()
        }
        mock_supabase_client.table.return_value.select.return_value.eq.return_value.execute.return_value = Mock(
            data=[current_subscription]
        )

        # Mockå‡çº§åçš„è®¢é˜…
        upgraded_sub = Mock()
        upgraded_sub.data = [{"id": "sub-456", "plan_type": "pro_yearly"}]
        mock_supabase_client.table.return_value.insert.return_value.execute.return_value = upgraded_sub

        # Act: æ‰§è¡Œå‡çº§
        result = subscription_manager.upgrade_subscription(
            user_id="user-123",
            new_plan="pro_yearly",
            payment_id="pay-upgrade"
        )

        # Assert: éªŒè¯å‡çº§æˆåŠŸ
        assert result["success"] is True
        assert result["plan_type"] == "pro_yearly"

        # éªŒè¯æ—§è®¢é˜…è¢«å–æ¶ˆ
        cancel_call = mock_supabase_client.table.return_value.update.call_args
        assert cancel_call[0][0]["status"] == "cancelled"

        # éªŒè¯å‰©ä½™å¤©æ•°æŠ˜ç®—ï¼ˆå¯é€‰ï¼šé«˜çº§æµ‹è¯•ï¼‰
        # 15å¤©æœˆåº¦ â‰ˆ 0.04å¹´ï¼Œå‡çº§ååº”å»¶é•¿è¿‡æœŸæ—¶é—´
```

---

### æ¨¡æ¿3: å¹¶å‘å®‰å…¨æµ‹è¯•

```python
class TestConcurrencySafety:
    """æµ‹è¯•å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§"""

    def test_concurrent_quota_consumption(self, quota_manager, mock_supabase_client):
        """æµ‹è¯•å¹¶å‘æ¶ˆè€—é…é¢æ—¶çš„åŸå­æ€§"""
        import threading

        # Arrange: ç”¨æˆ·æœ‰3æ¬¡é…é¢
        user_quota = {
            "user_id": "user-123",
            "daily_plan_used": 0,
            "daily_plan_total": 3
        }
        mock_supabase_client.table.return_value.select.return_value.eq.return_value.execute.return_value = Mock(
            data=[user_quota]
        )

        # æ¨¡æ‹Ÿæ•°æ®åº“åŸå­æ›´æ–°
        consumed_count = [0]  # æ¨¡æ‹Ÿæ•°æ®åº“è®¡æ•°å™¨
        lock = threading.Lock()

        def mock_consume():
            with lock:
                if consumed_count[0] < 3:
                    consumed_count[0] += 1
                    return Mock(data=[{"daily_plan_used": consumed_count[0]}])
                else:
                    raise Exception("Quota exceeded")

        mock_supabase_client.table.return_value.update.return_value.eq.return_value.execute.side_effect = mock_consume

        # Act: 10ä¸ªçº¿ç¨‹åŒæ—¶å°è¯•æ¶ˆè€—é…é¢
        threads = []
        results = []

        def consume():
            try:
                result = quota_manager.consume_quota("user-123", "daily_plan")
                results.append(result)
            except Exception as e:
                results.append({"error": str(e)})

        for _ in range(10):
            t = threading.Thread(target=consume)
            threads.append(t)
            t.start()

        for t in threads:
            t.join()

        # Assert: åªæœ‰3æ¬¡æˆåŠŸï¼Œ7æ¬¡å¤±è´¥
        successful = [r for r in results if r.get("success")]
        failed = [r for r in results if "error" in r or not r.get("success")]

        assert len(successful) == 3  # ä»…3æ¬¡æˆåŠŸ
        assert len(failed) == 7       # 7æ¬¡å¤±è´¥ï¼ˆé…é¢ä¸è¶³ï¼‰
```

---

### æ¨¡æ¿4: æ”¯ä»˜å®‰å…¨æµ‹è¯•

```python
class TestPaymentSecurity:
    """æµ‹è¯•æ”¯ä»˜ç›¸å…³çš„å®‰å…¨æ€§"""

    def test_payment_signature_tampering_detection(self, zpay_manager):
        """æµ‹è¯•æ”¯ä»˜ç­¾åç¯¡æ”¹æ£€æµ‹"""
        # Arrange: åˆæ³•çš„æ”¯ä»˜å›è°ƒæ•°æ®
        callback_data = {
            "out_trade_no": "ORDER123",
            "total_amount": "29.00",
            "trade_status": "TRADE_SUCCESS",
            "sign": "valid_signature_here"
        }

        # Act: ç¯¡æ”¹é‡‘é¢åéªŒè¯ç­¾å
        tampered_data = callback_data.copy()
        tampered_data["total_amount"] = "1.00"  # ç¯¡æ”¹é‡‘é¢

        result = zpay_manager.verify_payment_callback(tampered_data)

        # Assert: ç­¾åéªŒè¯åº”å¤±è´¥
        assert result["success"] is False
        assert "ç­¾åéªŒè¯å¤±è´¥" in result["error"]

    def test_payment_replay_attack_prevention(self, zpay_manager, mock_supabase_client):
        """æµ‹è¯•æ”¯ä»˜é‡æ”¾æ”»å‡»é˜²å¾¡"""
        # Arrange: å·²å¤„ç†è¿‡çš„æ”¯ä»˜å›è°ƒ
        callback_data = {
            "out_trade_no": "ORDER123",
            "total_amount": "29.00",
            "trade_status": "TRADE_SUCCESS"
        }

        # Mockæ•°æ®åº“æŸ¥è¯¢ï¼šè®¢å•å·²å¤„ç†
        mock_supabase_client.table.return_value.select.return_value.eq.return_value.execute.return_value = Mock(
            data=[{"status": "paid", "processed": True}]
        )

        # Act: é‡å¤å‘é€ç›¸åŒå›è°ƒ
        result = zpay_manager.handle_payment_callback(callback_data)

        # Assert: åº”æ‹’ç»é‡å¤å¤„ç†
        assert result["success"] is False
        assert "é‡å¤" in result["error"] or "å·²å¤„ç†" in result["error"]

        # éªŒè¯æ•°æ®åº“æœªè¢«äºŒæ¬¡æ›´æ–°
        update_calls = mock_supabase_client.table.return_value.update.call_count
        assert update_calls == 0
```

---

## ğŸ”§ è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹Mockè°ƒç”¨å†å²

```python
# æŸ¥çœ‹æŸä¸ªMockæ–¹æ³•è¢«è°ƒç”¨äº†å¤šå°‘æ¬¡
print(mock_supabase_client.table.call_count)

# æŸ¥çœ‹è°ƒç”¨å‚æ•°
print(mock_supabase_client.table.call_args_list)

# é‡ç½®MockçŠ¶æ€
mock_supabase_client.reset_mock()
```

### 2. ä½¿ç”¨pytestæ–­ç‚¹è°ƒè¯•

```python
def test_complex_scenario():
    # ...
    import pdb; pdb.set_trace()  # è®¾ç½®æ–­ç‚¹
    result = some_function()
```

### 3. è¾“å‡ºè¦†ç›–ç‡åˆ°æ–‡ä»¶

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šåˆ°coverage.txt
python -m pytest tests/unit/ --cov=api --cov-report=term-missing > coverage.txt
```

---

## âœ… æ¯æ—¥éªŒæ”¶æ ‡å‡†

### Day 1ç»“æŸå‰:
```bash
# è¿è¡Œauth_manageræµ‹è¯•
python -m pytest tests/unit/test_auth_manager.py -v

# æ£€æŸ¥è¦†ç›–ç‡ï¼ˆåº”â‰¥70%ï¼‰
python -m pytest tests/unit/test_auth_manager.py --cov=api/auth_manager.py --cov-report=term

# é¢„æœŸè¾“å‡ºï¼š
# api/auth_manager.py    320    96    70%
```

### Day 2ç»“æŸå‰:
```bash
# è¿è¡Œsubscriptionå’Œquotaæµ‹è¯•
python -m pytest tests/unit/test_subscription_manager.py tests/unit/test_quota_manager.py -v

# æ£€æŸ¥è¦†ç›–ç‡
python -m pytest tests/unit/ --cov=api/subscription_manager.py --cov=api/quota_manager.py --cov-report=term

# é¢„æœŸï¼š
# subscription_manager.py    147    51    65%
# quota_manager.py          108    32    70%
```

### Day 3ç»“æŸå‰:
```bash
# è¿è¡Œzpay_manageræµ‹è¯•
python -m pytest tests/unit/test_zpay_manager.py -v

# æ£€æŸ¥è¦†ç›–ç‡ï¼ˆåº”â‰¥60%ï¼‰
python -m pytest tests/unit/test_zpay_manager.py --cov=api/zpay_manager.py --cov-report=term

# é¢„æœŸï¼š
# zpay_manager.py    117    47    60%
```

### æœ€ç»ˆéªŒæ”¶ï¼ˆDay 3ç»“æŸï¼‰:
```bash
# è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
python -m pytest tests/unit/ -v

# é¢„æœŸï¼š130+ passedï¼ˆ99åŸæœ‰ + 43æ–°å¢ï¼‰

# æ•´ä½“è¦†ç›–ç‡
python -m pytest tests/unit/ --cov=api --cov-report=term

# é¢„æœŸï¼š
# TOTAL    2200    1400    36%  ï¼ˆä»16%æå‡åˆ°36%ï¼‰
```

---

## ğŸš€ ç«‹å³å¼€å§‹

**ç¬¬ä¸€æ­¥ï¼šè¿è¡ŒåŸºå‡†æµ‹è¯•**
```bash
cd C:\Users\Sats\Downloads\jindutiao
python -m pytest tests/unit/ --cov=api --cov-report=html --cov-report=term-missing
```

**ç¬¬äºŒæ­¥ï¼šæ‰“å¼€è¦†ç›–ç‡æŠ¥å‘Š**
```bash
start htmlcov/index.html
# é‡ç‚¹æŸ¥çœ‹auth_manager.pyçš„çº¢è‰²ï¼ˆæœªè¦†ç›–ï¼‰ä»£ç 
```

**ç¬¬ä¸‰æ­¥ï¼šå¼€å§‹ç¼–å†™ç¬¬ä¸€ä¸ªæµ‹è¯•**
```bash
# æ‰“å¼€æµ‹è¯•æ–‡ä»¶
code tests/unit/test_auth_manager.py

# æ·»åŠ TestSessionManagementç±»ï¼ˆå‚è€ƒä¸Šé¢çš„æ¨¡æ¿ï¼‰
```

**GO! GO! GO!** ğŸ¯
