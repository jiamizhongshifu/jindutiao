# 红温专注仓 × 行为识别 × 时间回放 - 功能实现对比清单

根据 [开发文档](红温专注仓 × 行为识别 × 时间回放.md) 的要求,对比当前实现情况。

---

## 📊 总体进度概览

| 模块 | 完成度 | 状态 |
|------|--------|------|
| **功能一: 红温专注仓** | 100% | 🟢 沉浸式专注模式完成 |
| **功能二: 行为识别** | 10% | 🔴 未实现 |
| **功能三: 时间回放** | 0% | 🔴 未实现 |

---

## 🎉 最新更新 (2025-11-30)

### ✅ 沉浸式专注模式 - **已完成** (12:52)

**重大升级**: 完成了红温专注仓的沉浸式交互重构,整个进度条现在可以变身为专注计时器!

#### 核心特性

1. **沉浸式计时体验**:
   - 启动专注后,整个进度条转变为25分钟专注倒计时器
   - 红色进度条从左向右填充,显示已专注时间
   - 🔥 火焰图标随进度移动,实时指示当前进度
   - 专注结束后自动进入5分钟绿色休息倒计时
   - 休息结束后自动恢复正常模式

2. **交互控制**:
   - **右键菜单** (动态菜单项):
     - 正常模式: "🔥 开启红温专注仓 (25分钟)"
     - 专注中: "⏱️ 调整专注时长" + "❌ 结束专注"
     - 休息中: "⏭️ 跳过休息"
   - **鼠标悬停**: 显示实时进度 "🔥 专注中: MM:SS / TT:MM"
   - **确认对话框**: 结束专注时需要确认,防止误操作

3. **视觉设计**:
   - 专注模式: 红色进度条 `rgba(255, 80, 50, 200)` + 🔥 图标
   - 休息模式: 绿色进度条 `rgba(76, 175, 80, 200)` + ☕ 图标
   - 保留原有深色背景,进度条在其上填充

4. **状态管理**:
   - 自动隐藏原番茄钟面板,避免界面冗余
   - 数据库完整记录专注会话 (start/end/duration/status)
   - 系统托盘通知提醒专注完成和休息完成

#### 实现位置

- 状态变量: `main.py` 第 115-121 行
- 渲染逻辑: `main.py` 第 784-823 行 `_render_focus_mode()`
- 生命周期: `main.py` 第 825-951 行 (start/finish/end/skip/adjust)
- 右键菜单: `main.py` 第 2015-2046 行
- 悬停提示: `main.py` 第 1958-1974 行

---

### ✅ 进度条专注状态集成 - **已完成** (12:22)

实现了进度条上的专注状态可视化,用户现在可以直观地看到哪些时间块正在专注或已完成专注。

**重要修复**: 修复了任务名称字段匹配错误 (`task.get('name')` → `task.get('task')`),现在进度条能正确显示专注状态。

#### 实现内容

1. **数据库扩展**:
   - 新增 `get_active_focus_sessions()` - 查询所有活跃专注会话
   - 新增 `get_completed_focus_sessions_for_blocks()` - 查询今日已完成专注的时间块

2. **进度条实时状态更新**:
   - 每秒自动查询数据库更新专注状态
   - `TimeProgressBar` 新增 `active_focus_sessions` 和 `completed_focus_blocks` 状态管理
   - 专注状态变化立即反映在进度条上

3. **视觉效果**:
   - **活跃专注** (FOCUS_ACTIVE):
     - 红色半透明覆盖层 `rgba(255, 80, 50, 60)`
     - 左侧显示🔥图标 (14号字体)
   - **已完成专注** (FOCUS_DONE):
     - 右上角小🔥图标 (10号字体)
     - 浅橙色 `rgba(255, 200, 150, 200)`

---

## 功能一: 红温专注仓 🔥

### ✅ 已实现功能

#### 1.1 核心功能
- ✅ **时间块绑定**: 番茄钟与时间块正确绑定 (`time_block_id`)
- ✅ **右键菜单入口**: 时间块右键菜单 → "🔥 开启红温专注仓"
- ✅ **专注会话记录**: 创建/完成/中断 FocusSession
- ✅ **数据库持久化**: SQLite (`focus_sessions` 表)

#### 1.2 UI差异化
- ✅ **火焰图标**: 🔥 (vs 🍅)
- ✅ **红色背景**: 深红色 `(80,30,30,240)`
- ✅ **呼吸动画**: 红色通道动态变化 (2秒周期)
- ✅ **任务名称显示**: 底部显示时间块名称
- ✅ **窗口高度**: 70px (vs 普通50px)

#### 1.3 生命周期管理
- ✅ **开始工作**: `start_work()` → 创建会话 + 启动动画
- ✅ **自然完成**: `on_countdown_finished()` → 完成会话 + 停止动画
- ✅ **手动中断**: `stop()` → 中断会话
- ✅ **增强通知**: 显示专注任务名称

#### 1.4 数据结构
- ✅ **FocusSession**: id, time_block_id, start_time, end_time, duration_minutes, status
- ✅ **状态枚举**: RUNNING, COMPLETED, INTERRUPTED
- ✅ **数据库管理器**: `gaiya/data/db_manager.py`

---

### ❌ 未实现功能 (文档要求但暂未实现)

#### 1.1 进度条集成 ✅ **已完成** (2025-11-30)

文档要求 (第1.3节):
> 底部进度条对应时间块 `A`：
> - 颜色加深 / 色相变化
> - 增加轻微「呼吸」动画
> - 显示 🔥 标记（例如块左侧或顶部）

**当前状态**: ✅ **已实现**

- ✅ 进度条上的时间块显示专注状态 (红色覆盖层)
- ✅ 🔥 标记 (活跃专注左侧大图标, 已完成专注右上角小图标)
- ⚠️ 颜色变化已实现, 呼吸动画待优化

**实现位置**:

- 数据库: `gaiya/data/db_manager.py` (新增查询方法)
- 进度条: `main.py` 的 `TimeProgressBar.paintEvent()` (2401-2424行)

---

#### 1.2 时间块状态同步 ✅ **已完成**

文档要求 (第1.4节):
> **时间块 `TimeBlock` 状态：**
> - `NORMAL`：默认状态
> - `FOCUS_ACTIVE`：该时间块内存在正在运行的 `FocusSession`
> - `FOCUS_DONE`：该时间块至少有一条 `COMPLETED` 的 `FocusSession`

**当前状态**: ✅ **已实现** (动态查询方式)

- ✅ 每秒自动查询数据库获取专注状态
- ✅ 可区分 NORMAL / FOCUS_ACTIVE / FOCUS_DONE 状态
- ✅ 专注状态实时同步到进度条显示

**说明**:

- 未在时间块数据结构中添加 `focus_state` 字段 (避免数据冗余)
- 改用数据库动态查询 + 内存缓存的方式 (更灵活,数据始终最新)

---

#### 1.3 沉浸式专注模式 ✅ **已完成** (2025-11-30 12:52)

文档要求 (第1.3节):
> 在底部进度条右侧设计一个小区域，显示当前专注状态：
> - 🔥 图标 + 剩余时间 + 当前时间块标题
> - `🔥 24:32 - 写自己的项目`

**当前状态**: ✅ **已超越原需求实现沉浸式专注模式**

**实现方案** (比原需求更优):

- ✅ 整个进度条转变为专注计时器,无需独立显示区域
- ✅ 红色进度条填充 + 🔥 图标随进度移动,视觉冲击力强
- ✅ 鼠标悬停显示实时进度 "🔥 专注中: MM:SS / TT:MM"
- ✅ 专注结束自动进入5分钟绿色休息倒计时
- ✅ 右键菜单动态控制 (调整时长/结束专注/跳过休息)
- ✅ 系统托盘通知提醒完成事件

**优势**:

- 比独立显示区域更沉浸,占据全部注意力
- 不需要额外的UI空间
- 进度可视化更直观 (填充式而非文字)

---

#### 1.4 时间块详情面板入口
文档要求 (第1.2节):
> 在时间块详情弹窗 / 侧边栏中增加按钮：`专注这段时间`

**当前状态**: ❌ **未实现**
- 只有右键菜单入口
- 时间块详情面板中没有专注按钮

**优先级**: 低 (右键菜单已足够)

---

### 🔄 可优化项 (文档建议)

#### 1.5 悬停快捷入口
文档建议:
> 悬停在进度条底部某段时间块时，在其上方显示 🔥 按钮，点击即开启

**优先级**: 低 (锦上添花)

---

## 功能二: 行为识别与时间使用统计 📊

### ❌ 完全未实现 (0%)

**文档要求**:
1. 后台轮询前台窗口 (每5秒)
2. 识别进程名称和窗口标题
3. App分类系统 (生产力/摸鱼/中性/未分类)
4. 活动会话聚合 (ActivitySession)
5. 用户自定义分类规则
6. 今日统计面板

**当前状态**: ❌ **完全未实现**

**影响**:
- 无法回答"我今天真正认真干活了多久?"
- 无法统计摸鱼时长
- 无法为时间回放提供行为数据

**优先级**: **高** (是时间回放的前置依赖)

---

### 需要实现的模块

#### 2.1 行为采集服务 (核心)
```python
# gaiya/services/activity_tracker.py
class ActivityTracker(QThread):
    """后台轮询前台窗口"""

    def run(self):
        while self.is_running:
            # 1. GetForegroundWindow()
            # 2. GetWindowThreadProcessId()
            # 3. GetModuleFileNameEx()
            # 4. 聚合为 ActivitySession
            time.sleep(5)
```

**依赖**: `win32gui`, `win32process`, `psutil`

---

#### 2.2 数据库扩展
已有表结构 (在 `db_manager.py` 中):
```sql
CREATE TABLE activity_sessions (
    id TEXT PRIMARY KEY,
    process_name TEXT,
    window_title TEXT,
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    duration_seconds INTEGER,
    category TEXT
);

CREATE TABLE app_categories (
    process_name TEXT PRIMARY KEY,
    category TEXT,
    is_ignored BOOLEAN
);
```

**状态**: ✅ 数据库表已创建
**缺失**: 采集服务未实现

---

#### 2.3 分类管理UI
```python
# gaiya/ui/activity_settings_window.py (需要新建)
class ActivitySettingsWindow(QDialog):
    """行为识别设置窗口"""

    def show_app_list(self):
        """显示最近7天使用的App列表"""
        # App图标 + 名称 + 时长 + 分类下拉框
```

**状态**: ❌ 未实现

---

#### 2.4 统计接口
已有方法 (在 `db_manager.py` 中):
```python
def get_today_activity_stats(self):
    """获取今日活动统计"""
    # 返回: total_seconds, categories, top_apps
```

**状态**: ✅ 方法已实现
**缺失**: 调用方和UI显示

---

## 功能三: 时间回放 ⏮️

### ❌ 完全未实现 (0%)

**文档要求**:
1. 时间回放窗口 (TimeReviewWindow)
2. 上半部分: 计划 vs 专注统计
3. 下半部分: 行为统计 (饼图/条形图)
4. 数据聚合算法
5. 快捷键支持 (Ctrl+T)

**当前状态**: ❌ **完全未实现**

**前置依赖**: 功能二 (行为识别) 必须先完成

---

### 需要实现的模块

#### 3.1 时间回放窗口
```python
# gaiya/ui/time_review_window.py (已有原型文件)
class TimeReviewWindow(QDialog):
    """时间回放主窗口"""

    def load_today_data(self):
        """加载今日数据"""
        # 1. 时间块计划
        # 2. 专注会话记录
        # 3. 行为识别数据
```

**状态**: ⚠️ 文件存在但未集成

---

#### 3.2 数据聚合
文档要求:
```python
review_data = {
    "total_plan_minutes": 480,
    "total_focus_minutes": 180,
    "focus_execution_rate": 37.5,
    "time_blocks": [...]
}

activity_data = {
    "total_active_seconds": 14400,
    "categories": {...},
    "top_apps": [...]
}
```

**状态**: ❌ 未实现聚合逻辑

---

#### 3.3 可视化组件
文档要求:
- 简单的饼图/条形图 (QPainter 手动绘制)
- 时间块列表
- Top App 排行榜

**状态**: ❌ 未实现

---

## 🎯 优先级建议

根据文档目标 ("MVP 可用 & 可演示") 和功能依赖关系:

### 阶段1: 完善红温专注仓 ✅ **已完成** (2025-11-30)

**优先级: 高**

1. ✅ **进度条集成** - 最重要的视觉反馈
   - ✅ 在进度条上显示 🔥 标记
   - ✅ 时间块颜色变化 (红色覆盖层)
   - ⚠️ 呼吸动画同步 (待优化,当前已有静态效果)

2. ✅ **时间块状态同步**
   - ✅ 动态查询专注状态 (避免数据冗余)
   - ✅ NORMAL / FOCUS_ACTIVE / FOCUS_DONE 状态管理
   - ✅ 历史专注记录显示 (右上角小🔥)

3. ⚠️ **进度条专注信息** (可选,优先级降低)
   - 暂不实现独立显示区域
   - 用户可通过火焰图标识别专注状态
   - 番茄钟面板已显示详细信息

---

### 阶段2: 行为识别 (中期)
**优先级: 高** (时间回放的前置依赖)

1. ✅ **后台采集服务** - 核心功能
   - ActivityTracker 线程
   - Windows API 集成
   - Session 聚合逻辑

2. ✅ **分类管理UI**
   - 设置窗口
   - App列表显示
   - 分类规则编辑

3. ⚠️ **今日统计面板** (可选)
   - 显示生产力时长
   - Top App 榜单

---

### 阶段3: 时间回放 (长期)
**优先级: 中**

1. 时间回放窗口
2. 数据聚合算法
3. 可视化组件

---

## 📝 文件清单

### ✅ 已实现文件
- `gaiya/ui/pomodoro_panel.py` - 番茄钟面板 (红温专注仓)
- `gaiya/core/pomodoro_state.py` - 番茄钟状态
- `gaiya/data/db_manager.py` - 数据库管理器

### ⚠️ 存在但未集成
- `gaiya/ui/time_review_window.py` - 时间回放窗口 (需要完善)
- `test_activity_tracking.py` - 活动追踪测试 (需要集成)

### ❌ 需要新建
- `gaiya/services/activity_tracker.py` - 行为采集服务
- `gaiya/ui/activity_settings_window.py` - 分类管理UI

---

## 🚀 下一步行动

### 立即可做 (今天)
1. **进度条集成** - 在 `main.py` 的 `TimeProgressBar` 中添加专注状态显示
2. **时间块状态同步** - 扩展时间块数据结构

### 本周可做
3. **行为采集服务** - 实现 ActivityTracker 后台线程
4. **分类管理UI** - 创建设置窗口

### 下周可做
5. **时间回放窗口** - 集成并完善现有原型
6. **数据聚合** - 实现统计算法

---

*生成时间: 2025-11-30*
*基于文档版本: v1.0*
